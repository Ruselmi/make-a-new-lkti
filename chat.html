 <!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI LKTI For You</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js for rendering Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder"></script>
    <!-- html-docx-js for client-side HTML to DOCX conversion -->
    <script src="https://unpkg.com/html-docx-js@0.3.1/dist/html-docx-js.min.js"></script>
    <!-- docx for direct Word creation -->
    <script type="module">

    </script>
    <!-- FileSaver.js for saving the docx file -->
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icon Library -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Light Theme Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; } /* slate-200 */
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; } /* slate-400 */
        /* Dark Theme Scrollbar */
        .dark ::-webkit-scrollbar-track { background: #1e293b; } /* slate-800 */
        .dark ::-webkit-scrollbar-thumb { background: #475569; } /* slate-600 */
        
        .prose-output h1, .prose-output h2, .prose-output h3 { font-weight: 700; }
        .prose-output h1 { font-size: 1.5rem; margin-top: 0; margin-bottom: 1rem; padding-bottom: 0.5rem; }
        .prose-output h2 { font-size: 1.25rem; margin-top: 1.5rem; margin-bottom: 1rem; }
        .prose-output p { margin-bottom: 1rem; line-height: 1.75; }
        .prose-output ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 1rem; }
        .prose-output ol { list-style-type: decimal; margin-left: 1.5rem; margin-bottom: 1rem; }
        .prose-output strong { font-weight: bold; font-size: 1.1em; }
        .prose-output em { font-style: italic; font-size: 1.05em; }
        
        #paraphrase-panel { transition: transform 0.3s ease-in-out, opacity 0.3s; }
        .toggle-btn[data-active="true"] { background-color: #4f46e5; color: white; }

        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Mobile improvements for better visibility and attractiveness */
        @media (max-width: 768px) {
            #paraphrase-panel {
                padding: 1rem;
            }
            #paraphrase-panel .flex.items-center.gap-2.mt-3 {
                flex-direction: column;
                gap: 0.75rem;
            }
            #paraphrase-panel button {
                min-height: 44px;
                font-size: 1rem;
                padding: 0.75rem 1rem;
            }
            #paraphrase-panel .paraphrase-mode-btn {
                padding: 0.75rem 1rem;
            }
            #paraphrase-panel .text-sm {
                font-size: 1rem;
            }
            #paraphrase-panel .text-xs {
                font-size: 0.875rem;
            }
            #paraphrase-panel .w-4.h-4 {
                width: 1.25rem;
                height: 1.25rem;
            }
            #paraphrase-panel .w-5.h-5 {
                width: 1.5rem;
                height: 1.5rem;
            }
            #paraphrase-panel .border-l {
                border-left: none;
                border-top: 1px solid;
                height: 1px;
                width: 100%;
                margin: 0.5rem 0;
            }
            #paraphrase-panel .flex.items-center.gap-2.mt-3 > div:first-child {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                width: 100%;
            }
            #paraphrase-panel .flex.items-center.gap-2.mt-3 > div:last-child {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                width: 100%;
            }
            /* General mobile improvements */
            .text-lg { font-size: 1.125rem; }
            .text-xl { font-size: 1.25rem; }
            .p-4 { padding: 1rem; }
            .p-6 { padding: 1.5rem; }
            .p-8 { padding: 2rem; }
            .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
            .px-4 { padding-left: 1rem; padding-right: 1rem; }
            .gap-2 { gap: 0.5rem; }
            .gap-3 { gap: 0.75rem; }
            .h-4 { height: 1rem; }
            .w-4 { width: 1rem; }
            .h-5 { height: 1.25rem; }
            .w-5 { width: 1.25rem; }
            .min-h-11 { min-height: 44px; }
            #output-panel { padding: 1rem; }
            #word-studio { padding: 0.75rem; }
            #word-editor { min-height: 220px; font-size: 0.95rem; }
            #support-api-source { height: 9rem; }
            #support-result { max-height: 10rem; }
            #export-buttons { flex-wrap: wrap; justify-content: flex-end; }
        }

        /* Theme definitions */
        [data-theme="day"] {
            --bg-primary: #ffffff;
            --text-primary: #212529;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --accent: #007bff;
            --border: #dee2e6;
        }
        [data-theme="day"] body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        [data-theme="day"] .bg-slate-50 {
            background-color: var(--bg-secondary);
        }
        [data-theme="day"] .bg-slate-100 {
            background-color: var(--bg-tertiary);
        }
        [data-theme="day"] .text-slate-700 {
            color: var(--text-primary);
        }
        [data-theme="day"] .border-slate-200 {
            border-color: var(--border);
        }
        [data-theme="day"] .bg-teal-500 {
            background-color: var(--accent);
        }

        [data-theme="night"] {
            --bg-primary: #0f172a;
            --text-primary: #e2e8f0;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --accent: #06b6d4;
            --border: #475569;
        }
        [data-theme="night"] body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        [data-theme="night"] .bg-slate-50 {
            background-color: var(--bg-secondary);
        }
        [data-theme="night"] .bg-slate-100 {
            background-color: var(--bg-tertiary);
        }
        [data-theme="night"] .text-slate-700 {
            color: var(--text-primary);
        }
        [data-theme="night"] .border-slate-200 {
            border-color: var(--border);
        }
        [data-theme="night"] .bg-teal-500 {
            background-color: var(--accent);
        }

        [data-theme="planet"] {
            --bg-primary: #000011;
            --text-primary: #e0e7ff;
            --bg-secondary: #1e1b4b;
            --bg-tertiary: #312e81;
            --accent: #3b82f6;
            --border: #6366f1;
        }
        [data-theme="planet"] body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        [data-theme="planet"] .bg-slate-50 {
            background-color: var(--bg-secondary);
        }
        [data-theme="planet"] .bg-slate-100 {
            background-color: var(--bg-tertiary);
        }
        [data-theme="planet"] .text-slate-700 {
            color: var(--text-primary);
        }
        [data-theme="planet"] .border-slate-200 {
            border-color: var(--border);
        }
        [data-theme="planet"] .bg-teal-500 {
            background-color: var(--accent);
        }

        [data-theme="ai"] {
            --bg-primary: #0a0a0a;
            --text-primary: #00ff88;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --accent: #00d4aa;
            --border: #00ff88;
        }
        [data-theme="ai"] body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        [data-theme="ai"] .bg-slate-50 {
            background-color: var(--bg-secondary);
        }
        [data-theme="ai"] .bg-slate-100 {
            background-color: var(--bg-tertiary);
        }
        [data-theme="ai"] .text-slate-700 {
            color: var(--text-primary);
        }
        [data-theme="ai"] .border-slate-200 {
            border-color: var(--border);
        }
        [data-theme="ai"] .bg-teal-500 {
            background-color: var(--accent);
        }

    </style>
</head>
<body class="bg-white dark:bg-slate-900 text-slate-700 dark:text-slate-300 transition-colors duration-300">

    <div id="app" class="flex flex-col lg:flex-row min-h-screen">
        <!-- Input Panel -->
        <div class="lg:w-2/5 xl:w-1/3 w-full bg-slate-50 dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 p-6 lg:p-8 flex flex-col h-screen">
            <header class="mb-6 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-teal-500 rounded-lg flex items-center justify-center">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-git-branch-plus"><path d="M6 3v12"/><path d="M18 9a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/><path d="M6 21a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/><path d="M15 6a9 9 0 0 0-9 9"/><path d="M18 15v6"/><path d="M21 18h-6"/></svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-slate-800 dark:text-slate-100" data-translate-key="appTitle">AutoBab Universal Pro</h1>
                        <p class="text-sm text-slate-500 dark:text-slate-400" data-translate-key="appSubtitle">Intelligent Document Generator</p>
                    </div>
                </div>
                <button id="open-settings-btn" class="p-2 rounded hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 flex items-center gap-1">
                    <i data-lucide="settings" class="w-5 h-5"></i> <span>Pengaturan</span>
                </button>
            </header>

            <form id="generation-form" class="flex-grow overflow-y-auto pr-2 space-y-6">
                 <fieldset>
                    <div class="space-y-4">
                        <div>
                            <label for="generation-mode" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1" data-translate-key="labelMode">1. Mode Pembuatan</label>
                             <select id="generation-mode" class="w-full p-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm text-slate-800 dark:text-slate-200">
                                <option value="otomatis" selected data-translate-key="modeOtomatis">Otomatis (Sekali Jadi)</option>
                                <option value="manual" data-translate-key="modeManual">Manual (Per Bagian)</option>
                            </select>
                        </div>
                        <div>
                            <label for="jenis-dokumen" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1" data-translate-key="labelDocType">2. Jenis Dokumen</label>
                             <select id="jenis-dokumen" class="w-full p-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm text-slate-800 dark:text-slate-200">
                                <option value="Skripsi" selected>Skripsi</option>
                                <option value="Makalah">Makalah</option>
                                <option value="Jurnal Ilmiah">Jurnal Ilmiah</option>
                                <option value="Artikel Ilmiah">Artikel Ilmiah</option>
                                <option value="Tesis">Tesis</option>
                                <option value="Disertasi">Disertasi</option>
                                <option value="Custom">Custom</option>
                            </select>
                        </div>
                        <div id="custom-doc-type" class="hidden">
                            <label for="custom-doc-name" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Nama Dokumen Custom</label>
                            <input id="custom-doc-name" type="text" placeholder="Masukkan nama jenis dokumen custom..." class="w-full p-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm text-slate-800 dark:text-slate-200">
                        </div>
                        <div>
                            <label for="topik" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1" data-translate-key="labelTopic">3. Topik Utama</label>
                            <textarea id="topik" rows="3" class="w-full p-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm text-slate-800 dark:text-slate-200 placeholder-slate-400 dark:placeholder-slate-400" data-translate-key="placeholderTopic" placeholder="Masukkan topik, judul, atau ide utama..."></textarea>
                            <div class="mt-2 grid grid-cols-1 sm:grid-cols-[1fr_auto] gap-2">
                                <select id="topic-template" class="w-full p-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm text-slate-800 dark:text-slate-200">
                                    <option value="">Template topik cepat...</option>
                                    <option value="Analisis pengaruh transformasi digital terhadap UMKM di Indonesia">UMKM & Transformasi Digital</option>
                                    <option value="Efektivitas metode blended learning terhadap hasil belajar mahasiswa">Pendidikan & Blended Learning</option>
                                    <option value="Strategi pemasaran berbasis media sosial untuk meningkatkan loyalitas pelanggan">Pemasaran Media Sosial</option>
                                    <option value="Optimasi sistem informasi akademik berbasis web untuk meningkatkan layanan kampus">Sistem Informasi Akademik</option>
                                    <option value="Dampak penggunaan kecerdasan buatan terhadap produktivitas kerja di sektor kreatif">AI & Produktivitas Kerja</option>
                                </select>
                                <button type="button" id="apply-template-btn" class="px-3 py-2 bg-slate-200 dark:bg-slate-700 rounded-md text-sm hover:bg-slate-300 dark:hover:bg-slate-600">Pakai Template</button>
                            </div>
                        </div>
                         <div>
                            <label for="gaya_sitasi" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1" data-translate-key="labelCitation">4. Opsi Sitasi</label>
                            <div class="flex gap-2">
                                <select id="gaya_sitasi" class="w-full p-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm text-slate-800 dark:text-slate-200">
                                    <option value="APA" selected>APA 7th</option>
                                    <option value="MLA">MLA 9th</option>
                                    <option value="IEEE">IEEE</option>
                                </select>
                                <div class="flex items-center p-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md whitespace-nowrap">
                                    <input id="include-citations" type="checkbox" class="h-4 w-4 text-teal-500 rounded bg-slate-200 dark:bg-slate-600 border-slate-400 dark:border-slate-500" checked>
                                    <label for="include-citations" class="ml-2 text-sm" data-translate-key="labelInclude">Sertakan</label>
                                </div>
                            </div>
                        </div>
                         <div>
                            <label for="max-year" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">5. Max Tahun Penelitian</label>
                            <input id="max-year" type="number" min="2000" max="2024" value="2024" class="w-full p-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm text-slate-800 dark:text-slate-200">
                        </div>
                         <div>
                            <label for="min-year" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">6. Min Tahun Penelitian</label>
                            <input id="min-year" type="number" min="2000" max="2024" value="2010" class="w-full p-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm text-slate-800 dark:text-slate-200">
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">7. Jenis Penelitian (Pilih satu atau lebih)</label>
                            <div id="research-type-container" class="grid grid-cols-2 gap-2">
                                <div class="flex items-center p-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md">
                                    <input id="research-type-skripsi" type="checkbox" value="Skripsi" class="h-4 w-4 text-teal-500 rounded bg-slate-200 dark:bg-slate-600 border-slate-400 dark:border-slate-500" checked>
                                    <label for="research-type-skripsi" class="ml-2 text-sm">Skripsi</label>
                                </div>
                                <div class="flex items-center p-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md">
                                    <input id="research-type-makalah" type="checkbox" value="Makalah" class="h-4 w-4 text-teal-500 rounded bg-slate-200 dark:bg-slate-600 border-slate-400 dark:border-slate-500">
                                    <label for="research-type-makalah" class="ml-2 text-sm">Makalah</label>
                                </div>
                                <div class="flex items-center p-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md">
                                    <input id="research-type-jurnal" type="checkbox" value="Jurnal Ilmiah" class="h-4 w-4 text-teal-500 rounded bg-slate-200 dark:bg-slate-600 border-slate-400 dark:border-slate-500">
                                    <label for="research-type-jurnal" class="ml-2 text-sm">Jurnal Ilmiah</label>
                                </div>
                                <div class="flex items-center p-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md">
                                    <input id="research-type-artikel" type="checkbox" value="Artikel Ilmiah" class="h-4 w-4 text-teal-500 rounded bg-slate-200 dark:bg-slate-600 border-slate-400 dark:border-slate-500">
                                    <label for="research-type-artikel" class="ml-2 text-sm">Artikel Ilmiah</label>
                                </div>
                                <div class="flex items-center p-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md">
                                    <input id="research-type-tesis" type="checkbox" value="Tesis" class="h-4 w-4 text-teal-500 rounded bg-slate-200 dark:bg-slate-600 border-slate-400 dark:border-slate-500">
                                    <label for="research-type-tesis" class="ml-2 text-sm">Tesis</label>
                                </div>
                                <div class="flex items-center p-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md">
                                    <input id="research-type-disertasi" type="checkbox" value="Disertasi" class="h-4 w-4 text-teal-500 rounded bg-slate-200 dark:bg-slate-600 border-slate-400 dark:border-slate-500">
                                    <label for="research-type-disertasi" class="ml-2 text-sm">Disertasi</label>
                                </div>
                            </div>
                        </div>
                         <div>
                            <label for="research-country" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">8. Negara Penelitian</label>
                            <select id="research-country" class="w-full p-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm text-slate-800 dark:text-slate-200">
                                <option value="Indonesia" selected>Indonesia</option>
                                <option value="Global">Global</option>
                                <option value="USA">USA</option>
                                <option value="Jepang">Jepang</option>
                                <option value="Eropa">Eropa</option>
                            </select>
                        </div>
                         <div>
                            <label for="include-bab5" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">9. Opsi Bab 5</label>
                            <div class="flex items-center p-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md whitespace-nowrap">
                                <input id="include-bab5" type="checkbox" class="h-4 w-4 text-teal-500 rounded bg-slate-200 dark:bg-slate-600 border-slate-400 dark:border-slate-500">
                                <label for="include-bab5" class="ml-2 text-sm">Sertakan Bab 5 (Penutup)</label>
                            </div>
                        </div>
                         <div>
                            <label for="include-lampiran" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">10. Opsi Lampiran</label>
                            <div class="flex items-center p-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md whitespace-nowrap">
                                <input id="include-lampiran" type="checkbox" class="h-4 w-4 text-teal-500 rounded bg-slate-200 dark:bg-slate-600 border-slate-400 dark:border-slate-500">
                                <label for="include-lampiran" class="ml-2 text-sm">Sertakan Daftar Lampiran dan Lampiran</label>
                            </div>
                        </div>
                    </div>
                </fieldset>

                <!-- Dynamic Options Container -->
                <div id="manual-mode-options" class="hidden">
                     <fieldset>
                        <legend class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2" data-translate-key="labelSelectSections">9. Pilih Bagian Dokumen</legend>
                        <div class="flex gap-2 mb-4">
                            <button id="select-all-btn" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg shadow-sm hover:bg-blue-700 text-sm">Pilih Semua</button>
                            <button id="deselect-all-btn" class="bg-gray-600 text-white font-semibold px-4 py-2 rounded-lg shadow-sm hover:bg-gray-700 text-sm">Batal Semua</button>
                        </div>
                        <div id="manual-sections-container" class="space-y-2 text-sm"></div>
                    </fieldset>
                     <fieldset id="manual-custom-prompts-container" class="hidden mt-4">
                         <legend class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2" data-translate-key="labelCustomPrompts">10. Instruksi Kustom (Opsional)</legend>
                         <div id="manual-custom-prompts-wrapper" class="space-y-3"></div>
                    </fieldset>
                </div>



                <div class="pt-4">
                    <button type="button" id="generate-btn" class="w-full bg-teal-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-teal-700 flex items-center justify-center gap-2">
                        <i id="generate-btn-icon" data-lucide="file-pen-line" class="w-5 h-5"></i>
                        <span id="btn-text" data-translate-key="btnGenerate">Generate Dokumen</span>
                    </button>
                </div>
                <div class="mt-4 p-3 bg-white dark:bg-slate-700/60 border border-slate-200 dark:border-slate-600 rounded-lg space-y-2">
                    <div class="flex items-center justify-between gap-2">
                        <p class="text-xs font-semibold text-slate-600 dark:text-slate-300">Sistem Draft Otomatis</p>
                        <span id="draft-status" class="text-xs text-slate-500 dark:text-slate-400">Belum ada draft</span>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <button type="button" id="save-draft-btn" class="px-2 py-2 text-xs bg-emerald-600 text-white rounded hover:bg-emerald-700">Simpan</button>
                        <button type="button" id="load-draft-btn" class="px-2 py-2 text-xs bg-sky-600 text-white rounded hover:bg-sky-700">Muat</button>
                        <button type="button" id="clear-draft-btn" class="px-2 py-2 text-xs bg-rose-600 text-white rounded hover:bg-rose-700">Hapus</button>
                    </div>
                </div>
                <div class="mt-4 p-3 bg-slate-100 dark:bg-slate-800/70 border border-slate-200 dark:border-slate-600 rounded-lg space-y-2">
                    <div class="flex items-center justify-between">
                        <p class="text-xs font-semibold text-slate-700 dark:text-slate-200">Support API Research (FREE mode)</p>
                        <label class="text-xs flex items-center gap-1"><input id="free-mode-toggle" type="checkbox" checked class="h-3.5 w-3.5">Free</label>
                    </div>
                    <select id="support-api-source" multiple class="w-full p-2 text-xs bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md h-28">
                        <option value="wiki" selected>Wikipedia Search</option>
                        <option value="wikidata" selected>Wikidata Entity</option>
                        <option value="openlibrary">OpenLibrary</option>
                        <option value="crossref">CrossRef</option>
                        <option value="worldbank">WorldBank</option>
                        <option value="restcountries">RestCountries</option>
                        <option value="myquran">MyQuran (ID)</option>
                        <option value="apiwilayah">API Wilayah Indonesia (ID)</option>
                        <option value="sekolahid">Sekolah Indonesia (ID)</option>
                        <option value="cuacaindo">Data BMKG Gempa (ID)</option>
                    </select>
                    <div class="grid grid-cols-2 gap-2">
                        <button type="button" id="extract-keywords-btn" class="px-2 py-2 text-xs bg-indigo-600 text-white rounded hover:bg-indigo-700">Ekstrak Keyword TF</button>
                        <button type="button" id="auto-research-btn" class="px-2 py-2 text-xs bg-cyan-600 text-white rounded hover:bg-cyan-700">Auto Search Data</button>
                        <button type="button" id="apply-research-to-topic-btn" class="px-2 py-2 text-xs bg-teal-600 text-white rounded hover:bg-teal-700">Tambahkan ke Topik</button>
                        <button type="button" id="open-word-studio-btn" class="px-2 py-2 text-xs bg-purple-600 text-white rounded hover:bg-purple-700">Word Studio</button>
                        <button type="button" id="suggest-title-btn" class="px-2 py-2 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">Saran Judul</button>
                        <button type="button" id="generate-outline-btn" class="px-2 py-2 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">Buat Outline</button>
                        <button type="button" id="generate-abstract-btn" class="px-2 py-2 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">Buat Abstrak</button>
                        <button type="button" id="build-citation-btn" class="px-2 py-2 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">Generator Sitasi</button>
                        <button type="button" id="readability-check-btn" class="px-2 py-2 text-xs bg-orange-600 text-white rounded hover:bg-orange-700">Cek Keterbacaan</button>
                        <button type="button" id="plagiarism-local-btn" class="px-2 py-2 text-xs bg-orange-600 text-white rounded hover:bg-orange-700">Cek Kemiripan Lokal</button>
                        <button type="button" id="build-timeline-btn" class="px-2 py-2 text-xs bg-fuchsia-600 text-white rounded hover:bg-fuchsia-700">Timeline Penelitian</button>
                        <button type="button" id="method-matrix-btn" class="px-2 py-2 text-xs bg-fuchsia-600 text-white rounded hover:bg-fuchsia-700">Matriks Metode</button>
                        <button type="button" id="risk-matrix-btn" class="px-2 py-2 text-xs bg-fuchsia-600 text-white rounded hover:bg-fuchsia-700">Matriks Risiko</button>
                        <button type="button" id="auto-conclusion-btn" class="px-2 py-2 text-xs bg-fuchsia-600 text-white rounded hover:bg-fuchsia-700">Auto Kesimpulan</button>
                        <button type="button" id="local-ai-summary-btn" class="px-2 py-2 text-xs bg-emerald-600 text-white rounded hover:bg-emerald-700">AI Summary Lokal</button>
                        <button type="button" id="local-ai-analysis-btn" class="px-2 py-2 text-xs bg-emerald-600 text-white rounded hover:bg-emerald-700">AI Analisis Lokal</button>
                    </div>
                    <div id="support-result" class="text-xs text-slate-600 dark:text-slate-300 max-h-44 overflow-y-auto bg-white dark:bg-slate-700/40 border border-slate-200 dark:border-slate-600 rounded p-2">Belum ada data support.</div>
                </div>
            </form>
        </div>

        <!-- Output Panel -->
        <div id="output-panel" class="lg:w-3/5 xl:w-2/3 w-full p-6 lg:p-10 h-screen flex flex-col relative overflow-hidden">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-slate-800 dark:text-slate-200" data-translate-key="titleWorkspace">Ruang Kerja Dokumen</h2>
                <div id="export-buttons" class="hidden flex items-center gap-2">
                    <button id="copy-all-btn" class="bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-300 dark:hover:bg-slate-600 font-medium py-2 px-4 rounded-lg flex items-center gap-2">
                        <i data-lucide="copy" class="w-4 h-4"></i><span data-translate-key="btnCopyAll">Salin Semua</span>
                    </button>
                    <button id="export-docx-btn" class="bg-blue-600 text-white hover:bg-blue-700 font-medium py-2 px-4 rounded-lg flex items-center gap-2">
                        <i data-lucide="file-down" class="w-4 h-4"></i><span data-translate-key="btnExport">Export .docx</span>
                    </button>
                    <button id="create-word-btn" class="bg-purple-600 text-white hover:bg-purple-700 font-medium py-2 px-4 rounded-lg flex items-center gap-2">
                        <i data-lucide="file" class="w-4 h-4"></i><span>Buat Word</span>
                    </button>
                    <button id="export-pdf-btn" class="bg-rose-600 text-white hover:bg-rose-700 font-medium py-2 px-4 rounded-lg flex items-center gap-2">
                        <i data-lucide="file-type" class="w-4 h-4"></i><span>Download PDF</span>
                    </button>
                    <button id="open-doc-btn" class="bg-emerald-600 text-white hover:bg-emerald-700 font-medium py-2 px-4 rounded-lg flex items-center gap-2">
                        <i data-lucide="folder-open" class="w-4 h-4"></i><span>Open Dokumen</span>
                    </button>
                    <input id="open-doc-input" type="file" accept=".txt,.md,.html,.htm,.docx" class="hidden">
                </div>
                 <div id="copy-feedback" class="hidden fixed top-5 right-5 bg-slate-800 text-white text-sm px-3 py-1 rounded-md z-50" data-translate-key="feedbackCopied">Teks disalin!</div>
            </div>
            <div id="output-container" class="bg-slate-100 dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 flex-grow p-4 lg:p-6 overflow-y-auto relative">
                <div id="placeholder" class="flex flex-col items-center justify-center h-full text-center"><div class="w-16 h-16 bg-slate-200 dark:bg-slate-700 rounded-full flex items-center justify-center mb-4"><i data-lucide="file-search-2" class="w-8 h-8 text-slate-400 dark:text-slate-500"></i></div><h2 class="text-xl font-semibold text-slate-700 dark:text-slate-300" data-translate-key="placeholderTitle">Mulai Proyek Tulisan Anda</h2><p class="text-slate-500 dark:text-slate-400 mt-2 max-w-md" data-translate-key="placeholderSubtitle">Pilih mode, jenis dokumen, isi topik, lalu klik generate.</p></div>
                <div id="loader" class="hidden absolute inset-0 bg-slate-100/80 dark:bg-slate-800/80 backdrop-blur-sm flex flex-col items-center justify-center z-10"><div class="w-12 h-12 border-4 border-t-teal-500 border-slate-300 dark:border-slate-600 rounded-full animate-spin"></div><p id="loader-text" class="mt-4 text-slate-500 dark:text-slate-400 font-medium"></p></div>
                <div id="content-sections-container" class="space-y-4 prose-output dark:text-slate-300 text-slate-700"></div>
            </div>
            <div id="word-studio" class="hidden mt-4 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-3">
                <div class="flex flex-wrap items-center gap-2 mb-2">
                    <span class="text-xs font-semibold text-slate-600 dark:text-slate-300">Word Studio (In-App)</span>
                    <button type="button" id="word-bold-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Bold</button>
                    <button type="button" id="word-italic-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Italic</button>
                    <button type="button" id="word-underline-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Underline</button>
                    <button type="button" id="word-strike-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Strike</button>
                    <button type="button" id="word-h1-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">H1</button>
                    <button type="button" id="word-h2-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">H2</button>
                    <button type="button" id="word-h3-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">H3</button>
                    <button type="button" id="word-p-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Paragraph</button>
                    <button type="button" id="word-ul-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Bullet</button>
                    <button type="button" id="word-ol-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Number</button>
                    <button type="button" id="word-align-left-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Left</button>
                    <button type="button" id="word-align-center-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Center</button>
                    <button type="button" id="word-align-right-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Right</button>
                    <button type="button" id="word-justify-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Justify</button>
                    <button type="button" id="word-indent-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Indent+</button>
                    <button type="button" id="word-outdent-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Indent-</button>
                    <button type="button" id="word-quote-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Quote</button>
                    <button type="button" id="word-code-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Code</button>
                    <button type="button" id="word-hr-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">HR</button>
                    <button type="button" id="word-link-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Link</button>
                    <button type="button" id="word-unlink-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Unlink</button>
                    <button type="button" id="word-table-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Table</button>
                    <button type="button" id="word-sup-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Sup</button>
                    <button type="button" id="word-sub-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Sub</button>
                    <button type="button" id="word-clear-format-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Clear</button>
                    <button type="button" id="word-select-all-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Select All</button>
                    <button type="button" id="word-undo-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Undo</button>
                    <button type="button" id="word-redo-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Redo</button>
                    <button type="button" id="word-copy-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Copy</button>
                    <button type="button" id="word-paste-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Paste*</button>
                    <button type="button" id="word-find-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Find</button>
                    <button type="button" id="word-replace-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Replace</button>
                    <button type="button" id="word-count-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Word Count</button>
                    <button type="button" id="word-readtime-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Read Time</button>
                    <button type="button" id="word-save-local-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Save Local</button>
                    <button type="button" id="word-load-local-btn" class="px-2 py-1 text-xs bg-slate-200 dark:bg-slate-700 rounded">Load Local</button>
                    <button type="button" id="word-sync-btn" class="px-2 py-1 text-xs bg-emerald-600 text-white rounded">Sync ke Dokumen</button>
                    <button type="button" id="word-close-btn" class="px-2 py-1 text-xs bg-rose-600 text-white rounded">Tutup</button>
                </div>
                <div id="word-editor" contenteditable="true" class="min-h-64 max-h-96 overflow-y-auto p-3 rounded border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100"></div>
            </div>
            
            <div id="paraphrase-panel" class="hidden absolute bottom-10 left-1/2 -translate-x-1/2 w-11/12 max-w-2xl bg-slate-200/90 dark:bg-slate-700/90 backdrop-blur-md shadow-2xl rounded-xl p-3 border border-slate-300 dark:border-slate-600 z-20">
                <div class="flex justify-between items-center"><p class="text-sm font-semibold text-slate-800 dark:text-slate-200" data-translate-key="paraphraseTitle">Alat Parafrase</p><button id="close-paraphrase-panel" class="text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button></div>
                <div class="text-xs text-slate-700 dark:text-slate-300 bg-slate-100 dark:bg-slate-800 p-2 my-2 rounded-md max-h-16 overflow-y-auto" id="selected-text-preview"></div>
                <div class="mb-2">
                    <label for="paraphrase-logic-select" class="block text-xs text-slate-500 mb-1">Logika Parafrase Lanjutan (TensorFlow.js)</label>
                    <select id="paraphrase-logic-select" class="w-full p-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-xs">
                        <option value="ai">AI Prompt (default)</option>
                        <option value="tf-auto">TF Auto Best Match</option>
                        <option value="logic-1">L1 Formal Akademik</option>
                        <option value="logic-2">L2 Ringkas Padat</option>
                        <option value="logic-3">L3 Elaborasi Kontekstual</option>
                        <option value="logic-4">L4 Sebab-Akibat</option>
                        <option value="logic-5">L5 Definisi-Contoh</option>
                        <option value="logic-6">L6 Problem-Solusi</option>
                        <option value="logic-7">L7 Komparatif</option>
                        <option value="logic-8">L8 Kronologis</option>
                        <option value="logic-9">L9 Aktif-Formal</option>
                        <option value="logic-10">L10 Checklist Poin</option>
                    </select>
                </div>
                <div id="paraphrase-preview" class="hidden mt-3 p-3 bg-slate-100 dark:bg-slate-800 rounded-md">
                    <h4 class="text-sm font-semibold mb-2">Pratinjau:</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-xs font-medium mb-1">Asli:</p>
                            <div class="text-xs bg-white dark:bg-slate-700 p-2 rounded border" id="original-preview"></div>
                        </div>
                        <div>
                            <p class="text-xs font-medium mb-1">Parafrase:</p>
                            <div class="text-xs bg-white dark:bg-slate-700 p-2 rounded border" id="paraphrased-preview"></div>
                        </div>
                    </div>
                    <div class="mt-3 flex gap-2">
                        <button id="confirm-paraphrase" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">Konfirmasi</button>
                        <button id="cancel-paraphrase" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">Batal</button>
                    </div>
                </div>
                <div class="flex items-center gap-2 mt-3">
                    <button data-mode="ai0" data-active="false" class="paraphrase-mode-btn toggle-btn flex-1 flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg bg-slate-300 dark:bg-slate-600 hover:bg-slate-400 dark:hover:bg-slate-500 text-sm">
                        <i data-lucide="sparkles" class="w-4 h-4"></i><span data-translate-key="paraphraseAI">AI 0%</span></button>
                    <button data-mode="copyright0" data-active="false" class="paraphrase-mode-btn toggle-btn flex-1 flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg bg-slate-300 dark:bg-slate-600 hover:bg-slate-400 dark:hover:bg-slate-500 text-sm">
                        <i data-lucide="shield-check" class="w-4 h-4"></i><span data-translate-key="paraphraseCopyright">0% Copyright</span></button>
                    <button id="btn_custom" class="relative flex-1 flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg bg-slate-300 dark:bg-slate-600 hover:bg-slate-400 dark:hover:bg-slate-500 text-sm">
                        <i data-lucide="sliders" class="w-4 h-4"></i><span data-translate-key="paraphraseCustom">Kustom</span><div id="custom-indicator" class="hidden absolute -top-1 -right-1 w-2 h-2 bg-indigo-500 rounded-full border border-slate-800"></div></button>
                    <div class="border-l border-slate-400 dark:border-slate-500 h-6 mx-1"></div>
                    <button id="btn_paraphrase" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-700 text-sm" data-translate-key="btnParaphrase">Parafrasekan</button>
                    <button id="btn_regenerate_paraphrase" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg shadow-sm hover:bg-blue-700 text-sm">Buat Ulang</button>
                    <button id="btn_expand" class="bg-purple-600 text-white font-semibold px-4 py-2 rounded-lg shadow-sm hover:bg-purple-700 text-sm">Perbanyak Kata</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg w-full max-w-lg p-6 border border-slate-200 dark:border-slate-700">
            <h2 class="text-xl font-bold text-slate-800 dark:text-slate-100 mb-6" data-translate-key="settingsTitle">Pengaturan</h2>
            
            <div class="space-y-6">
                <!-- API Key Settings -->
                <fieldset>
                    <legend class="text-sm font-medium text-slate-600 dark:text-slate-300" data-translate-key="settingsApiTitle">Kunci API Gemini</legend>
                    <div class="mt-2 space-y-2">
                        <input type="password" id="setting-custom-api-key" class="w-full p-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" placeholder="Masukkan Gemini API key Anda...">
                        <div>
                            <label for="setting-ai-model" class="block text-xs text-slate-500 mb-1">Model AI</label>
                            <select id="setting-ai-model" class="w-full p-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm text-slate-800 dark:text-slate-200">
                                <option value="gemini-2.5-flash-preview-05-20">Gemini 2.5 Flash</option>
                                <option value="gemini-3-pro-exp">Gemini 3 Pro</option>
                            </select>
                        </div>
                    </div>
                </fieldset>

                <!-- Appearance Settings -->
                <fieldset>
                    <legend class="text-sm font-medium text-slate-600 dark:text-slate-300" data-translate-key="settingsAppearanceTitle">Tampilan</legend>
                    <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                           <label for="setting-language" class="block text-xs text-slate-500" data-translate-key="settingsLanguage">Bahasa</label>
                           <select id="setting-language" class="w-full p-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm text-slate-800 dark:text-slate-200">
                                <option value="id">Bahasa Indonesia</option>
                                <option value="en">English</option>
                           </select>
                        </div>
                        <div>
                           <label for="setting-theme" class="block text-xs text-slate-500" data-translate-key="settingsTheme">Tema</label>
                       <select id="setting-theme" class="w-full p-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm text-slate-800 dark:text-slate-200">
                            <option value="day">Day</option>
                            <option value="night">Night</option>
                            <option value="planet">Planet</option>
                            <option value="ai">AI</option>
                       </select>
                        </div>
                    </div>
                </fieldset>

                <!-- Document Settings -->
                <fieldset>
                    <legend class="text-sm font-medium text-slate-600 dark:text-slate-300" data-translate-key="settingsDocTitle">Dokumen</legend>
                     <div class="mt-2 p-3 bg-slate-100 dark:bg-slate-700/50 rounded-md">
                        <label for="setting-toc-dots" class="flex items-center justify-between cursor-pointer">
                            <span class="text-sm text-slate-700 dark:text-slate-200" data-translate-key="settingsTocDots">Gunakan garis titik-titik di Daftar Isi</span>
                            <div class="relative">
                                <input type="checkbox" id="setting-toc-dots" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-300 dark:bg-slate-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-teal-500"></div>
                            </div>
                        </label>
                    </div>
                </fieldset>
            </div>

            <div class="mt-8 flex justify-end gap-3">
                <button id="modal-close-btn" class="px-4 py-2 bg-slate-200 dark:bg-slate-600 rounded-md hover:bg-slate-300 dark:hover:bg-slate-500 text-sm font-semibold" data-translate-key="btnClose">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Custom Paraphrase Modal is loaded via JS now -->
    <div id="custom-modal-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            // --- DATA & CONFIGURATION ---
            const translations = {
                en: { appTitle: "AutoBab Universal Pro", appSubtitle: "Intelligent Document Generator", labelMode: "1. Generation Mode", modeOtomatis: "Automatic (Single Step)", modeManual: "Manual (Per Section)", labelDocType: "2. Document Type", labelTopic: "3. Main Topic", placeholderTopic: "Enter topic, title, or main idea...", labelCitation: "4. Citation Options", labelInclude: "Include", labelSelectSections: "5. Select Document Sections", labelCustomPrompts: "6. Custom Instructions (Optional)", btnGenerate: "Generate Document", btnStartManual: "Start Manual Process", titleWorkspace: "Document Workspace", btnCopyAll: "Copy All", btnExport: "Export .docx", feedbackCopied: "Text copied!", placeholderTitle: "Start Your Writing Project", placeholderSubtitle: "Choose a mode, document type, fill in the topic, then click generate.", paraphraseTitle: "Paraphrase Tool", paraphraseAI: "AI 0%", paraphraseCopyright: "0% Copyright", paraphraseCustom: "Custom", btnParaphrase: "Paraphrase", settingsTitle: "Settings", settingsApiTitle: "Gemini API Key", settingsAppearanceTitle: "Appearance", settingsLanguage: "Language", settingsTheme: "Theme", themeDark: "Dark", themeLight: "Light", settingsDocTitle: "Document", settingsTocDots: "Use dot leaders in Table of Contents", btnClose: "Close", loaderPreparing: "Preparing...", loaderCreating: "Creating content...", loaderFinalizing: "Finalizing document...", manualStepTitle: "Manual Process: Create Main Content", manualStepSubtitle: "Create the main sections one by one. The 'Finalize' button will become active once all main sections are complete.", manualFinalizeBtn: "Finalize Document", manualPartsRemaining: "other parts", },
                id: { appTitle: "AutoBab Universal Pro", appSubtitle: "Generator Dokumen Cerdas", labelMode: "1. Mode Pembuatan", modeOtomatis: "Otomatis (Sekali Jadi)", modeManual: "Manual (Per Bagian)", labelDocType: "2. Jenis Dokumen", labelTopic: "3. Topik Utama", placeholderTopic: "Masukkan topik, judul, atau ide utama...", labelCitation: "4. Opsi Sitasi", labelInclude: "Sertakan", labelSelectSections: "5. Pilih Bagian Dokumen", labelCustomPrompts: "6. Instruksi Kustom (Opsional)", btnGenerate: "Generate Dokumen", btnStartManual: "Mulai Proses Manual", titleWorkspace: "Ruang Kerja Dokumen", btnCopyAll: "Salin Semua", btnExport: "Export .docx", feedbackCopied: "Teks disalin!", placeholderTitle: "Mulai Proyek Tulisan Anda", placeholderSubtitle: "Pilih mode, jenis dokumen, isi topik, lalu klik generate.", paraphraseTitle: "Alat Parafrase", paraphraseAI: "AI 0%", paraphraseCopyright: "0% Copyright", paraphraseCustom: "Kustom", btnParaphrase: "Parafrasekan", settingsTitle: "Pengaturan", settingsApiTitle: "Kunci API Gemini", settingsAppearanceTitle: "Tampilan", settingsLanguage: "Bahasa", settingsTheme: "Tema", themeDark: "Gelap", themeLight: "Terang", settingsDocTitle: "Dokumen", settingsTocDots: "Gunakan garis titik-titik di Daftar Isi", btnClose: "Tutup", loaderPreparing: "Mempersiapkan...", loaderCreating: "Membuat konten...", loaderFinalizing: "Memfinalisasi dokumen...", manualStepTitle: "Proses Manual: Buat Konten Utama", manualStepSubtitle: "Buat bagian-bagian utama satu per satu. Tombol 'Finalisasi' akan aktif setelah semua bagian utama selesai dibuat.", manualFinalizeBtn: "Finalisasi Dokumen", manualPartsRemaining: "bagian lain", }
            };
            const doc_structures = {
                 "Skripsi": { structure: ["Judul", "Halaman Pengesahan", "Abstrak", "Kata Pengantar", "Daftar Isi", "Daftar Tabel", "Daftar Gambar", "Bab 1 Pendahuluan", "Bab 2 Kajian Pustaka", "Bab 3 Metodologi Penelitian", "Bab 4 Hasil dan Pembahasan", "Bab 5 Penutup", "Daftar Pustaka", "Lampiran"] },
                 "Makalah": { structure: ["Judul", "Kata Pengantar", "Daftar Isi", "Abstrak + Kata Kunci", "Bab 1 Pendahuluan", "Bab 2 Kajian Pustaka", "Bab 3 Metodologi", "Bab 4 Hasil dan Pembahasan", "Bab 5 Penutup", "Daftar Pustaka"] },
                 "Jurnal Ilmiah": { structure: ["Judul", "Abstrak + Kata Kunci", "Pendahuluan", "Kajian Pustaka", "Metodologi", "Hasil", "Pembahasan", "Kesimpulan", "Daftar Pustaka"] },
                 "Artikel Ilmiah": { structure: ["Judul", "Abstrak", "Pendahuluan", "Isi / Pembahasan", "Penutup", "Daftar Pustaka"] },
                 "Tesis": { structure: ["Judul", "Halaman Pengesahan", "Abstrak", "Kata Pengantar", "Daftar Isi", "Daftar Tabel", "Daftar Gambar", "Bab 1 Pendahuluan", "Bab 2 Kajian Pustaka", "Bab 3 Metodologi Penelitian", "Bab 4 Hasil Penelitian", "Bab 5 Pembahasan", "Bab 6 Kesimpulan dan Saran", "Daftar Pustaka", "Lampiran"] },
                 "Disertasi": { structure: ["Judul", "Halaman Pengesahan", "Abstrak", "Kata Pengantar", "Daftar Isi", "Daftar Tabel", "Daftar Gambar", "Bab 1 Pendahuluan", "Bab 2 Kajian Pustaka", "Bab 3 Metodologi Penelitian", "Bab 4 Hasil Penelitian", "Bab 5 Pembahasan", "Bab 6 Kesimpulan dan Saran", "Bab 7 Rekomendasi", "Daftar Pustaka", "Lampiran", "Riwayat Hidup"] },
                 "Custom": { structure: ["Judul", "Abstrak", "Bab 1 Pendahuluan", "Bab 2 Kajian Pustaka", "Bab 3 Metodologi", "Bab 4 Hasil dan Pembahasan", "Bab 5 Penutup", "Daftar Pustaka"] }
            };
            const all_main_sections = [ "Pendahuluan", "Bab 1 Pendahuluan", "Kajian Pustaka", "Bab 2 Kajian Pustaka", "Metodologi", "Bab 3 Metodologi", "Bab 3 Metodologi Penelitian", "Hasil dan Pembahasan", "Bab 4 Hasil dan Pembahasan", "Bab 4 Hasil", "Bab 5 Pembahasan", "Bab 5 Penutup", "Bab 6 Kesimpulan dan Saran", "Bab 7 Rekomendasi", "Pembahasan", "Isi / Pembahasan", "Kesimpulan", "Penutup", "Abstrak", "Abstrak + Kata Kunci"];

            function getEffectiveDocType() {
                const docType = document.getElementById('jenis-dokumen').value;
                if (docType === 'Custom') {
                    return document.getElementById('custom-doc-name').value.trim() || 'Custom Document';
                }
                return docType;
            }

            let appState = { content: {}, toc: [] };
            let appSettings = {};
            
            const ui = {
                loader: document.getElementById('loader'), loaderText: document.getElementById('loader-text'),
                placeholder: document.getElementById('placeholder'), 
                contentContainer: document.getElementById('content-sections-container'), exportButtons: document.getElementById('export-buttons'),
                manualModeOptions: document.getElementById('manual-mode-options'), manualSectionsContainer: document.getElementById('manual-sections-container'),
                manualCustomPromptsContainer: document.getElementById('manual-custom-prompts-container'), manualCustomPromptsWrapper: document.getElementById('manual-custom-prompts-wrapper'),
                settingsModal: document.getElementById('settings-modal'),
                generateBtn: document.getElementById('generate-btn'),
                generateBtnIcon: document.getElementById('generate-btn-icon'),
                btnText: document.getElementById('btn-text'),
                draftStatus: document.getElementById('draft-status'),
                saveDraftBtn: document.getElementById('save-draft-btn'),
                loadDraftBtn: document.getElementById('load-draft-btn'),
                clearDraftBtn: document.getElementById('clear-draft-btn'),
                topicTemplate: document.getElementById('topic-template'),
                applyTemplateBtn: document.getElementById('apply-template-btn'),
                copyFeedback: document.getElementById('copy-feedback'),
                supportApiSource: document.getElementById('support-api-source'),
                supportResult: document.getElementById('support-result'),
                freeModeToggle: document.getElementById('free-mode-toggle'),
                extractKeywordsBtn: document.getElementById('extract-keywords-btn'),
                autoResearchBtn: document.getElementById('auto-research-btn'),
                applyResearchToTopicBtn: document.getElementById('apply-research-to-topic-btn'),
                openWordStudioBtn: document.getElementById('open-word-studio-btn'),
                wordStudio: document.getElementById('word-studio'),
                wordEditor: document.getElementById('word-editor'),
            };

            // --- SETTINGS MANAGEMENT ---
            const loadSettings = () => {
                const savedSettings = JSON.parse(localStorage.getItem('autoBabSettings_v6')) || JSON.parse(localStorage.getItem('autoBabSettings_v5')) || {};
            appSettings = {
                    customApiKey: savedSettings.customApiKey || '',
                    aiModel: (savedSettings.aiModel || '').startsWith('gemini') ? savedSettings.aiModel : 'gemini-2.5-flash-preview-05-20',
                    language: savedSettings.language || 'id',
                    theme: savedSettings.theme || 'day',
                    tocDots: savedSettings.tocDots === true,
                    customParaphrasePrompt: savedSettings.customParaphrasePrompt || '',
                };
                applySettings();
            };
            const saveSettings = () => { localStorage.setItem('autoBabSettings_v6', JSON.stringify(appSettings)); };
            const applySettings = () => {
                const customKeyInput = document.getElementById('setting-custom-api-key');
                customKeyInput.value = appSettings.customApiKey;
                document.getElementById('setting-ai-model').value = appSettings.aiModel;
                document.getElementById('setting-language').value = appSettings.language;
                applyLanguage(appSettings.language);
                document.getElementById('setting-theme').value = appSettings.theme;
                applyTheme(appSettings.theme);
                document.getElementById('setting-toc-dots').checked = appSettings.tocDots;
            };
            const applyLanguage = (lang) => {
                document.documentElement.lang = lang;
                document.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.dataset.translateKey;
                    const translation = translations[lang]?.[key];
                    if (translation) {
                        if (el.placeholder !== undefined) el.placeholder = translation;
                        else el.textContent = translation;
                    }
                });
            };
            const applyTheme = (theme) => {
                document.documentElement.setAttribute('data-theme', theme);
                if (theme === 'night') document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            };
            const getActiveApiKey = () => appSettings.customApiKey;
            const getActiveModel = () => appSettings.aiModel || 'gemini-2.5-flash-preview-05-20';

            const DRAFT_STORAGE_KEY = 'autoBabDraft_v1';

            function serializeGenerationForm() {
                const fields = {};
                document.querySelectorAll('#generation-form input, #generation-form select, #generation-form textarea').forEach(el => {
                    if (!el.id) return;
                    if (el.type === 'checkbox') fields[el.id] = el.checked;
                    else fields[el.id] = el.value;
                });
                return fields;
            }

            function restoreGenerationForm(fields = {}) {
                Object.entries(fields).forEach(([id, value]) => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    if (el.type === 'checkbox') el.checked = Boolean(value);
                    else el.value = value;
                });
                updateWorkflowUI();
            }

            function saveDraft(showAlert = false) {
                const hasTopic = document.getElementById('topik').value.trim().length > 0;
                const hasContent = Object.keys(appState.content || {}).length > 0;
                if (!hasTopic && !hasContent) {
                    if (showAlert) alert('Isi topik atau generate konten dulu sebelum menyimpan draft.');
                    return;
                }
                const payload = {
                    savedAt: new Date().toISOString(),
                    formData: serializeGenerationForm(),
                    appState
                };
                localStorage.setItem(DRAFT_STORAGE_KEY, JSON.stringify(payload));
                updateDraftStatus();
                if (showAlert) alert('Draft berhasil disimpan.');
            }

            function restoreContentFromState() {
                ui.contentContainer.innerHTML = '';
                const titles = Array.isArray(appState.toc) ? appState.toc : [];
                if (!titles.length) {
                    ui.placeholder.classList.remove('hidden');
                    ui.exportButtons.classList.add('hidden');
                    return;
                }
                ui.placeholder.classList.add('hidden');
                titles.forEach(title => {
                    const content = appState.content?.[title] || '';
                    const card = document.createElement('div');
                    card.className = 'section-card p-4 bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 animate-fade-in mb-4';
                    card.dataset.sectionTitle = title;
                    card.innerHTML = `<h3 class="font-bold mb-2 text-slate-800 dark:text-slate-200">${title}</h3><div class="prose-output">${marked.parse(content)}</div><div class="auto-media mt-3"></div><div class="mt-3 flex flex-wrap gap-2"><button class="auto-image-btn px-3 py-1 bg-cyan-600 text-white rounded text-sm hover:bg-cyan-700" data-section="${title}">Cari Foto Otomatis</button><button class="auto-table-btn px-3 py-1 bg-amber-600 text-white rounded text-sm hover:bg-amber-700" data-section="${title}">Buat Tabel Otomatis</button></div>`;
                    ui.contentContainer.appendChild(card);
                });
                ui.exportButtons.classList.remove('hidden');
            }

            function loadDraft(showAlert = false) {
                const raw = localStorage.getItem(DRAFT_STORAGE_KEY);
                if (!raw) {
                    if (showAlert) alert('Belum ada draft tersimpan.');
                    updateDraftStatus();
                    return;
                }
                try {
                    const parsed = JSON.parse(raw);
                    restoreGenerationForm(parsed.formData || {});
                    appState = parsed.appState || { content: {}, toc: [] };
                    restoreContentFromState();
                    updateDraftStatus(parsed.savedAt);
                    if (showAlert) alert('Draft berhasil dimuat.');
                } catch (error) {
                    console.error('Gagal memuat draft:', error);
                    if (showAlert) alert('Draft rusak dan tidak dapat dimuat.');
                }
            }

            function clearDraft(showAlert = false) {
                localStorage.removeItem(DRAFT_STORAGE_KEY);
                updateDraftStatus();
                if (showAlert) alert('Draft dihapus.');
            }

            function updateDraftStatus(savedAt = null) {
                const raw = localStorage.getItem(DRAFT_STORAGE_KEY);
                if (!raw) {
                    ui.draftStatus.textContent = 'Belum ada draft';
                    return;
                }
                let timestamp = savedAt;
                if (!timestamp) {
                    try {
                        timestamp = JSON.parse(raw).savedAt;
                    } catch (_) {
                        timestamp = null;
                    }
                }
                if (!timestamp) {
                    ui.draftStatus.textContent = 'Draft tersedia';
                    return;
                }
                const date = new Date(timestamp);
                ui.draftStatus.textContent = `Tersimpan ${date.toLocaleString('id-ID')}`;
            }

            // --- CORE API LOGIC ---
            const callGeminiAPI = async (prompt) => {
                const model = getActiveModel();
                const systemInstructionText = `Anda adalah asisten AI akademis. Gunakan Bahasa Indonesia yang baik dan benar. Tulis konten untuk bagian yang diminta berdasarkan topik. Gunakan **teks** untuk menekankan kata atau frasa penting, yang akan ditampilkan dengan ukuran huruf sedang. Pastikan formatting markdown benar, seperti **teks tebal** tanpa spasi di sekitar tanda **. ${document.getElementById('include-citations').checked ? `Sisipkan sitasi (${document.getElementById('gaya_sitasi').value}: Nama, Tahun) jika perlu.` : ''} JANGAN membuat daftar pustaka kecuali diminta secara eksplisit. Fokus hanya pada konten bagian yang diminta. Mulai respons Anda LANGSUNG dengan konten.`;

                const callGoogleModel = async () => {
                    const apiKey = getActiveApiKey();
                    if (!apiKey) {
                        alert("Kunci API Google tidak valid. Silakan periksa Pengaturan.");
                        return `### Kesalahan Konfigurasi

API Key Google belum diatur atau tidak valid.`;
                    }
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemInstructionText }] }
                    };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`Google API error! Status: ${response.status}`);
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]) return result.candidates[0].content.parts[0].text;
                    throw new Error(`Struktur respons Google API tidak valid. Respons: ${JSON.stringify(result)}`);
                };

                try {
                    return await callGoogleModel();
                } catch (error) {
                    console.error("Error calling AI API:", error);
                    return `### Terjadi Kesalahan
${error.message}`;
                }
            };

            const getAbstractLanguagePrompt = () => {
                const langSelect = document.getElementById('manual-abstract-lang');
                if (langSelect) {
                    const lang = langSelect.value;
                    return ` Untuk bagian "Abstrak + Kata Kunci" atau "Abstrak", buatlah dalam ${lang}. Setelah abstrak, sertakan 3-5 kata kunci yang relevan.`;
                }
                return '';
            };
            
            // --- UI & WORKFLOW MANAGEMENT ---
            function resetStateAndUI() {
                appState = { content: {}, toc: [] };
                ui.contentContainer.innerHTML = '';
                ui.placeholder.classList.remove('hidden');
                ui.exportButtons.classList.add('hidden');
                ui.loader.classList.add('hidden');
            }

            function updateWorkflowUI() {
                resetStateAndUI();
                ui.generateBtn.disabled = false;
                const mode = document.getElementById('generation-mode').value;
                const docType = document.getElementById('jenis-dokumen').value;
                ui.manualModeOptions.classList.toggle('hidden', mode === 'otomatis');

                // Show custom input if Custom selected
                const customDiv = document.getElementById('custom-doc-type');
                customDiv.classList.toggle('hidden', docType !== 'Custom');

                // Auto-update Bab 5 option based on doc type
                const bab5Checkbox = document.getElementById('include-bab5');
                const bab5Div = bab5Checkbox.parentElement;
                if (docType === 'Jurnal Ilmiah' || docType === 'Artikel Ilmiah') {
                    bab5Div.classList.add('hidden');
                    bab5Checkbox.checked = true; // Always include for these types
                } else {
                    bab5Div.classList.remove('hidden');
                }

                if (mode === 'otomatis') {
                    ui.btnText.dataset.translateKey = 'btnGenerate';
                    ui.generateBtnIcon.setAttribute('data-lucide', 'file-pen-line');
                } else {
                    ui.btnText.dataset.translateKey = 'btnStartManual';
                    ui.generateBtnIcon.setAttribute('data-lucide', 'git-commit-vertical');
                    updateManualChecklist();
                }
                applyLanguage(appSettings.language);
                lucide.createIcons();
            }

            function updateManualChecklist() {
                const docType = document.getElementById('jenis-dokumen').value;
                const includeBab5 = document.getElementById('include-bab5').checked;
                const includeLampiran = document.getElementById('include-lampiran').checked;
                let allSectionsFlat = doc_structures[docType].structure.filter(s => includeBab5 || !s.includes('Bab 5'));
                if (includeLampiran) {
                    const daftarIsiIndex = allSectionsFlat.findIndex(s => s.includes('Daftar Isi'));
                    if (daftarIsiIndex > -1) {
                        allSectionsFlat.splice(daftarIsiIndex + 1, 0, 'Daftar Lampiran');
                    } else {
                        allSectionsFlat.push('Daftar Lampiran');
                    }
                    allSectionsFlat.push('Lampiran');
                }

                // Adjust structure if Bab 5 not included for Skripsi and Makalah
                if (!includeBab5 && (docType === 'Skripsi' || docType === 'Makalah')) {
                    const bab3Index = allSectionsFlat.findIndex(s => s.includes('Bab 3 Metodologi'));
                    const bab4Index = allSectionsFlat.findIndex(s => s.includes('Bab 4 Hasil'));
                    const bab5Index = allSectionsFlat.findIndex(s => s.includes('Bab 5'));
                    if (bab3Index !== -1 && bab4Index !== -1) {
                        allSectionsFlat[bab3Index] = 'Bab 3 Metodologi dan Hasil';
                        allSectionsFlat[bab4Index] = 'Bab 4 Penutup';
                        if (bab5Index !== -1) allSectionsFlat.splice(bab5Index, 1);
                    }
                }

                ui.manualSectionsContainer.innerHTML = '';
                ui.manualCustomPromptsWrapper.innerHTML = '';
                let hasMainContent = false;
                allSectionsFlat.forEach(item => {
                    let sectionTitle = typeof item === 'string' ? item : item.section;
                    const originalTitle = sectionTitle;
                    const sectionId = sectionTitle.replace(/[^a-zA-Z0-9]/g, '-');

                    let controls = '';
                    if(sectionTitle.toLowerCase().includes('abstrak')) {
                        controls = `<select id="manual-abstract-lang" class="ml-auto text-xs p-1 border-slate-400 dark:border-slate-500 bg-white dark:bg-slate-600 rounded-md shadow-sm">
                                        <option value="Bahasa Indonesia">ID</option>
                                        <option value="Bahasa Inggris">EN</option>
                                        <option value="Keduanya (Indonesia & Inggris)">ID & EN</option>
                                    </select>`;
                    }

                    const isBab5 = sectionTitle.includes('Bab 5');
                    if (!includeBab5 && isBab5) return; // Skip Bab 5 if not included

                    ui.manualSectionsContainer.innerHTML += `<div class="flex items-center p-2 bg-white dark:bg-slate-700/50 rounded-md border border-slate-200 dark:border-slate-600 ${isBab5 ? 'hidden bab5-item' : ''}"><input type="checkbox" class="section-check h-4 w-4 text-teal-500 rounded bg-slate-200 dark:bg-slate-600 border-slate-400 dark:border-slate-500" data-section-title="${sectionTitle}" data-original-title="${originalTitle}" checked><label class="ml-3 text-slate-700 dark:text-slate-200">${sectionTitle}</label>${controls}</div>`;

                    if (sectionTitle.startsWith('Bab') || all_main_sections.includes(originalTitle) || all_main_sections.includes(sectionTitle)) {
                        hasMainContent = true;
                        ui.manualCustomPromptsWrapper.innerHTML += `<div id="prompt-container-${sectionId}" class="custom-prompt-item"><label for="prompt-${sectionId}" class="text-sm font-medium text-slate-600 dark:text-slate-300">Instruksi ${sectionTitle}:</label><textarea id="prompt-${sectionId}" rows="2" class="w-full text-sm p-2 mt-1 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" placeholder="Opsional..."></textarea></div>`;
                    }
                });
                ui.manualCustomPromptsContainer.classList.toggle('hidden', !hasMainContent);
                document.querySelectorAll('#manual-sections-container .section-check').forEach(checkbox => checkbox.addEventListener('change', () => {
                    const sectionId = checkbox.dataset.sectionTitle.replace(/[^a-zA-Z0-9]/g, '-');
                    const promptContainer = document.getElementById(`prompt-container-${sectionId}`);
                    if(promptContainer) promptContainer.classList.toggle('hidden', !checkbox.checked);
                }));
            }
            
            // --- MAIN GENERATION FUNCTIONS ---
            async function handleGeneration() {
                if (ui.generateBtn.disabled) return;
                const topic = document.getElementById('topik').value.trim();
                if (!topic) {
                    alert("Topik utama tidak boleh kosong.");
                    return;
                }
                const apiKey = getActiveApiKey();
                if (!apiKey) {
                    alert("Kunci API tidak valid. Silakan periksa Pengaturan.");
                    return;
                }
                ui.generateBtn.disabled = true;
                resetStateAndUI();
                ui.placeholder.classList.add('hidden');

                try {
                    if (document.getElementById('generation-mode').value === 'manual') {
                        await startManualGeneration();
                    } else {
                        await generateDocument_Otomatis();
                    }
                } catch (error) {
                    console.error("An error occurred during generation:", error);
                    alert("Terjadi kesalahan saat generate. Silakan coba lagi.");
                } finally {
                    ui.generateBtn.disabled = false;
                }
            }

            async function startManualGeneration() {
                const allSelectedSections = Array.from(document.querySelectorAll('#manual-sections-container .section-check:checked')).map(cb => cb.dataset.sectionTitle);
                if (allSelectedSections.length === 0) {
                    alert("Pilih minimal satu bagian untuk dibuat.");
                    return;
                }
                appState.toc = allSelectedSections;
                appState.generatedMain = new Set();
                const mainContentSections = allSelectedSections.filter(title => all_main_sections.includes(title));
                const otherSections = allSelectedSections.filter(title => !all_main_sections.includes(title));

                // Sort mainContentSections by predefined order
                const sectionOrder = ['Judul', 'Halaman Pengesahan', 'Abstrak', 'Kata Pengantar', 'Daftar Isi', 'Daftar Tabel', 'Daftar Gambar', 'Bab 1 Pendahuluan', 'Bab 2 Kajian Pustaka', 'Bab 3 Metodologi Penelitian', 'Bab 4 Hasil dan Pembahasan', 'Bab 5 Penutup', 'Daftar Pustaka', 'Lampiran'];
                mainContentSections.sort((a, b) => sectionOrder.indexOf(a) - sectionOrder.indexOf(b));

                let html = `<div class="p-4 border border-slate-200 dark:border-slate-700 rounded-lg bg-slate-50 dark:bg-slate-900/50"><h3 class="font-bold mb-3 text-slate-800 dark:text-slate-200" data-translate-key="manualStepTitle"></h3><p class="text-sm text-slate-500 dark:text-slate-400 mb-4" data-translate-key="manualStepSubtitle"></p><div id="manual-buttons-container" class="space-y-2">`;
                mainContentSections.forEach((title, index) => {
                    const disabled = index > 0 ? 'disabled' : '';
                    html += `<button data-section-title="${title}" class="manual-generate-btn w-full text-left p-3 bg-white dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-md text-sm font-medium flex items-center justify-between transition-all duration-200 border border-slate-200 dark:border-slate-600 ${disabled}" ${disabled}><span class="flex items-center gap-3"><i data-lucide="circle" class="w-4 h-4 text-slate-400 status-icon"></i><span>${title}</span></span><span class="loader-spot"></span></button>`;
                });
                html += `</div><button id="manual-finalize-btn" disabled class="w-full mt-4 bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-teal-700 disabled:bg-slate-500 dark:disabled:bg-slate-600 disabled:cursor-not-allowed flex items-center justify-center gap-2"><i data-lucide="wand-2" class="w-5 h-5"></i><span>${translations[appSettings.language].manualFinalizeBtn} (${otherSections.length} ${translations[appSettings.language].manualPartsRemaining})</span></button><div id="manual-preview-container" class="mt-4 space-y-4"></div></div>`;
                
                ui.contentContainer.innerHTML = html;
                applyLanguage(appSettings.language);
                lucide.createIcons();
                document.querySelectorAll('.manual-generate-btn').forEach(btn => btn.addEventListener('click', generateSingleManualSection));
                document.getElementById('manual-finalize-btn').addEventListener('click', finalizeManualDocument);
            }
            
            async function generateSingleManualSection(event) {
                const button = event.currentTarget;
                const title = button.dataset.sectionTitle;
                const icon = button.querySelector('.status-icon');
                const loaderSpot = button.querySelector('.loader-spot');
                
                button.disabled = true;
                if(icon) icon.style.display = 'none';
                
                loaderSpot.innerHTML = `<div class="w-4 h-4 border-2 border-t-teal-400 border-slate-500 rounded-full animate-spin"></div>`;

                const effectiveDocType = getEffectiveDocType();
                const maxYear = document.getElementById('max-year').value;
                const minYear = document.getElementById('min-year').value;
                const researchType = Array.from(document.querySelectorAll('#research-type-container input:checked')).map(cb => cb.value).join(', ');
                const country = document.getElementById('research-country').value;
                let prompt = `Topik utama: "${document.getElementById('topik').value}". Buat konten untuk bagian "${title}" dari sebuah dokumen "${effectiveDocType}". Gunakan referensi penelitian dari tahun ${minYear} hingga ${maxYear} dari negara ${country}, jenis penelitian ${researchType}.`;
                if (title.toLowerCase().includes('abstrak')) { prompt += getAbstractLanguagePrompt(); }
                const customPrompt = document.getElementById(`prompt-${title.replace(/[^a-zA-Z0-9]/g, '-')}`)?.value || '';
                if(customPrompt) prompt += `\nInstruksi tambahan: "${customPrompt}"`;
                const existingContentContext = Object.entries(appState.content).map(([key, value]) => `Bagian ${key}:\n${value.substring(0, 150)}...`).join('\n');
                if (existingContentContext) prompt += `\nKonteks dari bagian yang sudah ada:\n${existingContentContext}`;

                const markdownContent = await callGeminiAPI(prompt);
                appState.content[title] = markdownContent;
                appState.generatedMain.add(title);
                
                loaderSpot.innerHTML = '';
                const currentIcon = button.querySelector('.status-icon');
                if (currentIcon) {
                    const newIcon = document.createElement('i');
                    newIcon.setAttribute('data-lucide', 'check-circle-2');
                    newIcon.className = 'w-4 h-4 text-green-400 status-icon';
                    currentIcon.replaceWith(newIcon);
                    lucide.createIcons();
                }

                button.classList.replace('dark:bg-slate-700', 'dark:bg-slate-800');

                // Enable next button
                const buttons = document.querySelectorAll('.manual-generate-btn');
                const currentIndex = Array.from(buttons).findIndex(btn => btn.dataset.sectionTitle === title);
                if (currentIndex < buttons.length - 1) {
                    buttons[currentIndex + 1].disabled = false;
                }

                // Add preview card
                const previewContainer = document.getElementById('manual-preview-container');
                const card = document.createElement('div');
                card.className = 'section-card p-4 bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 animate-fade-in';
                card.innerHTML = `<h3 class="font-bold mb-2 text-slate-800 dark:text-slate-200">${title}</h3><div class="prose-output text-sm">${marked.parse(markdownContent)}</div>`;
                previewContainer.appendChild(card);
                
                const mainContentButtons = Array.from(document.querySelectorAll('.manual-generate-btn'));
                if (mainContentButtons.every(b => b.disabled)) {
                    document.getElementById('manual-finalize-btn').disabled = false;
                }
            }
            
            async function finalizeManualDocument() {
                const finalizeBtn = document.getElementById('manual-finalize-btn');
                finalizeBtn.disabled = true;
                finalizeBtn.innerHTML = `<div class="w-5 h-5 border-2 border-t-white border-slate-400 rounded-full animate-spin"></div><span>${translations[appSettings.language].loaderFinalizing}</span>`;

                const otherSections = appState.toc.filter(title => !all_main_sections.includes(title));
                if (otherSections.length > 0) {
                    const fullMainContent = Object.entries(appState.content).map(([title, content]) => `# ${title}\n${content}`).join('\n\n---\n\n');
                    const citationsPrompt = document.getElementById('include-citations').checked ? `Buat juga bagian Daftar Pustaka berdasarkan sitasi di konten utama, gaya ${document.getElementById('gaya_sitasi').value}.` : '';
                    const effectiveDocType = getEffectiveDocType();
                    const maxYear = document.getElementById('max-year').value;
                    const minYear = document.getElementById('min-year').value;
                    const researchType = Array.from(document.querySelectorAll('#research-type-container input:checked')).map(cb => cb.value).join(', ');
                    const country = document.getElementById('research-country').value;
                    let prompt = `Berdasarkan konten utama berikut:\n\n${fullMainContent}\n\n---\nBuat bagian pelengkap ini: ${otherSections.join(', ')}. Gunakan referensi penelitian dari tahun ${minYear} hingga ${maxYear} dari negara ${country}, jenis penelitian ${researchType}. ${citationsPrompt}. Mulai SETIAP bagian dengan '# Judul Bagian'.`;
                    if (otherSections.some(s => s.toLowerCase().includes('abstrak'))) prompt += getAbstractLanguagePrompt();
                    
                    const additionalContent = await callGeminiAPI(prompt);
                    const sections = additionalContent.split(/^#\s/m).filter(s => s.trim());
                    sections.forEach(section => {
                        const lines = section.trim().split('\n');
                        const title = lines.shift().trim();
                        const content = lines.join('\n').trim();
                        appState.content[title] = content;
                    });
                }
                
                ui.contentContainer.innerHTML = '';
                appState.toc.forEach(title => {
                    const content = appState.content[title];
                    if (content) {
                    const card = document.createElement('div');
                    card.className = 'section-card p-4 bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 animate-fade-in';
                    card.innerHTML = `<h3 class="font-bold mb-2 text-slate-800 dark:text-slate-200">${title}</h3><div class="prose-output">${marked.parse(content)}</div><div class="mt-4 flex flex-wrap gap-2"><button class="regenerate-btn px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">Generate Ulang</button><button class="paraphrase-btn px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600">Parafrase</button><button class="paraphrase-bullet-btn px-3 py-1 bg-purple-500 text-white rounded text-sm hover:bg-purple-600">Parafrase Bullet</button><button class="select-all-btn px-3 py-1 bg-orange-500 text-white rounded text-sm hover:bg-orange-600">Pilih Semua</button><button class="auto-image-btn px-3 py-1 bg-cyan-600 text-white rounded text-sm hover:bg-cyan-700" data-section="${title}">Cari Foto Otomatis</button><button class="auto-table-btn px-3 py-1 bg-amber-600 text-white rounded text-sm hover:bg-amber-700" data-section="${title}">Buat Tabel Otomatis</button></div><div class="auto-media mt-3"></div>`;
                    ui.contentContainer.appendChild(card);

                    // Add event listeners for new buttons
                    card.querySelector('.select-all-btn').addEventListener('click', () => {
                        const section = card;
                        const range = document.createRange();
                        range.selectNodeContents(section);
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                    });

                    card.querySelector('.paraphrase-bullet-btn').addEventListener('click', async () => {
                        const proseOutput = card.querySelector('.prose-output');
                        const text = proseOutput.textContent;
                        ui.loader.classList.remove('hidden');
                        ui.loaderText.textContent = 'Memperbanyak kata...';
                        const prompt = `Parafrase teks berikut menjadi poin-poin bullet yang ringkas dan jelas: ${text}`;
                        const newText = await callGeminiAPI(prompt);
                        ui.loader.classList.add('hidden');
                        proseOutput.innerHTML = marked.parse(newText);
                    });
                    }
                });
                ui.exportButtons.classList.remove('hidden');
            }

            async function generateDocument_Otomatis() {
                ui.loaderText.textContent = translations[appSettings.language].loaderCreating;
                ui.loader.classList.remove('hidden');

                const docType = document.getElementById('jenis-dokumen').value;
                const effectiveDocType = getEffectiveDocType();
                const includeBab5 = document.getElementById('include-bab5').checked;
                const includeLampiran = document.getElementById('include-lampiran').checked;
                const maxYear = document.getElementById('max-year').value;
                const minYear = document.getElementById('min-year').value;
                const researchType = Array.from(document.querySelectorAll('#research-type-container input:checked')).map(cb => cb.value).join(', ');
                const country = document.getElementById('research-country').value;
                let structure = doc_structures[docType].structure.filter(s => includeBab5 || !s.includes('Bab 5'));
                if (includeLampiran) {
                    const daftarIsiIndex = structure.findIndex(s => s.includes('Daftar Isi'));
                    if (daftarIsiIndex > -1) {
                        structure.splice(daftarIsiIndex + 1, 0, 'Daftar Lampiran');
                    } else {
                        structure.push('Daftar Lampiran');
                    }
                    structure.push('Lampiran');
                }
                const prompt = `Buat draf lengkap sebuah dokumen "${effectiveDocType}" mengenai topik: "${document.getElementById('topik').value}". Ikuti struktur ini: ${structure.join(', ')}. Mulai SETIAP bagian dengan heading level 1 yang persis sama dengan judul dalam struktur, contoh: '# Bab 1 Pendahuluan'. Gunakan referensi penelitian dari tahun ${minYear} hingga ${maxYear} dari negara ${country}, jenis penelitian ${researchType}. ${document.getElementById('include-citations').checked ? `Sertakan sitasi gaya ${document.getElementById('gaya_sitasi').value} dan Daftar Pustaka.` : 'Jangan sertakan sitasi.'} ${!includeBab5 ? 'Karena Bab 5 tidak disertakan, sesuaikan konten Bab 1-4 agar mencakup kesimpulan atau penutup di Bab 4.' : ''}`;

                const fullMarkdown = await callGeminiAPI(prompt);
                const sections = fullMarkdown.split(/^#\s/m).filter(s => s.trim());
                if (sections.length === 0 && fullMarkdown.trim()) {
                    sections.push("Generated Content\n" + fullMarkdown);
                }

                sections.forEach(section => {
                    const lines = section.trim().split('\n');
                    const title = lines.shift().trim();
                    const content = lines.join('\n').trim();
                    appState.content[title] = content;
                    appState.toc.push(title);

                    const card = document.createElement('div');
                    card.className = 'section-card p-4 bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 animate-fade-in mb-4';
                    card.dataset.sectionTitle = title;
                    card.innerHTML = `
                        <h3 class="font-bold mb-2 text-slate-800 dark:text-slate-200">${title}</h3>
                        <div class="prose-output mb-3" id="content-${title.replace(/[^a-zA-Z0-9]/g, '-')}">${marked.parse(content)}</div>
                        <div class="flex flex-wrap gap-2">
                            <button class="regenerate-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm" data-section="${title}">Generate Ulang</button>
                            <button class="paraphrase-btn bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm" data-section="${title}">Parafrase</button>
                            <button class="expand-btn bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded text-sm" data-section="${title}">Perbanyak Kata</button>
                            <button class="auto-image-btn bg-cyan-600 hover:bg-cyan-700 text-white px-3 py-1 rounded text-sm" data-section="${title}">Cari Foto Otomatis</button>
                            <button class="auto-table-btn bg-amber-600 hover:bg-amber-700 text-white px-3 py-1 rounded text-sm" data-section="${title}">Buat Tabel Otomatis</button>
                        </div>
                        <div class="auto-media mt-3"></div>
                    `;
                    ui.contentContainer.appendChild(card);
                });

                // Add event listeners for section buttons
                ui.contentContainer.addEventListener('click', async (e) => {
                    if (e.target.classList.contains('regenerate-btn')) {
                        const sectionTitle = e.target.dataset.section;
                        await regenerateSection(sectionTitle);
                    } else if (e.target.classList.contains('paraphrase-btn')) {
                        const sectionTitle = e.target.dataset.section;
                        await paraphraseSection(sectionTitle);
                    } else if (e.target.classList.contains('expand-btn')) {
                        const sectionTitle = e.target.dataset.section;
        const numParts = prompt('Bagi menjadi berapa bagian? (1-10):');
        if (numParts && !isNaN(numParts) && numParts >= 1 && numParts <= 10) {
            await expandSection(sectionTitle, parseInt(numParts));
        }
                    }
                });

                ui.loader.classList.add('hidden');
                ui.exportButtons.classList.remove('hidden');
            }

            async function regenerateSection(sectionTitle) {
                try {
                    const currentContent = appState.content[sectionTitle];
                    const prompt = `Buat ulang bagian ini dengan konten yang lebih baik dan lebih lengkap: "${currentContent}"`;
                    const newContent = await callGeminiAPI(prompt);
                    appState.content[sectionTitle] = newContent;
                    // Update the UI
                    const card = Array.from(document.querySelectorAll('.section-card')).find(card => card.querySelector('h3').textContent.trim() === sectionTitle);
                    const proseOutput = card.querySelector('.prose-output');
                    proseOutput.innerHTML = marked.parse(newContent);
                } catch (e) {
                    alert('Error regenerating section: ' + e.message);
                }
            }

            async function paraphraseSection(sectionTitle) {
                const content = appState.content[sectionTitle];
                if (!content) {
                    alert('Konten tidak ditemukan.');
                    return;
                }
                ui.loaderText.textContent = `Memparafrase ${sectionTitle}...`;
                ui.loader.classList.remove('hidden');
                const prompt = `Parafrase teks berikut dengan kata-kata sendiri, jaga makna asli dan struktur akademis: ${content}`;
                const newContent = await callGeminiAPI(prompt);
                const sectionId = sectionTitle.replace(/[^a-zA-Z0-9]/g, '-');
                const contentDiv = document.getElementById(`content-${sectionId}`);
                if (contentDiv) {
                    contentDiv.innerHTML = marked.parse(newContent);
                    appState.content[sectionTitle] = newContent;
                }
                ui.loader.classList.add('hidden');
            }

            async function expandSection(sectionTitle, numParts) {
                const content = appState.content[sectionTitle];
                if (!content) {
                    alert('Konten tidak ditemukan.');
                    return;
                }
                ui.loaderText.textContent = `Membuat ringkasan dan ${numParts} bagian...`;
                ui.loader.classList.remove('hidden');
                // Generate summary
                const summaryPrompt = `Ringkas teks ini dalam beberapa poin utama: ${content}`;
                const summary = await callGeminiAPI(summaryPrompt);
                // Generate N expanded parts
                const parts = [];
                for (let i = 1; i <= numParts; i++) {
                    const partPrompt = `Ringkasan: "${summary}". Buat bagian ${i} dari ${numParts} yang merupakan perluasan lengkap dari ringkasan ini dengan detail akademis, struktur yang baik, dan contoh jika diperlukan.`;
                    const part = await callGeminiAPI(partPrompt);
                    parts.push(part);
                }
                // Update UI
                const card = Array.from(document.querySelectorAll('.section-card')).find(card => card.querySelector('h3').textContent.trim() === sectionTitle);
                const proseOutput = card.querySelector('.prose-output');
                proseOutput.innerHTML = `<div class="summary mb-4"><strong>Ringkasan:</strong> ${marked.parse(summary)}</div>`;
                const partsContainer = document.createElement('div');
                partsContainer.className = 'parts-container';
                parts.forEach((part, index) => {
                    const partDiv = document.createElement('div');
                    partDiv.className = 'part mb-4 p-2 border rounded';
                    partDiv.innerHTML = `<h4>Bagian ${index + 1}</h4>${marked.parse(part)}`;
                    partsContainer.appendChild(partDiv);
                });
                proseOutput.appendChild(partsContainer);
                const combineBtn = document.createElement('button');
                combineBtn.className = 'bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm mt-4';
                combineBtn.textContent = 'Gabungkan Semua';
                combineBtn.addEventListener('click', () => {
                    const combined = summary + '\n\n' + parts.join('\n\n');
                    appState.content[sectionTitle] = combined;
                    proseOutput.innerHTML = marked.parse(combined);
                });
                proseOutput.appendChild(combineBtn);
                ui.loader.classList.add('hidden');
            }

            function parseInline(text) {
                const boldRegex = /\*\*(.*?)\*\*/g;
                const parts = [];
                let lastIndex = 0;
                let match;
                while ((match = boldRegex.exec(text)) !== null) {
                    if (match.index > lastIndex) {
                        parts.push(new TextRun({ text: text.substring(lastIndex, match.index) }));
                    }
                    parts.push(new TextRun({ text: match[1], bold: true }));
                    lastIndex = match.index + match[0].length;
                }
                if (lastIndex < text.length) {
                    parts.push(new TextRun({ text: text.substring(lastIndex) }));
                }
                return parts.length > 0 ? parts : [new TextRun({ text })];
            }

            async function createWordFromContent(title = null) {
                if (Object.keys(appState.content).length === 0) {
                    alert('Tidak ada konten untuk dibuat Word. Silakan generate dokumen terlebih dahulu.');
                    return;
                }
                if (!title) {
                    title = prompt('Masukkan judul untuk file Word:');
                }
                if (!title) return;
                const orderedContent = appState.toc.map(title => `# ${title}\n\n${appState.content[title]}`).join('\n\n');
                const docx = await import('https://cdn.jsdelivr.net/npm/docx@8.0.1/+esm');
                const { Document, Packer, Paragraph, TextRun } = docx;
                const doc = new Document({
                    sections: [{
                        children: [new Paragraph({ children: [new TextRun(orderedContent)] })]
                    }]
                });
                const blob = await Packer.toBlob(doc);
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.docx`;
                link.click();
            }

            function buildExportHtml() {
                let htmlContent = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Dokumen AutoBab</title><style>body { font-family: Arial, sans-serif; margin: 40px; } h1 { font-size: 18pt; font-weight: bold; margin-top: 24pt; page-break-before: always; } h2 { font-size: 14pt; font-weight: bold; margin-top: 18pt; } p { margin-bottom: 12pt; line-height: 1.5; } ul, ol { margin-bottom: 12pt; } table { border-collapse: collapse; width: 100%; margin: 12pt 0; } td, th { border: 1px solid #666; padding: 6px; }</style></head><body>';
                for (const title of appState.toc) {
                    const content = appState.content[title] || '';
                    htmlContent += `<h1>${title}</h1><div>${marked.parse(content)}</div>`;
                }
                htmlContent += '</body></html>';
                return htmlContent;
            }

            function downloadPdfFromContent() {
                if (Object.keys(appState.content).length === 0) {
                    alert('Tidak ada konten untuk diekspor PDF.');
                    return;
                }
                const printWindow = window.open('', '_blank');
                if (!printWindow) {
                    alert('Popup diblokir browser. Izinkan popup untuk download PDF.');
                    return;
                }
                printWindow.document.open();
                printWindow.document.write(buildExportHtml());
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => printWindow.print(), 500);
            }

            async function openDocumentFile(file) {
                if (!file) return;
                const ext = (file.name.split('.').pop() || '').toLowerCase();
                try {
                    let importedText = '';
                    if (ext === 'docx') {
                        const buffer = await file.arrayBuffer();
                        if (window.mammoth) {
                            const result = await window.mammoth.extractRawText({ arrayBuffer: buffer });
                            importedText = result.value || '';
                        } else {
                            importedText = '[Parser DOCX tidak tersedia di browser ini]';
                        }
                    } else {
                        importedText = await file.text();
                    }

                    const sectionTitle = `Dokumen Dibuka: ${file.name}`;
                    appState.content[sectionTitle] = importedText;
                    if (!appState.toc.includes(sectionTitle)) appState.toc.unshift(sectionTitle);

                    const card = document.createElement('div');
                    card.className = 'section-card p-4 bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 animate-fade-in mb-4';
                    card.dataset.sectionTitle = sectionTitle;
                    card.innerHTML = `<h3 class="font-bold mb-2 text-slate-800 dark:text-slate-200">${sectionTitle}</h3><div class="prose-output">${marked.parse(importedText || '(kosong)')}</div>`;
                    ui.placeholder.classList.add('hidden');
                    ui.contentContainer.prepend(card);
                    ui.exportButtons.classList.remove('hidden');
                } catch (err) {
                    console.error('Open document error:', err);
                    alert('Gagal membuka dokumen: ' + err.message);
                }
            }

            function copyAllContent() {
                if (Object.keys(appState.content).length === 0) {
                    alert('Tidak ada konten untuk disalin.');
                    return;
                }
                const orderedContent = appState.toc.map(title => `# ${title}\n\n${appState.content[title]}`).join('\n\n');
                navigator.clipboard.writeText(orderedContent).then(() => {
                    const feedback = document.getElementById('copy-feedback');
                    feedback.classList.remove('hidden');
                    setTimeout(() => feedback.classList.add('hidden'), 2000);
                }).catch(err => {
                    alert('Gagal menyalin teks: ' + err);
                });
            }

            async function searchImageForSection(sectionTitle, card) {
                const target = card.querySelector('.auto-media');
                if (!target) return;
                let imageSlot = target.querySelector('.auto-image-slot');
                if (!imageSlot) {
                    imageSlot = document.createElement('div');
                    imageSlot.className = 'auto-image-slot';
                    target.prepend(imageSlot);
                }
                imageSlot.innerHTML = '<p class="text-xs text-slate-500">Mencari foto otomatis...</p>';
                try {
                    const openSearch = await fetch(`https://id.wikipedia.org/w/api.php?action=opensearch&search=${encodeURIComponent(sectionTitle)}&limit=1&namespace=0&format=json&origin=*`);
                    const openData = await openSearch.json();
                    const title = openData?.[1]?.[0] || sectionTitle;
                    const summaryRes = await fetch(`https://id.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`);
                    const summary = await summaryRes.json();
                    if (summary.thumbnail?.source) {
                        imageSlot.innerHTML = `<figure class="rounded-lg overflow-hidden border border-slate-300 dark:border-slate-600"><img src="${summary.thumbnail.source}" alt="${title}" class="w-full max-h-64 object-cover"/><figcaption class="text-xs p-2 bg-slate-100 dark:bg-slate-700">Foto otomatis: ${title}</figcaption></figure><p class="text-xs text-slate-500">Sumber data: Wikipedia (${summary.description || 'ringkasan topik'})</p>`;
                    } else {
                        imageSlot.innerHTML = '<p class="text-xs text-amber-600">Foto tidak ditemukan otomatis untuk topik ini.</p>';
                    }
                } catch (e) {
                    imageSlot.innerHTML = `<p class="text-xs text-rose-600">Gagal mencari foto: ${e.message}</p>`;
                }
            }

            function buildAutoTableFromContent(sectionTitle, card) {
                const target = card.querySelector('.auto-media');
                if (!target) return;
                let tableSlot = target.querySelector('.auto-table-slot');
                if (!tableSlot) {
                    tableSlot = document.createElement('div');
                    tableSlot.className = 'auto-table-slot mt-2';
                    target.appendChild(tableSlot);
                }
                const content = appState.content[sectionTitle] || '';
                const sentences = content.split(/[.!?]\s+/).filter(Boolean).slice(0, 5);
                if (!sentences.length) {
                    tableSlot.innerHTML = '<p class="text-xs text-amber-600">Tidak ada data teks yang cukup untuk membuat tabel.</p>';
                    return;
                }
                const rows = sentences.map((s, idx) => {
                    const words = s.trim().split(/\s+/).filter(Boolean);
                    return {
                        no: idx + 1,
                        indikator: words.slice(0, 5).join(' '),
                        jumlahKata: words.length,
                        ringkasan: words.slice(0, 12).join(' ')
                    };
                });
                const tableRows = rows.map(r => `<tr><td class="border p-2">${r.no}</td><td class="border p-2">${r.indikator}</td><td class="border p-2 text-center">${r.jumlahKata}</td><td class="border p-2">${r.ringkasan}</td></tr>`).join('');
                const dataRows = rows.map(r => `<li>No ${r.no}: indikator <strong>${r.indikator}</strong>, jumlah kata ${r.jumlahKata}, ringkasan ${r.ringkasan}</li>`).join('');
                tableSlot.innerHTML = `<div class="overflow-x-auto"><table class="w-full text-xs border-collapse border border-slate-300 dark:border-slate-600"><thead><tr class="bg-slate-100 dark:bg-slate-700"><th class="border p-2">No</th><th class="border p-2">Indikator</th><th class="border p-2">Jumlah Kata</th><th class="border p-2">Ringkasan Data</th></tr></thead><tbody>${tableRows}</tbody></table></div><div class="mt-2 text-xs"><p class="font-semibold">Data di bawah tabel:</p><ul class="list-disc ml-5">${dataRows}</ul></div>`;
            }

            const localParaphraseStrategies = {
                'logic-1': (t) => t.replace(/\b(dan)\b/gi, 'serta').replace(/\badalah\b/gi, 'merupakan'),
                'logic-2': (t) => t.split(/[.!?]/).map(x=>x.trim()).filter(Boolean).slice(0,2).join('. ') + '.',
                'logic-3': (t) => `${t} Selain itu, implikasi praktis dari temuan ini perlu diperhatikan secara lebih mendalam.`,
                'logic-4': (t) => `Teks ini menekankan relasi sebab-akibat: ${t}`,
                'logic-5': (t) => `Secara definisi, ${t} Contoh implementasinya dapat diamati pada konteks akademik dan industri.`,
                'logic-6': (t) => `Permasalahan utama yang diangkat adalah: ${t} Solusi yang disarankan ialah pendekatan bertahap berbasis data.`,
                'logic-7': (t) => `Jika dibandingkan dengan pendekatan konvensional, ${t} menunjukkan perbedaan yang signifikan.`,
                'logic-8': (t) => `Secara kronologis, tahap awal dimulai dari identifikasi isu, dilanjutkan analisis, lalu evaluasi: ${t}`,
                'logic-9': (t) => t.replace(/\bdi lakukan\b/gi, 'dilaksanakan').replace(/\bbisa\b/gi, 'dapat'),
                'logic-10': (t) => `- Poin 1: ${t}
- Poin 2: Validasi data
- Poin 3: Evaluasi hasil
- Poin 4: Rekomendasi lanjutan`
            };

            async function getBestTensorflowParaphrase(text) {
                try {
                    if (!window.use) return localParaphraseStrategies['logic-1'](text);
                    const model = await window.use.load();
                    const candidates = Object.values(localParaphraseStrategies).map(fn => fn(text));
                    const vectors = await model.embed([text, ...candidates]).array();
                    const base = vectors[0];
                    const cosine = (a, b) => {
                        let dot = 0, na = 0, nb = 0;
                        for (let i = 0; i < a.length; i++) {
                            dot += a[i] * b[i];
                            na += a[i] * a[i];
                            nb += b[i] * b[i];
                        }
                        return dot / ((Math.sqrt(na) * Math.sqrt(nb)) || 1);
                    };
                    let bestIdx = 0;
                    let bestScore = -Infinity;
                    candidates.forEach((candidate, idx) => {
                        const score = cosine(base, vectors[idx + 1]);
                        if (score > bestScore && candidate !== text) {
                            bestScore = score;
                            bestIdx = idx;
                        }
                    });
                    return candidates[bestIdx];
                } catch (e) {
                    console.warn('TF paraphrase fallback:', e);
                    return localParaphraseStrategies['logic-1'](text);
                }
            }

            async function runAdvancedParaphrase(selectedText) {
                const logic = document.getElementById('paraphrase-logic-select')?.value || 'ai';
                if (logic === 'ai') return null;
                if (logic === 'tf-auto') return await getBestTensorflowParaphrase(selectedText);
                const fn = localParaphraseStrategies[logic] || localParaphraseStrategies['logic-1'];
                return fn(selectedText);
            }

            const publicApiCatalog = [
                { key: 'wiki', name: 'Wikipedia', region: 'global' },
                { key: 'wikidata', name: 'Wikidata', region: 'global' },
                { key: 'openlibrary', name: 'OpenLibrary', region: 'global' },
                { key: 'crossref', name: 'CrossRef', region: 'global' },
                { key: 'worldbank', name: 'WorldBank', region: 'global' },
                { key: 'restcountries', name: 'RestCountries', region: 'global' },
                { key: 'myquran', name: 'MyQuran', region: 'indonesia' },
                { key: 'apiwilayah', name: 'API Wilayah Indonesia', region: 'indonesia' },
                { key: 'sekolahid', name: 'Sekolah Indonesia', region: 'indonesia' },
                { key: 'cuacaindo', name: 'BMKG Gempa', region: 'indonesia' },
            ];

            async function extractKeywordsTf(text) {
                const clean = (text || '').toLowerCase().replace(/[^a-zA-Z0-9\s]/g, ' ');
                const words = clean.split(/\s+/).filter(w => w.length > 3);
                const freq = {};
                words.forEach(w => freq[w] = (freq[w] || 0) + 1);
                const ranked = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,8).map(([w]) => w);
                if (window.use && words.length > 6) {
                    try {
                        const model = await window.use.load();
                        await model.embed([text.substring(0, 500)]);
                    } catch (_) {}
                }
                return ranked;
            }

            function localHeuristicSummary(text) {
                const sentences = (text || '').split(/(?<=[.!?])\s+/).filter(Boolean);
                if (!sentences.length) return 'Tidak ada teks untuk diringkas.';
                return sentences.slice(0, 3).join(' ');
            }

            function localHeuristicAnalysis(text) {
                const tokens = (text || '').toLowerCase().split(/\s+/).filter(Boolean);
                const unique = new Set(tokens);
                const sentenceCount = (text || '').split(/[.!?]+/).filter(Boolean).length;
                const top = Object.entries(tokens.reduce((a, w) => (a[w] = (a[w] || 0) + 1, a), {}))
                    .sort((a, b) => b[1] - a[1]).slice(0, 8).map(([w]) => w);
                return {
                    words: tokens.length,
                    unique: unique.size,
                    sentences: sentenceCount,
                    top
                };
            }

            async function runLocalOfflineAI(mode = 'summary') {
                const baseText = `${document.getElementById('topik').value.trim()} ${getPlainTextFromEditor()}`.trim();
                if (!baseText) {
                    appendSupportMessage('AI Lokal', 'Tidak ada teks untuk diproses.');
                    return;
                }
                const keywords = await extractKeywordsTf(baseText);

                if (mode === 'analysis') {
                    const stats = localHeuristicAnalysis(baseText);
                    appendSupportMessage('AI Analisis Lokal (Offline)', `Jumlah kata: <strong>${stats.words}</strong><br>Unik: <strong>${stats.unique}</strong><br>Kalimat: <strong>${stats.sentences}</strong><br>Keyword utama: ${stats.top.join(', ') || '-'}<br>Keyword TF: ${keywords.join(', ') || '-'}`);
                    return;
                }

                let summary = localHeuristicSummary(baseText);
                try {
                    // Offline-first attempt: works only if model already cached locally.
                    const tr = await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2');
                    if (tr?.pipeline) {
                        const summarizer = await tr.pipeline('summarization', 'Xenova/distilbart-cnn-6-6', { local_files_only: true });
                        const out = await summarizer(baseText.slice(0, 1600), { max_length: 140, min_length: 40 });
                        if (Array.isArray(out) && out[0]?.summary_text) summary = out[0].summary_text;
                    }
                } catch (_) {
                    // Keep heuristic summary when model not cached/offline unavailable.
                }
                appendSupportMessage('AI Summary Lokal (Offline)', `${summary}<br><br><strong>Keyword TF:</strong> ${keywords.join(', ') || '-'}`);
            }

            async function fetchApiData(source, keyword) {
                if (source === 'wiki') {
                    const r = await fetch(`https://id.wikipedia.org/w/api.php?action=opensearch&search=${encodeURIComponent(keyword)}&limit=3&namespace=0&format=json&origin=*`);
                    const d = await r.json();
                    return (d?.[1] || []).map((x, i) => ({ title: x, desc: d?.[2]?.[i] || '', link: d?.[3]?.[i] || '' }));
                }
                if (source === 'wikidata') {
                    const r = await fetch(`https://www.wikidata.org/w/api.php?action=wbsearchentities&search=${encodeURIComponent(keyword)}&language=id&format=json&origin=*`);
                    const d = await r.json();
                    return (d?.search || []).slice(0, 4).map(x => ({ title: x.label, desc: x.description || '', link: `https://www.wikidata.org/wiki/${x.id}` }));
                }
                if (source === 'openlibrary') {
                    const r = await fetch(`https://openlibrary.org/search.json?q=${encodeURIComponent(keyword)}&limit=5`);
                    const d = await r.json();
                    return (d?.docs || []).slice(0, 4).map(x => ({ title: x.title, desc: (x.author_name || []).join(', '), link: x.key ? `https://openlibrary.org${x.key}` : '' }));
                }
                if (source === 'crossref') {
                    const r = await fetch(`https://api.crossref.org/works?rows=4&query=${encodeURIComponent(keyword)}`);
                    const d = await r.json();
                    return (d?.message?.items || []).slice(0,4).map(x => ({ title: (x.title || [''])[0], desc: x.type || '', link: x.URL || '' }));
                }
                if (source === 'worldbank') {
                    const r = await fetch(`https://api.worldbank.org/v2/country/IDN/indicator/SP.POP.TOTL?format=json`);
                    const d = await r.json();
                    return (d?.[1] || []).slice(0,4).map(x => ({ title: `Populasi Indonesia ${x.date}`, desc: `Nilai: ${x.value || 'n/a'}`, link: 'https://data.worldbank.org/' }));
                }
                if (source === 'restcountries') {
                    const r = await fetch(`https://restcountries.com/v3.1/name/${encodeURIComponent(keyword)}?fields=name,capital,population,region`);
                    const d = await r.json();
                    return (Array.isArray(d) ? d : []).slice(0,4).map(x => ({ title: x?.name?.common || '-', desc: `Ibu kota: ${(x.capital||[]).join(', ')} | Pop: ${x.population || '-'}`, link: '' }));
                }
                if (source === 'myquran') {
                    const r = await fetch('https://api.myquran.com/v2/sholat/kota/semua');
                    const d = await r.json();
                    return (d?.data || []).slice(0,4).map(x => ({ title: x.lokasi, desc: `ID Kota: ${x.id}`, link: 'https://api.myquran.com/' }));
                }
                if (source === 'apiwilayah') {
                    const r = await fetch('https://www.emsifa.com/api-wilayah-indonesia/api/provinces.json');
                    const d = await r.json();
                    return (d || []).slice(0,4).map(x => ({ title: x.name, desc: `Kode provinsi: ${x.id}`, link: 'https://www.emsifa.com/' }));
                }
                if (source === 'sekolahid') {
                    const r = await fetch('https://api-sekolah-indonesia.vercel.app/sekolah/smk?page=1&perPage=4');
                    const d = await r.json();
                    return (d?.dataSekolah || []).slice(0,4).map(x => ({ title: x.sekolah, desc: `${x.kabupaten_kota || '-'} | ${x.propinsi || '-'}`, link: '' }));
                }
                if (source === 'cuacaindo') {
                    const r = await fetch('https://data.bmkg.go.id/DataMKG/TEWS/autogempa.json');
                    const d = await r.json();
                    const g = d?.Infogempa?.gempa;
                    return g ? [{ title: `Gempa ${g.Tanggal} ${g.Jam}`, desc: `${g.Magnitude} SR | ${g.Wilayah}`, link: 'https://data.bmkg.go.id/' }] : [];
                }
                return [];
            }

            async function runAutoResearch() {
                const topic = document.getElementById('topik').value.trim();
                const keywordBase = topic || 'Indonesia digital pendidikan';
                ui.supportResult.innerHTML = '<p>Memproses keyword TensorFlow & mencari data API publik...</p>';
                const keywords = await extractKeywordsTf(keywordBase);
                const selected = Array.from(ui.supportApiSource.selectedOptions).map(o => o.value);
                const targets = selected.length ? selected : publicApiCatalog.map(x => x.key);
                const rows = [];
                for (const source of targets) {
                    try {
                        const items = await fetchApiData(source, keywords[0] || keywordBase.split(' ')[0]);
                        items.forEach(it => rows.push({ source, ...it }));
                    } catch (e) {
                        rows.push({ source, title: 'Gagal fetch', desc: e.message, link: '' });
                    }
                }
                const topRows = rows.slice(0, 25);
                const table = topRows.map((r, i) => `<tr><td class="border p-1">${i+1}</td><td class="border p-1">${r.source}</td><td class="border p-1">${r.title || '-'}</td><td class="border p-1">${r.desc || '-'}</td></tr>`).join('');
                const supportData = topRows.map(r => `- [${r.source}] ${r.title}: ${r.desc}`).join('\n');
                const summaryPrompt = `Ringkas data berikut dalam 5 poin kesimpulan akademik singkat:
${supportData}`;
                const summary = ui.freeModeToggle.checked
                    ? `Mode FREE aktif. Keyword utama: ${keywords.join(', ')}. Sumber dominan: ${targets.join(', ')}.`
                    : await callGeminiAPI(summaryPrompt);
                ui.supportResult.innerHTML = `<p class="mb-1"><strong>Keyword TF:</strong> ${keywords.join(', ') || '-'}</p><div class="overflow-x-auto"><table class="w-full text-xs border-collapse border"><thead><tr><th class="border p-1">No</th><th class="border p-1">API</th><th class="border p-1">Judul Data</th><th class="border p-1">Deskripsi</th></tr></thead><tbody>${table}</tbody></table></div><p class="mt-2"><strong>Data pendukung lain:</strong></p><pre class="whitespace-pre-wrap text-[11px] bg-slate-50 dark:bg-slate-800 p-2 rounded">${supportData}</pre><p class="mt-2"><strong>Simpulan:</strong> ${summary}</p>`;
                ui.supportResult.dataset.lastSummary = summary;
                ui.supportResult.dataset.lastKeywords = keywords.join(', ');
            }

            function applyResearchToTopic() {
                const topicEl = document.getElementById('topik');
                const summary = ui.supportResult.dataset.lastSummary || '';
                const keywords = ui.supportResult.dataset.lastKeywords || '';
                if (!summary && !keywords) return;
                topicEl.value = `${topicEl.value.trim()}

[Support Keywords] ${keywords}
[Support Summary] ${summary}`.trim();
            }

            function openWordStudio() {
                const allContent = appState.toc.map(t => `<h1>${t}</h1><p>${(appState.content[t] || '').replace(/\n/g, '<br>')}</p>`).join('');
                ui.wordEditor.innerHTML = allContent || '<h1>Dokumen Baru</h1><p>Mulai mengetik di sini...</p>';
                ui.wordStudio.classList.remove('hidden');
            }

            function wordCmd(cmd, val = null) {
                ui.wordEditor.focus();
                document.execCommand(cmd, false, val);
            }

            function insertWordTable() {
                const html = `<table border="1" style="width:100%; border-collapse:collapse;"><tr><th>Kolom 1</th><th>Kolom 2</th></tr><tr><td>Data A</td><td>Data B</td></tr></table><p></p>`;
                wordCmd('insertHTML', html);
            }

            function syncWordToContent() {
                const html = ui.wordEditor.innerHTML;
                appState.content['Word Studio Draft'] = html.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
                if (!appState.toc.includes('Word Studio Draft')) appState.toc.unshift('Word Studio Draft');
                const existing = document.querySelector('[data-section-title="Word Studio Draft"]');
                if (!existing) {
                    const card = document.createElement('div');
                    card.className = 'section-card p-4 bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 animate-fade-in mb-4';
                    card.dataset.sectionTitle = 'Word Studio Draft';
                    card.innerHTML = `<h3 class="font-bold mb-2 text-slate-800 dark:text-slate-200">Word Studio Draft</h3><div class="prose-output">${html}</div>`;
                    ui.contentContainer.prepend(card);
                }
                ui.exportButtons.classList.remove('hidden');
            }

            function getPlainTextFromEditor() {
                return (ui.wordEditor.innerText || '').replace(/\s+/g, ' ').trim();
            }

            function calcReadability(text) {
                const words = text.split(/\s+/).filter(Boolean);
                const sentences = text.split(/[.!?]+/).filter(Boolean);
                const syllables = words.reduce((acc, w) => acc + Math.max(1, (w.toLowerCase().match(/[aiueo]/g) || []).length), 0);
                const w = words.length || 1, s = sentences.length || 1;
                const score = 206.835 - 1.015 * (w / s) - 84.6 * (syllables / w);
                return Math.max(0, Math.min(100, score)).toFixed(2);
            }

            function appendSupportMessage(title, body) {
                ui.supportResult.innerHTML = `<p><strong>${title}</strong></p><div class="mt-1">${body}</div>`;
            }

            async function runDocSupportAction(type) {
                const topic = document.getElementById('topik').value.trim() || getPlainTextFromEditor() || 'Topik penelitian';
                if (type === 'title') {
                    const keywords = await extractKeywordsTf(topic);
                    appendSupportMessage('Saran Judul', `<ol class='list-decimal ml-5'><li>Analisis ${keywords[0] || topic} pada konteks Indonesia</li><li>Model Implementasi ${keywords[1] || topic} Berbasis Data</li><li>Evaluasi ${keywords[2] || topic} untuk Optimasi Kinerja</li></ol>`);
                    return;
                }
                if (type === 'outline') {
                    appendSupportMessage('Outline Otomatis', `<ul class='list-disc ml-5'><li>Pendahuluan</li><li>Tinjauan Pustaka</li><li>Metodologi</li><li>Hasil & Pembahasan</li><li>Kesimpulan & Saran</li></ul>`);
                    return;
                }
                if (type === 'abstract') {
                    const abs = `Penelitian ini membahas ${topic}. Pendekatan yang digunakan berbasis analisis data dan evaluasi komparatif. Hasil menunjukkan peningkatan efektivitas pada indikator utama. Penelitian ini merekomendasikan implementasi bertahap untuk optimasi berkelanjutan.`;
                    appendSupportMessage('Abstrak Otomatis', abs);
                    return;
                }
                if (type === 'citation') {
                    const year = new Date().getFullYear();
                    appendSupportMessage('Generator Sitasi', `(Penulis, ${year})<br>Penulis. (${year}). <i>Judul Dokumen</i>. Penerbit/Institusi.`);
                    return;
                }
                if (type === 'readability') {
                    const text = topic + ' ' + getPlainTextFromEditor();
                    appendSupportMessage('Skor Keterbacaan', `Skor: <strong>${calcReadability(text)}</strong> / 100`);
                    return;
                }
                if (type === 'plagiarism') {
                    const text = getPlainTextFromEditor() || topic;
                    const uniq = new Set(text.toLowerCase().split(/\s+/).filter(Boolean));
                    const ratio = (uniq.size / Math.max(1, text.split(/\s+/).filter(Boolean).length)) * 100;
                    appendSupportMessage('Cek Kemiripan Lokal', `Kemiripan lokal terestimasi: <strong>${(100-ratio).toFixed(1)}%</strong> (heuristik internal).`);
                    return;
                }
                if (type === 'timeline') {
                    appendSupportMessage('Timeline Penelitian', `<table class='w-full text-xs border'><tr><th class='border p-1'>Minggu</th><th class='border p-1'>Aktivitas</th></tr><tr><td class='border p-1'>1-2</td><td class='border p-1'>Studi Literatur</td></tr><tr><td class='border p-1'>3-4</td><td class='border p-1'>Pengumpulan Data</td></tr><tr><td class='border p-1'>5-6</td><td class='border p-1'>Analisis</td></tr></table>`);
                    return;
                }
                if (type === 'method') {
                    appendSupportMessage('Matriks Metode', `<table class='w-full text-xs border'><tr><th class='border p-1'>Metode</th><th class='border p-1'>Kelebihan</th><th class='border p-1'>Keterbatasan</th></tr><tr><td class='border p-1'>Kualitatif</td><td class='border p-1'>Mendalam</td><td class='border p-1'>Subjektif</td></tr><tr><td class='border p-1'>Kuantitatif</td><td class='border p-1'>Terukur</td><td class='border p-1'>Kurang konteks</td></tr></table>`);
                    return;
                }
                if (type === 'risk') {
                    appendSupportMessage('Matriks Risiko', `<ul class='list-disc ml-5'><li>Risiko data tidak lengkap  mitigasi: validasi silang.</li><li>Risiko bias responden  mitigasi: sampling beragam.</li><li>Risiko waktu  mitigasi: milestone mingguan.</li></ul>`);
                    return;
                }
                if (type === 'conclusion') {
                    appendSupportMessage('Auto Kesimpulan', `Secara umum, ${topic} menunjukkan dampak positif dengan catatan pada kualitas implementasi, ketersediaan data, dan konsistensi evaluasi.`);
                    return;
                }
            }

            function wordFindReplace(findText, replaceText = null) {
                if (!findText) return 0;
                const content = ui.wordEditor.innerHTML;
                const regex = new RegExp(findText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                const matches = content.match(regex) || [];
                if (replaceText !== null) {
                    ui.wordEditor.innerHTML = content.replace(regex, replaceText);
                }
                return matches.length;
            }

            // --- EVENT LISTENERS ---
            ui.generateBtn.addEventListener('click', handleGeneration);
            ui.extractKeywordsBtn.addEventListener('click', async () => {
                const text = document.getElementById('topik').value.trim();
                const keys = await extractKeywordsTf(text || 'Indonesia digital');
                ui.supportResult.innerHTML = `<p><strong>Keyword TensorFlow/Frequency:</strong> ${keys.join(', ')}</p>`;
                ui.supportResult.dataset.lastKeywords = keys.join(', ');
            });
            ui.autoResearchBtn.addEventListener('click', runAutoResearch);
            ui.applyResearchToTopicBtn.addEventListener('click', applyResearchToTopic);
            ui.openWordStudioBtn.addEventListener('click', openWordStudio);
            document.getElementById('word-bold-btn').addEventListener('click', () => wordCmd('bold'));
            document.getElementById('word-italic-btn').addEventListener('click', () => wordCmd('italic'));
            document.getElementById('word-underline-btn').addEventListener('click', () => wordCmd('underline'));
            document.getElementById('word-strike-btn').addEventListener('click', () => wordCmd('strikeThrough'));
            document.getElementById('word-h1-btn').addEventListener('click', () => wordCmd('formatBlock', 'H1'));
            document.getElementById('word-h2-btn').addEventListener('click', () => wordCmd('formatBlock', 'H2'));
            document.getElementById('word-h3-btn').addEventListener('click', () => wordCmd('formatBlock', 'H3'));
            document.getElementById('word-p-btn').addEventListener('click', () => wordCmd('formatBlock', 'P'));
            document.getElementById('word-ul-btn').addEventListener('click', () => wordCmd('insertUnorderedList'));
            document.getElementById('word-ol-btn').addEventListener('click', () => wordCmd('insertOrderedList'));
            document.getElementById('word-align-left-btn').addEventListener('click', () => wordCmd('justifyLeft'));
            document.getElementById('word-align-center-btn').addEventListener('click', () => wordCmd('justifyCenter'));
            document.getElementById('word-align-right-btn').addEventListener('click', () => wordCmd('justifyRight'));
            document.getElementById('word-justify-btn').addEventListener('click', () => wordCmd('justifyFull'));
            document.getElementById('word-indent-btn').addEventListener('click', () => wordCmd('indent'));
            document.getElementById('word-outdent-btn').addEventListener('click', () => wordCmd('outdent'));
            document.getElementById('word-quote-btn').addEventListener('click', () => wordCmd('formatBlock', 'BLOCKQUOTE'));
            document.getElementById('word-code-btn').addEventListener('click', () => wordCmd('formatBlock', 'PRE'));
            document.getElementById('word-hr-btn').addEventListener('click', () => wordCmd('insertHorizontalRule'));
            document.getElementById('word-link-btn').addEventListener('click', () => {
                const url = prompt('Masukkan URL:');
                if (url) wordCmd('createLink', url);
            });
            document.getElementById('word-unlink-btn').addEventListener('click', () => wordCmd('unlink'));
            document.getElementById('word-sup-btn').addEventListener('click', () => wordCmd('superscript'));
            document.getElementById('word-sub-btn').addEventListener('click', () => wordCmd('subscript'));
            document.getElementById('word-clear-format-btn').addEventListener('click', () => wordCmd('removeFormat'));
            document.getElementById('word-select-all-btn').addEventListener('click', () => wordCmd('selectAll'));
            document.getElementById('word-undo-btn').addEventListener('click', () => wordCmd('undo'));
            document.getElementById('word-redo-btn').addEventListener('click', () => wordCmd('redo'));
            document.getElementById('word-copy-btn').addEventListener('click', () => wordCmd('copy'));
            document.getElementById('word-paste-btn').addEventListener('click', () => wordCmd('paste'));
            document.getElementById('word-find-btn').addEventListener('click', () => {
                const q = prompt('Cari kata:');
                if (!q) return;
                const count = wordFindReplace(q, null);
                alert(`Ditemukan ${count} kemunculan.`);
            });
            document.getElementById('word-replace-btn').addEventListener('click', () => {
                const q = prompt('Cari kata:');
                if (!q) return;
                const r = prompt('Ganti dengan:') ?? '';
                const count = wordFindReplace(q, r);
                alert(`Diganti ${count} kemunculan.`);
            });
            document.getElementById('word-count-btn').addEventListener('click', () => {
                const words = getPlainTextFromEditor().split(/\s+/).filter(Boolean).length;
                alert(`Jumlah kata: ${words}`);
            });
            document.getElementById('word-readtime-btn').addEventListener('click', () => {
                const words = getPlainTextFromEditor().split(/\s+/).filter(Boolean).length;
                const mins = Math.max(1, Math.ceil(words / 200));
                alert(`Estimasi waktu baca: ${mins} menit`);
            });
            document.getElementById('word-save-local-btn').addEventListener('click', () => {
                localStorage.setItem('wordStudioDraft_v1', ui.wordEditor.innerHTML);
                alert('Draft Word Studio tersimpan lokal.');
            });
            document.getElementById('word-load-local-btn').addEventListener('click', () => {
                const draft = localStorage.getItem('wordStudioDraft_v1');
                if (!draft) return alert('Belum ada draft lokal.');
                ui.wordEditor.innerHTML = draft;
            });
            document.getElementById('word-table-btn').addEventListener('click', insertWordTable);
            document.getElementById('word-sync-btn').addEventListener('click', syncWordToContent);
            document.getElementById('word-close-btn').addEventListener('click', () => ui.wordStudio.classList.add('hidden'));
            document.getElementById('suggest-title-btn').addEventListener('click', () => runDocSupportAction('title'));
            document.getElementById('generate-outline-btn').addEventListener('click', () => runDocSupportAction('outline'));
            document.getElementById('generate-abstract-btn').addEventListener('click', () => runDocSupportAction('abstract'));
            document.getElementById('build-citation-btn').addEventListener('click', () => runDocSupportAction('citation'));
            document.getElementById('readability-check-btn').addEventListener('click', () => runDocSupportAction('readability'));
            document.getElementById('plagiarism-local-btn').addEventListener('click', () => runDocSupportAction('plagiarism'));
            document.getElementById('build-timeline-btn').addEventListener('click', () => runDocSupportAction('timeline'));
            document.getElementById('method-matrix-btn').addEventListener('click', () => runDocSupportAction('method'));
            document.getElementById('risk-matrix-btn').addEventListener('click', () => runDocSupportAction('risk'));
            document.getElementById('auto-conclusion-btn').addEventListener('click', () => runDocSupportAction('conclusion'));
            document.getElementById('local-ai-summary-btn').addEventListener('click', () => runLocalOfflineAI('summary'));
            document.getElementById('local-ai-analysis-btn').addEventListener('click', () => runLocalOfflineAI('analysis'));
            document.getElementById('export-pdf-btn').addEventListener('click', downloadPdfFromContent);
            document.getElementById('open-doc-btn').addEventListener('click', () => document.getElementById('open-doc-input').click());
            document.getElementById('open-doc-input').addEventListener('change', (e) => openDocumentFile(e.target.files?.[0]));
            document.addEventListener('click', async (e) => {
                const imageBtn = e.target.closest('.auto-image-btn');
                if (imageBtn) {
                    const sectionTitle = imageBtn.dataset.section;
                    const card = imageBtn.closest('.section-card');
                    await searchImageForSection(sectionTitle, card);
                    return;
                }
                const tableBtn = e.target.closest('.auto-table-btn');
                if (tableBtn) {
                    const sectionTitle = tableBtn.dataset.section;
                    const card = tableBtn.closest('.section-card');
                    buildAutoTableFromContent(sectionTitle, card);
                }
            });
            document.getElementById('create-word-btn').addEventListener('click', createWordFromContent);
            document.getElementById('copy-all-btn').addEventListener('click', copyAllContent);
            document.getElementById('jenis-dokumen').addEventListener('change', updateWorkflowUI);
            document.getElementById('generation-mode').addEventListener('change', updateWorkflowUI);
            document.getElementById('include-bab5').addEventListener('change', updateManualChecklist);
            document.getElementById('include-lampiran').addEventListener('change', updateManualChecklist);
            document.getElementById('select-all-btn').addEventListener('click', () => {
                document.querySelectorAll('#manual-sections-container .section-check').forEach(cb => cb.checked = true);
            });
            document.getElementById('deselect-all-btn').addEventListener('click', () => {
                document.querySelectorAll('#manual-sections-container .section-check').forEach(cb => cb.checked = false);
            });
            document.getElementById('open-settings-btn').addEventListener('click', () => ui.settingsModal.classList.remove('hidden'));
            document.getElementById('modal-close-btn').addEventListener('click', () => ui.settingsModal.classList.add('hidden'));
            document.getElementById('copy-all-btn').addEventListener('click', () => {
                if (Object.keys(appState.content).length === 0) {
                    alert('Tidak ada konten untuk disalin. Silakan generate dokumen terlebih dahulu.');
                    return;
                }
                const allContent = Object.entries(appState.content).map(([title, content]) => `# ${title}\n\n${content}`).join('\n\n');
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(allContent).then(() => {
                        ui.copyFeedback.classList.remove('hidden');
                        setTimeout(() => ui.copyFeedback.classList.add('hidden'), 2000);
                    }).catch(err => {
                        console.error('Failed to copy: ', err);
                        fallbackCopyToClipboard(allContent);
                    });
                } else {
                    fallbackCopyToClipboard(allContent);
                }
            });

            function fallbackCopyToClipboard(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    ui.copyFeedback.classList.remove('hidden');
                    setTimeout(() => ui.copyFeedback.classList.add('hidden'), 2000);
                } catch (err) {
                    console.error('Fallback copy failed: ', err);
                    alert('Gagal menyalin. Silakan salin manual.');
                }
                document.body.removeChild(textArea);
            }
            document.getElementById('export-docx-btn').addEventListener('click', () => {
                if (Object.keys(appState.content).length === 0) {
                    alert('Tidak ada konten untuk diekspor. Silakan generate dokumen terlebih dahulu.');
                    return;
                }
                if (typeof htmlDocx === 'undefined' || typeof saveAs === 'undefined') {
                    // Fallback to HTML export if DOCX library not loaded
                    exportAsHtml();
                    return;
                }
                try {
                    const htmlContent = buildExportHtml();
                    htmlDocx.asBlob(htmlContent).then(blob => {
                        saveAs(blob, 'document.docx');
                    }).catch(err => {
                        console.error('Export failed: ', err);
                        alert('Gagal mengekspor DOCX. Menggunakan fallback HTML...');
                        exportAsHtml();
                    });
                } catch (err) {
                    console.error('DOCX creation error: ', err);
                    alert('Error membuat DOCX. Menggunakan fallback HTML...');
                    exportAsHtml();
                }
            });

            function exportAsHtml() {
                const blob = new Blob([buildExportHtml()], { type: 'text/html' });
                saveAs(blob, 'document.html');
                alert('Dokumen diekspor sebagai HTML. Buka file di browser, lalu simpan sebagai .docx di Microsoft Word (File > Save As > Word Document).');
            }
            document.getElementById('setting-custom-api-key').addEventListener('input', (e) => { appSettings.customApiKey = e.target.value; saveSettings(); });
            document.getElementById('setting-ai-model').addEventListener('change', (e) => { appSettings.aiModel = e.target.value; saveSettings(); });
            document.getElementById('setting-language').addEventListener('change', (e) => { appSettings.language = e.target.value; applyLanguage(e.target.value); saveSettings(); updateWorkflowUI(); });
            document.getElementById('setting-theme').addEventListener('change', (e) => { appSettings.theme = e.target.value; applyTheme(e.target.value); saveSettings(); });
            document.getElementById('setting-toc-dots').addEventListener('change', (e) => { appSettings.tocDots = e.target.checked; saveSettings(); });

            // --- CUSTOM PARAPHRASE MODAL ---
            document.getElementById('custom-modal-container').innerHTML = `
                <div id="custom-paraphrase-modal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
                    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg w-full max-w-lg p-6 border border-slate-200 dark:border-slate-700">
                        <h2 class="text-xl font-bold text-slate-800 dark:text-slate-100 mb-6">Pengaturan Parafrase Kustom</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="custom-paraphrase-prompt" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Instruksi Kustom:</label>
                                <textarea id="custom-paraphrase-prompt" rows="4" class="w-full p-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm text-slate-800 dark:text-slate-200" placeholder="Masukkan instruksi khusus untuk parafrase..."></textarea>
                            </div>
                        </div>
                        <div class="mt-8 flex justify-end gap-3">
                            <button id="custom-modal-cancel" class="px-4 py-2 bg-slate-200 dark:bg-slate-600 rounded-md hover:bg-slate-300 dark:hover:bg-slate-500 text-sm font-semibold">Batal</button>
                            <button id="custom-modal-apply" class="px-4 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 text-sm font-semibold">Terapkan</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('custom-paraphrase-prompt').value = appSettings.customParaphrasePrompt;
            document.getElementById('custom-modal-cancel').addEventListener('click', () => {
                document.getElementById('custom-paraphrase-modal').classList.add('hidden');
            });
            document.getElementById('custom-modal-apply').addEventListener('click', () => {
                const customPrompt = document.getElementById('custom-paraphrase-prompt').value;
                appSettings.customParaphrasePrompt = customPrompt;
                saveSettings();
                document.getElementById('custom-paraphrase-modal').classList.add('hidden');
                // Set mode to custom
                document.querySelectorAll('.paraphrase-mode-btn').forEach(btn => btn.dataset.active = 'false');
                document.getElementById('btn_custom').dataset.active = 'true';
                document.getElementById('custom-indicator').classList.remove('hidden');
            });

            // --- PARAPHRASE PANEL EVENT LISTENERS ---
            document.addEventListener('selectionchange', () => {
                const selection = window.getSelection();
                const selectedText = selection.toString().trim();
                if (selectedText) {
                    document.getElementById('selected-text-preview').textContent = selectedText;
                    document.getElementById('paraphrase-panel').classList.remove('hidden');
                } else {
                    document.getElementById('paraphrase-panel').classList.add('hidden');
                }
            });

            document.addEventListener('click', (e) => {
                if (e.target.id === 'close-paraphrase-panel') {
                    document.getElementById('paraphrase-panel').classList.add('hidden');
                } else if (e.target.classList.contains('paraphrase-mode-btn')) {
                    document.querySelectorAll('.paraphrase-mode-btn').forEach(btn => btn.dataset.active = 'false');
                    e.target.dataset.active = 'true';
                } else if (e.target.id === 'btn_paraphrase') {
                    const selectedText = document.getElementById('selected-text-preview').textContent;
                    if (!selectedText) {
                        alert('Tidak ada teks yang dipilih.');
                        return;
                    }
                    const activeMode = document.querySelector('.paraphrase-mode-btn[data-active="true"]');
                    let mode = 'ai0';
                    if (activeMode) mode = activeMode.dataset.mode;
                    else if (document.getElementById('btn_custom').dataset.active === 'true') mode = 'custom';
                    ui.loaderText.textContent = 'Memparafrase...';
                    ui.loader.classList.remove('hidden');
                    let prompt;
                    if (mode === 'custom') {
                        prompt = `${appSettings.customParaphrasePrompt}: ${selectedText}. Pertahankan format markdown seperti **bold**, *italic*, ***bold italic*** jika ada dalam teks asli.`;
                    } else {
                        prompt = `Parafrase teks berikut dengan mode ${mode}: ${selectedText}. Pertahankan format markdown seperti **bold**, *italic*, ***bold italic*** jika ada dalam teks asli.`;
                    }
                    runAdvancedParaphrase(selectedText).then(localText => localText || callGeminiAPI(prompt)).then(newText => {
                        ui.loader.classList.add('hidden');
                        const selection = window.getSelection();
                        if (selection.rangeCount > 0) {
                            const range = selection.getRangeAt(0);
                            const newNode = document.createTextNode(newText);
                            range.deleteContents();
                            range.insertNode(newNode);
                            document.getElementById('paraphrase-panel').classList.add('hidden');
                        }
                    }).catch(err => {
                        ui.loader.classList.add('hidden');
                        alert('Error paraphrasing: ' + err.message);
                    });
                } else if (e.target.id === 'btn_regenerate_paraphrase') {
                    const selectedText = document.getElementById('selected-text-preview').textContent;
                    if (!selectedText) {
                        alert('Tidak ada teks yang dipilih.');
                        return;
                    }
                    const activeMode = document.querySelector('.paraphrase-mode-btn[data-active="true"]');
                    let mode = 'ai0';
                    if (activeMode) mode = activeMode.dataset.mode;
                    else if (document.getElementById('btn_custom').dataset.active === 'true') mode = 'custom';
                    ui.loaderText.textContent = 'Membuat ulang parafrase...';
                    ui.loader.classList.remove('hidden');
                    let prompt;
                    if (mode === 'custom') {
                        prompt = `Buat ulang: ${appSettings.customParaphrasePrompt}: ${selectedText}. Pertahankan format markdown seperti **bold**, *italic*, ***bold italic*** jika ada dalam teks asli.`;
                    } else {
                        prompt = `Buat ulang parafrase untuk teks berikut dengan mode ${mode}: ${selectedText}. Pertahankan format markdown seperti **bold**, *italic*, ***bold italic*** jika ada dalam teks asli.`;
                    }
                    callGeminiAPI(prompt).then(newText => {
                        ui.loader.classList.add('hidden');
                        const selection = window.getSelection();
                        if (selection.rangeCount > 0) {
                            const range = selection.getRangeAt(0);
                            const newNode = document.createTextNode(newText);
                            range.deleteContents();
                            range.insertNode(newNode);
                            document.getElementById('paraphrase-panel').classList.add('hidden');
                        }
                    }).catch(err => {
                        ui.loader.classList.add('hidden');
                        alert('Error regenerating paraphrase: ' + err.message);
                    });
                } else if (e.target.id === 'btn_custom') {
                    document.getElementById('custom-paraphrase-modal').classList.remove('hidden');
                } else if (e.target.id === 'btn_expand') {
                    const selectedText = document.getElementById('selected-text-preview').textContent;
                    if (!selectedText) {
                        alert('Tidak ada teks yang dipilih.');
                        return;
                    }
                    const activeMode = document.querySelector('.paraphrase-mode-btn[data-active="true"]');
                    let mode = 'ai0';
                    if (activeMode) mode = activeMode.dataset.mode;
                    else if (document.getElementById('btn_custom').dataset.active === 'true') mode = 'custom';
                    ui.loaderText.textContent = 'Memperbanyak kata...';
                    ui.loader.classList.remove('hidden');
                    let prompt;
                    if (mode === 'custom') {
                        prompt = `${appSettings.customParaphrasePrompt}: ${selectedText}. Perbanyak kata, buat lebih panjang dan detail. Pertahankan format markdown seperti **bold**, *italic*, ***bold italic*** jika ada dalam teks asli.`;
                    } else {
                        prompt = `Perbanyak kata dalam teks berikut dengan mode ${mode}, buat lebih panjang dan detail: ${selectedText}. Pertahankan format markdown seperti **bold**, *italic*, ***bold italic*** jika ada dalam teks asli.`;
                    }
                    callGeminiAPI(prompt).then(newText => {
                        ui.loader.classList.add('hidden');
                        const selection = window.getSelection();
                        if (selection.rangeCount > 0) {
                            const range = selection.getRangeAt(0);
                            const newNode = document.createTextNode(newText);
                            range.deleteContents();
                            range.insertNode(newNode);
                            document.getElementById('paraphrase-panel').classList.add('hidden');
                        }
                    }).catch(err => {
                        ui.loader.classList.add('hidden');
                        alert('Error expanding text: ' + err.message);
                    });
                }
            });

            ui.applyTemplateBtn.addEventListener('click', () => {
                const template = ui.topicTemplate.value;
                if (!template) return;
                const topicEl = document.getElementById('topik');
                topicEl.value = topicEl.value.trim() ? `${topicEl.value.trim()}
${template}` : template;
            });
            ui.saveDraftBtn.addEventListener('click', () => saveDraft(true));
            ui.loadDraftBtn.addEventListener('click', () => loadDraft(true));
            ui.clearDraftBtn.addEventListener('click', () => clearDraft(true));
            setInterval(() => saveDraft(false), 20000);
            window.addEventListener('beforeunload', () => saveDraft(false));

            // --- INITIAL SETUP ---
            loadSettings();
            updateWorkflowUI();
            updateDraftStatus();
        });
    </script>
</body>
</html>
