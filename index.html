<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>AI OMNI-OS v19.7 (REBUILD)</title>
<meta name="description" content="The Ultimate AI Operating System Simulation in a single file.">

<!-- 
    OMNI-OS KERNEL DEPENDENCIES 
-->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
<!-- File Reader Dependencies -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    /* =========================================
       1. KERNEL VARIABLES (ONE UI 1.0 THEME)
       ========================================= */
    :root {
        --bg-color: #111115; /* Deep dark background */
        --panel-color: rgba(25, 25, 30, 0.95); /* Panels slightly lighter */
        --surface-color: rgba(40, 40, 50, 0.8);
        --border-color: rgba(255, 255, 255, 0.15);
        
        --primary: #4285F4;  /* Samsung/Google Blue (Action Color) */
        --accent: #B388FF;   /* One UI Violet (Highlight) */
        --retro: #a4c639;    
        --logic: #00ffaa;    /* Logic Core (Teal/Cyan) */
        --fun: #ff00ff;      /* Fun Core */
        --custom: #f59e0b;   
        --danger: #ff5546;   
        --terminal: #0f0;    
        
        --text-main: #e3e3e3;
        --text-dim: #9aa0a6;
        --font-ui: 'Google Sans', 'Segoe UI', sans-serif; /* One UI inspired font stack */
        --font-mono: 'Roboto Mono', 'Consolas', monospace;
        
        --sidebar-width: 260px;
        --header-height: 64px;
    }

    /* =========================================
       2. GLOBAL RESET
       ========================================= */
    * { 
        box-sizing: border-box; 
        -webkit-tap-highlight-color: transparent; 
        border-radius: 8px; /* ONE UI: More global rounding */
        transition: background 0.15s, color 0.15s;
    }
    body { background: var(--bg-color); color: var(--text-main); font-family: var(--font-ui); margin: 0; height: 100vh; height: 100dvh; overflow: hidden; display: flex; user-select: none; transition: background 0.3s; }

    /* =========================================
       3. ANIMATIONS & BG
       ========================================= */
    .wallpaper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at 50% -20%, #151520 0%, #000 70%); }
    .orb { position: absolute; border-radius: 50%; filter: blur(90px); opacity: 0.3; animation: float 20s infinite ease-in-out; }
    .orb-1 { top: 10%; left: 10%; width: 50vw; height: 50vw; background: var(--primary); }
    .orb-2 { bottom: 10%; right: 10%; width: 60vw; height: 60vw; background: var(--accent); animation-delay: -5s; }
    @keyframes float { 0%,100%{transform:translate(0,0)} 50%{transform:translate(30px, -30px)} }
    @keyframes bootUp { 0% { opacity: 0; filter: blur(10px); transform: scale(0.95); } 100% { opacity: 1; filter: blur(0); transform: scale(1); } }
    @keyframes popIn { 0%{opacity:0; transform:scale(0.9)} 100%{opacity:1; transform:scale(1)} }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 0.5; box-shadow: 0 0 0 0 rgba(66, 133, 244, 0.7); } 70% { transform: scale(1.1); opacity: 1; box-shadow: 0 0 0 20px rgba(66, 133, 244, 0); } 100% { transform: scale(0.8); opacity: 0.5; box-shadow: 0 0 0 0 rgba(66, 133, 244, 0); } }

    /* =========================================
       4. LAYOUT
       ========================================= */
    #root {
        display: grid; grid-template-columns: var(--sidebar-width) 1fr 300px; grid-template-rows: var(--header-height) 1fr;
        width: 100%; height: 100%; backdrop-filter: blur(10px); animation: bootUp 1s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    }

    /* AREAS */
    .sidebar { grid-row: 1 / 3; background: var(--panel-color); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; z-index: 20; }
    .header { 
        grid-column: 2 / 4; 
        border-bottom: 1px solid var(--border-color); 
        display: flex; 
        align-items: center; 
        justify-content: space-between; 
        padding: 0 20px; 
        background: rgba(0,0,0,0.2); 
    }
    .main { position: relative; display: flex; flex-direction: column; overflow: hidden; }
    .widgets { grid-column: 3 / 4; grid-row: 2 / 3; background: var(--panel-color); border-left: 1px solid var(--border-color); padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }

    /* MOBILE RESPONSIVE FIXES (One UI Mobile Focus) */
    @media (max-width: 1000px) {
        #root { grid-template-columns: 1fr; grid-template-rows: 60px 1fr 70px; }
        .sidebar, .widgets { display: none !important; }
        .header { 
            grid-column: 1 / 2; 
            padding: 0 15px; 
            /* One UI mobile look: Title bar is clean */
        }
        .main { grid-column: 1 / 2; grid-row: 2 / 3; }
        .mobile-nav { display: flex !important; }
        #headerTitle { font-size: 1rem; }
        .status-badge { font-size: 0.6rem; padding: 2px 6px; }
        .status-badge.learning { display: none !important; }
        .msg { max-width: 90%; font-size: 0.95rem; }
        .app-grid { grid-template-columns: repeat(3, 1fr) !important; gap: 15px !important; padding: 20px !important; }
        .app-icon { width: 50px !important; height: 50px !important; font-size: 1.3rem !important; }
        .deck { padding: 10px; }
        .bar { width: 100%; flex-wrap: wrap; border-radius: 25px !important; /* Extra rounded */ }
        .window { width: 95% !important; height: auto; max-height: 85vh; border-radius: 18px !important; }
        .win-head { border-radius: 18px 18px 0 0 !important; }
        .win-body { border-radius: 0 0 18px 18px !important; }
    }

    /* COMPONENTS */
    .brand { font-size: 1.1rem; font-weight: 700; color: var(--primary); padding: 20px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border-color); }
    .nav-group { padding: 10px 0; overflow-y: auto; flex: 1; }
    .nav-label { padding: 0 20px; font-size: 0.7rem; color: var(--text-dim); font-weight: bold; margin: 15px 0 5px; letter-spacing: 1px; }
    .nav-item { padding: 12px 20px; color: var(--text-dim); cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; font-size: 0.9rem; position: relative; }
    .nav-item:hover { color: #fff; background: rgba(255,255,255,0.05); }
    .nav-item.active { 
        background: rgba(66, 133, 244, 0.15); /* One UI background highlight */
        color: var(--primary); 
        border-right: 3px solid var(--primary); 
    }

    /* CHAT */
    .stream { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; scroll-behavior: smooth; }
    .msg { 
        max-width: 85%; 
        padding: 12px 18px; 
        border-radius: 18px; 
        font-size: 0.95rem; 
        line-height: 1.6; 
        position: relative; 
        animation: popIn 0.3s; 
        word-wrap: break-word; 
    }
    .msg-user { 
        align-self: flex-end; 
        background: var(--primary); /* User message uses primary color */
        color: #fff; 
        border-bottom-right-radius: 4px; 
        border: none;
    }
    .msg-ai { 
        align-self: flex-start; 
        background: var(--panel-color); 
        border: 1px solid var(--border-color); 
        border-bottom-left-radius: 4px; 
    }
    .msg-ai.logic { border-left: 3px solid var(--logic); }
    .msg-ai.fun { border-left: 3px solid var(--fun); background: rgba(255,0,255,0.05); }
    .msg-ai.deep { border-left: 3px solid var(--accent); background: rgba(179, 136, 255, 0.1); }
    .msg-ai.custom { border-left: 3px solid var(--custom); }
    
    .sys-msg { font-size: 0.75rem; color: var(--text-dim); text-align: center; font-family: var(--font-mono); margin: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.05); line-height: 0.1em; margin: 10px 0 20px; }
    .sys-msg span { background: var(--bg-color); padding: 0 10px; }

    .thinking-box { font-family: var(--font-mono); font-size: 0.7rem; color: var(--accent); padding: 10px; background: rgba(179, 136, 255, 0.1); border-radius: 8px; margin-bottom: 5px; display: none; white-space: pre-wrap; border: 1px solid rgba(179, 136, 255, 0.2); }
    .thinking-box.active { display: block; }
    
    /* API TAGS */
    .api-tag { display:inline-block; font-size:0.6rem; padding:2px 6px; border-radius:12px; margin-top:5px; background:rgba(255,255,255,0.1); color:var(--text-dim); font-family:var(--font-mono); }
    .api-tag.ent { color: var(--fun); border: 1px solid rgba(255,0,255,0.2); }
    .api-tag.know { color: var(--primary); border: 1px solid rgba(66, 133, 244, 0.2); }
    
    /* NOTES ACTION BUTTON */
    .note-btn { 
        padding: 5px 10px; 
        font-size: 0.75rem; 
        margin-top: 5px; 
        background: rgba(100, 100, 255, 0.1);
        color: var(--primary);
        border: 1px solid var(--primary);
        cursor: pointer;
        border-radius: 4px;
        display: inline-block;
        transition: 0.2s;
    }
    .note-btn:hover { background: rgba(100, 100, 255, 0.3); }

    /* INPUT */
    .deck { padding: 20px; background: transparent; display: flex; justify-content: center; z-index: 30; }
    .bar { background: #1e1f20; width: 100%; max-width: 750px; border-radius: 30px; display: flex; align-items: center; padding: 8px; gap: 8px; border: 1px solid var(--border-color); box-shadow: 0 5px 30px rgba(0,0,0,0.5); position: relative; transition: all 0.3s; }
    .inp { flex: 1; background: transparent; border: none; color: #fff; font-size: 1rem; padding: 10px; outline: none; font-family: var(--font-ui); min-width: 50px; }
    .ico-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: transparent; color: var(--text-dim); cursor: pointer; display:grid; place-items:center; font-size:1.1rem; transition:0.2s; flex-shrink: 0; }
    .ico-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
    .ico-btn.send { background: var(--primary); color: #fff; } /* Send button is solid primary color in One UI */
    .ico-btn.send:hover { background: var(--primary); opacity: 0.8; }
    
    /* GEMINI CONNECT BUTTON */
    #btnGemini {
        display: flex; align-items: center; gap: 6px; padding: 8px 14px; 
        background: rgba(179, 136, 255, 0.1); border-radius: 20px; 
        font-size: 0.8rem; color: var(--accent); user-select: none; 
        white-space: nowrap; 
        border: 1px solid rgba(179, 136, 255, 0.3); transition: 0.2s;
    }
    #btnGemini.connected {
        background: rgba(0, 255, 170, 0.15);
        color: var(--logic);
        border: 1px solid var(--logic);
    }
    #btnGemini:hover {
        background: rgba(179, 136, 255, 0.3);
    }


    /* ATTACHMENT CHIP */
    .attach-area { width: 100%; display: none; padding: 5px 10px; border-bottom: 1px solid var(--border-color); margin-bottom: 5px; animation: slideUp 0.2s; }
    .attach-chip { display: inline-flex; align-items: center; gap: 8px; background: rgba(66, 133, 244, 0.15); color: var(--primary); padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; border: 1px solid rgba(66, 133, 244, 0.3); }
    .attach-close { cursor: pointer; opacity: 0.7; font-weight: bold; }
    .attach-close:hover { opacity: 1; }

    /* MENUS */
    .trigger-wrap { position: relative; }
    .trigger { display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: rgba(255,255,255,0.05); border-radius: 20px; cursor: pointer; font-size: 0.8rem; color: var(--text-main); user-select: none; white-space: nowrap; border: 1px solid transparent; }
    .trigger:hover { background: rgba(255,255,255,0.1); }
    .menu { position: absolute; bottom: 140%; background: #1e1f20; border: 1px solid var(--border-color); border-radius: 12px; padding: 5px; display: none; flex-direction: column; box-shadow: 0 10px 30px #000; z-index: 100; min-width: 180px; animation: popIn 0.1s; }
    .menu.show { display: flex; }
    .m-item { padding: 10px; border-radius: 8px; cursor: pointer; color: var(--text-dim); font-size: 0.85rem; display:flex; gap:10px; }
    .m-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
    .m-item.sel { color: var(--primary); background: rgba(66, 133, 244, 0.1); }
    .m-head { font-size: 0.7rem; padding: 5px 10px; color: var(--text-dim); font-weight: bold; opacity: 0.5; margin-top: 5px; }

    /* APP DRAWER */
    .drawer { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 200; display: none; flex-direction: column; align-items: center; justify-content: center; animation: popIn 0.2s; }
    .drawer.open { display: flex; }
    .app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 25px; padding: 30px; background: #151515; border-radius: 30px; border: 1px solid var(--border-color); }
    .app { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; transition: 0.2s; }
    .app:hover { transform: translateY(-5px); }
    .app-icon { 
        width: 56px; 
        height: 56px; 
        border-radius: 30%; /* Less rounded than standard, more like One UI */
        display: grid; 
        place-items: center; 
        font-size: 1.5rem; 
        color: #fff; 
        border: 1px solid rgba(255,255,255,0.1); 
        background: linear-gradient(145deg, #2a2a2a, #1a1a1a); 
    }
    .app-name { color: #ccc; font-size: 0.8rem; }

    /* WINDOWS */
    .window { 
        position: fixed; 
        top: 50%; 
        left: 50%; 
        transform: translate(-50%, -50%); 
        width: 90%; 
        max-width: 500px; 
        background: #111; 
        border: 1px solid var(--border-color); 
        border-radius: 18px; /* Increased rounding */
        display: none; 
        flex-direction: column; 
        z-index: 250; 
        box-shadow: 0 20px 60px #000; 
        max-height: 80vh; 
        animation: popIn 0.2s; 
    }
    .win-head { 
        background: #1f1f1f; 
        padding: 15px; /* Larger padding for One UI feel */
        font-weight: 600; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        border-bottom: 1px solid var(--border-color); 
        border-radius: 18px 18px 0 0; 
    }
    .win-body { padding: 0; overflow: auto; flex: 1; position: relative; border-radius: 0 0 18px 18px; }

    /* TERMINAL */
    .terminal { height: 0; background: #000; overflow: hidden; transition: height 0.3s; font-family: var(--font-mono); font-size: 0.7rem; color: var(--terminal); padding: 0 20px; border-bottom: 1px solid var(--border-color); }
    .terminal.show { height: 120px; padding: 10px 20px; overflow-y: auto; }

    /* MOBILE NAV */
    .mobile-nav { grid-row: 3 / 4; background: var(--panel-color); border-top: 1px solid var(--border-color); display: none; justify-content: space-around; align-items: center; padding-bottom: env(safe-area-inset-bottom); z-index: 50; }
    .mn-item { display: flex; flex-direction: column; align-items: center; color: var(--text-dim); gap: 4px; font-size: 0.7rem; padding: 10px; cursor: pointer; flex: 1; }
    .mn-item:active { color: var(--primary); }

    /* WIDGET CARD */
    .card { background: var(--surface-color); padding: 15px; border-radius: 16px; border: 1px solid var(--border-color); margin-bottom: 15px; }
    .c-title { font-size: 0.7rem; font-weight: 700; color: var(--text-dim); margin-bottom: 10px; letter-spacing: 1px; }

    /* NOTIFICATIONS */
    .toast { background: rgba(20,20,20,0.9); border-left: 4px solid var(--primary); color: #fff; padding: 15px 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); margin-top: 10px; font-size: 0.9rem; backdrop-filter: blur(5px); min-width: 250px; animation: slideInRight 0.3s; pointer-events: none;}
    #notifContainer { position: fixed; bottom: 80px; right: 20px; z-index: 300; display: flex; flex-direction: column; pointer-events: none; }
    @keyframes slideInRight { from{transform:translateX(100%)} to{transform:translateX(0)} }
    
    /* STATUS BADGES */
    .status-badge { font-size: 0.65rem; padding: 4px 8px; border-radius: 10px; font-weight: bold; font-family: var(--font-mono); }
    .status-badge.online { background: rgba(0,255,170,0.15); color: var(--logic); border: 1px solid rgba(0,255,170,0.3); }
    .status-badge.learning { background: rgba(255,200,0,0.15); color: #fc0; border: 1px solid rgba(255,200,0,0.3); animation: blink 2s infinite; display: none; }

</style>
</head>
<body>

<div class="wallpaper">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
</div>

<div id="root">
    
    <!-- SIDEBAR -->
    <div class="sidebar">
        <!-- BRANDING CHANGE -->
        <div class="brand"><i class="fa-solid fa-note-sticky" style="color:var(--accent)"></i> GALAXY AI | ONE UI 1.0</div>
        
        <div class="nav-group">
            <div class="nav-label">CORE SYSTEM</div>
            <div class="nav-item active" onclick="setMode('chat', this)"><i class="fa-regular fa-message"></i> Chat Core</div>
            <div class="nav-item" onclick="startLifeMode()"><i class="fa-solid fa-microphone-lines"></i> Gemini Live</div>
            <div class="nav-item" onclick="Apps.Launcher.open()"><i class="fa-solid fa-grid-2"></i> App Ecosystem</div>
            
            <div class="nav-label">POWER TOOLS</div>
            <div class="nav-item" onclick="Apps.Code.open()"><i class="fa-solid fa-terminal"></i> Terminal / Code</div>
            <div class="nav-item" onclick="Apps.Notes.open()"><i class="fa-solid fa-note-sticky"></i> Neural Notes</div>
            <div class="nav-item" onclick="Apps.Draw.open()"><i class="fa-solid fa-palette"></i> Canvas Studio</div>
            <div class="nav-item" onclick="Apps.Files.open()"><i class="fa-solid fa-folder"></i> File Manager</div>
        </div>
        
        <div style="padding:20px;">
            <button onclick="openSettings()" style="width:100%; padding:10px; background:rgba(255,255,255,0.05); border:1px solid var(--border-color); color:#fff; border-radius:8px; cursor:pointer;">
                <i class="fa-solid fa-gear"></i> System Settings
            </button>
        </div>
    </div>

    <!-- HEADER -->
    <div class="header">
        <div style="font-weight:600; display:flex; align-items:center; gap:10px;">
            <span id="headerTitle">OMNI-OS</span>
            <div style="display:flex; align-items:center; gap:8px;">
                <span class="status-badge online" id="sysStatus">LOCAL</span>
                <span class="status-badge learning" id="learnStatus">NEXUS ACTIVE</span>
                <span class="status-badge learning" id="loopStatus" style="display:none; color:var(--danger); border-color:var(--danger);">INFINITY LOOP</span>
            </div>
        </div>
        <div style="display:flex; gap:10px">
            <button class="ico-btn" onclick="toggleCam()" title="Activate Vision"><i class="fa-solid fa-camera"></i></button>
            <button class="ico-btn" onclick="toggleTerminal()" title="System Log"><i class="fa-solid fa-code"></i></button>
        </div>
    </div>

    <!-- MAIN -->
    <div class="main">
        <!-- Vision Layer -->
        <div id="visionBox" style="height:0; overflow:hidden; position:relative; background:#000; transition:height 0.3s;">
            <video id="vid" autoplay playsinline muted style="width:100%; height:100%; object-fit:cover"></video>
            <canvas id="cvs" style="position:absolute; inset:0"></canvas>
            <button onclick="closeCam()" style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.5); color:#fff; border:none; padding:5px 10px; border-radius:20px; cursor:pointer">✕</button>
            <div id="vStat" style="position:absolute; bottom:10px; left:10px; background:rgba(0,0,0,0.6); color:var(--logic); padding:2px 8px; font-family:monospace; border-radius:4px;">OFFLINE</div>
        </div>

        <!-- Matrix Terminal -->
        <div class="terminal" id="term"></div>

        <!-- Chat Stream -->
        <div class="stream" id="chat">
            <div class="msg msg-ai logic">
                <b>GALAXY AI | ONE UI 1.0 Active.</b><br>
                Sistem AI Utama telah ditingkatkan ke **v19.7** (Granular Word Tokenization). Mesin AI lokal sekarang memproses data per kata untuk akurasi offline yang lebih tinggi.
                <i>Silakan ketik pertanyaan Anda.</i>
            </div>
            <div class="thinking-box" id="thinkLog"></div>
        </div>

        <!-- Input Deck -->
        <div class="deck">
            <div class="bar" style="flex-direction: column; align-items: stretch; gap:0;">
                
                <!-- ATTACHMENT PREVIEW AREA -->
                <div id="attachPreview" class="attach-area">
                    <!-- Chip will be injected here -->
                </div>

                <div style="display: flex; align-items: center; gap: 8px; width: 100%; padding: 5px;">
                    <button class="ico-btn" onclick="document.getElementById('fileIn').click()" title="Attach File"><i class="fa-solid fa-paperclip"></i></button>
                    
                    <!-- CAPABILITY MENU -->
                    <div class="trigger-wrap">
                        <div class="trigger" onclick="toggleMenu('capMenu')" id="capTrig"><i class="fa-solid fa-bolt"></i> Norm</div>
                        <div class="menu" id="capMenu" style="bottom:140%; left:0">
                            <div class="m-head">INTELLIGENCE LEVEL</div>
                            <div class="m-item selected" onclick="setCap('normal')"><i class="fa-solid fa-bolt"></i> Normal</div>
                            <div class="m-item" onclick="setCap('research')"><i class="fa-solid fa-globe"></i> Deep Research</div>
                            <div class="m-item" onclick="setCap('think')"><i class="fa-solid fa-brain"></i> Deep Thought (30s)</div>
                            <div class="m-item" onclick="setCap('canvas')"><i class="fa-solid fa-code"></i> Canvas Code</div>
                        </div>
                    </div>

                    <input type="text" class="inp" id="inp" placeholder="Ask Omni..." autocomplete="off">
                    <button class="ico-btn" onclick="toggleMic()" id="btnMic"><i class="fa-solid fa-microphone"></i></button>

                    <!-- GEMINI CONNECT BUTTON -->
                    <div id="btnGemini" onclick="toggleGeminiConnection()">
                        <i class="fa-solid fa-plug-circle-xmark" id="geminiIco"></i> 
                        <span id="geminiText">Connect</span>
                    </div>

                    <!-- MODE MENU -->
                    <div class="trigger-wrap">
                        <div class="trigger" onclick="toggleMenu('modeMenu')" id="modeTrig"><i class="fa-regular fa-message"></i> Chat</div>
                        <div class="menu" id="modeMenu" style="bottom:140%; right:0">
                            <div class="m-head">PERSONALITY</div>
                            <div class="m-item selected" onclick="setMode('chat')"><i class="fa-regular fa-message"></i> Chat</div>
                            <div class="m-item" onclick="setMode('entertainment')"><i class="fa-solid fa-film"></i> Entertainment</div>
                            <div class="m-item" onclick="setMode('teacher')"><i class="fa-solid fa-chalkboard-user"></i> Teacher</div>
                            <div class="m-item" onclick="setMode('debate')"><i class="fa-solid fa-people-arrows"></i> Debate</div>
                            <div class="m-item" onclick="setMode('debate-inf')"><i class="fa-solid fa-infinity"></i> Infinity Loop</div>
                            <div class="m-item" onclick="setMode('custom')"><i class="fa-solid fa-robot"></i> Custom Bot</div>
                        </div>
                    </div>

                    <button class="ico-btn send" onclick="handleInput()"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. WIDGETS -->
    <div class="widgets">
        <div class="card">
            <div class="c-title">MEMORY USAGE</div>
            <div style="display:flex; justify-content:space-between;"><span>Logic Nodes</span> <span id="stLogic" style="color:var(--logic)">0</span></div>
            <div style="display:flex; justify-content:space-between;"><span>Fun Nodes</span> <span id="stFun" style="color:var(--fun)">0</span></div>
            <div style="margin-top:10px; height:4px; background:#333; border-radius:2px; overflow:hidden;">
                <div id="memBar" style="height:100%; width:10%; background:var(--primary);"></div>
            </div>
        </div>
        <div class="card">
            <div class="c-title">POMODORO</div>
            <div style="font-size:2.5rem; text-align:center; font-family:monospace; margin:10px 0" id="pomoT">25:00</div>
            <div style="display:flex; justify-content:center; gap:10px">
                <button class="ico-btn" style="background:rgba(255,255,255,0.1)" onclick="pomoStart()"><i class="fa-solid fa-play"></i></button>
                <button class="ico-btn" style="background:rgba(255,255,255,0.1)" onclick="pomoReset()"><i class="fa-solid fa-rotate-left"></i></button>
            </div>
        </div>
        <div class="card">
            <div class="c-title">WEATHER (SIM)</div>
            <div style="display:flex; align-items:center; gap:10px">
                <i class="fa-solid fa-cloud-rain" style="font-size:2rem; color:var(--accent)"></i>
                <div>
                    <div style="font-size:1.2rem; font-weight:bold">24°C</div>
                    <div style="font-size:0.8rem; color:var(--text-dim)">Jakarta, ID</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. MOBILE NAV -->
    <div class="mobile-nav">
        <div class="mn-item active" onclick="Apps.Launcher.open()"><i class="fa-solid fa-grid-2"></i> Apps</div>
        <div class="mn-item" onclick="setMode('chat')"><i class="fa-solid fa-message"></i> Chat</div>
        <div class="mn-item" onclick="startLifeMode()"><i class="fa-solid fa-microphone-lines"></i> Life</div>
        <div class="mn-item" onclick="openSettings()"><i class="fa-solid fa-bars"></i> Menu</div>
    </div>
    
    <!-- NOTIFICATION CONTAINER -->
    <div id="notifContainer"></div>
</div>

<input type="file" id="fileIn" style="display:none" accept=".txt,.pdf,.docx,.pptx,.html,.md,.csv,.json" onchange="stageFile(this)">

<!-- === APP DRAWER === -->
<div class="drawer" id="appDrawer">
    <div style="display:flex; justify-content:space-between; width:90%; max-width:500px; margin-bottom:20px; color:#fff;">
        <span style="font-size:1.5rem; font-weight:bold;">App Ecosystem</span>
        <button class="ico-btn" onclick="Apps.Launcher.close()">✕</button>
    </div>
    <div class="app-grid">
        <!-- Utilities -->
        <div class="app" onclick="Apps.Notes.open()"><div class="app-icon" style="background:#f59e0b"><i class="fa-solid fa-note-sticky"></i></div><span class="app-name">Notes</span></div>
        <div class="app" onclick="Apps.Calc.open()"><div class="app-icon" style="background:#10b981"><i class="fa-solid fa-calculator"></i></div><span class="app-name">Calc</span></div>
        <div class="app" onclick="Apps.Files.open()"><div class="app-icon" style="background:#3b82f6"><i class="fa-solid fa-folder"></i></div><span class="app-name">Files</span></div>
        <div class="app" onclick="Apps.Code.open()"><div class="app-icon" style="background:#0f0; color:#000"><i class="fa-solid fa-terminal"></i></div><span class="app-name">Terminal</span></div>
        
        <!-- Creative -->
        <div class="app" onclick="Apps.Draw.open()"><div class="app-icon" style="background:#ec4899"><i class="fa-solid fa-palette"></i></div><span class="app-name">Paint</span></div>
        <div class="app" onclick="Apps.Music.open()"><div class="app-icon" style="background:#f43f5e"><i class="fa-solid fa-music"></i></div><span class="app-name">Music</span></div>
        <div class="app" onclick="Apps.Flash.open()"><div class="app-icon" style="background:#fff; color:#000"><i class="fa-solid fa-bolt"></i></div><span class="app-name">Flash</span></div>
        
        <!-- Web/Fun -->
        <div class="app" onclick="Apps.Browser.open()"><div class="app-icon" style="background:#06b6d4"><i class="fa-solid fa-globe"></i></div><span class="app-name">Web</span></div>
        <div class="app" onclick="Apps.Snake.open()"><div class="app-icon" style="background:#8b5cf6"><i class="fa-solid fa-gamepad"></i></div><span class="app-name">Snake</span></div>
        
        <!-- Tools -->
        <div class="app" onclick="Apps.Conv.open()"><div class="app-icon" style="background:#f97316"><i class="fa-solid fa-scale-balanced"></i></div><span class="app-name">Convert</span></div>
        <div class="app" onclick="Apps.Pass.open()"><div class="app-icon" style="background:#6366f1"><i class="fa-solid fa-key"></i></div><span class="app-name">PassGen</span></div>
        <div class="app" onclick="Apps.Calendar.open()"><div class="app-icon" style="background:#ef4444"><i class="fa-solid fa-calendar"></i></div><span class="app-name">Calendar</span></div>
        <div class="app" onclick="openSettings()"><div class="app-icon" style="background:#64748b"><i class="fa-solid fa-gear"></i></div><span class="app-name">Settings</span></div>
    </div>
</div>

<!-- === MINI APPS WINDOWS === -->

<!-- FILES -->
<div class="window" id="winFiles" style="max-width:600px; height:500px;">
    <div class="win-head">File Manager <button class="ico-btn" onclick="Apps.Files.close()">✕</button></div>
    <div class="win-body" style="display:flex; flex-direction:column;">
        <div style="padding:10px; background:#222; border-bottom:1px solid #333; display:flex; gap:10px;">
            <button style="padding:5px 10px;" onclick="VFS.createFile()">+ File</button>
            <button style="padding:5px 10px;" onclick="VFS.createFolder()">+ Folder</button>
        </div>
        <div id="fileList" style="padding:15px; display:grid; grid-template-columns:repeat(auto-fill, minmax(80px, 1fr)); gap:15px;">
            <!-- Files injected here -->
        </div>
    </div>
</div>

<!-- PAINT/DRAW -->
<div class="window" id="winDraw">
    <div class="win-head">Canvas Studio <button class="ico-btn" onclick="Apps.Draw.close()">✕</button></div>
    <div class="win-body" style="background:#fff; display:flex; justify-content:center; overflow:hidden; cursor:crosshair">
        <canvas id="drawCvs"></canvas>
    </div>
    <div style="padding:10px; background:#222; display:flex; gap:10px;">
        <button onclick="Apps.Draw.setColor('#000')">Black</button>
        <button onclick="Apps.Draw.setColor('#f00')">Red</button>
        <button onclick="Apps.Draw.setColor('#00f')">Blue</button>
        <button onclick="Apps.Draw.clear()" style="margin-left:auto">Clear</button>
    </div>
</div>

<!-- TERMINAL / CODE -->
<div class="window" id="winCode" style="max-width:600px;">
    <div class="win-head">Terminal / Code <button class="ico-btn" onclick="Apps.Code.close()">✕</button></div>
    <div class="win-body" style="background:#0c0c0c; color:#0f0; font-family:monospace; padding:15px;">
        <div id="cliOutput">Welcome to OMNI-SHELL v1.0...</div>
        <div style="display:flex; margin-top:10px;">
            <span style="color:#0f0; margin-right:5px;">$</span>
            <input type="text" id="cliInput" style="flex:1; background:transparent; border:none; color:#fff; font-family:monospace; outline:none;" onkeypress="if(event.key==='Enter') Kernel.cli(this)">
        </div>
    </div>
</div>

<!-- CALENDAR -->
<div class="window" id="winCal" style="width:320px;">
    <div class="win-head">Calendar <button class="ico-btn" onclick="Apps.Calendar.close()">✕</button></div>
    <div class="win-body" style="padding:15px; text-align:center;">
        <h2 id="calMonth" style="margin:0 0 10px;">Month</h2>
        <div style="display:grid; grid-template-columns:repeat(7,1fr); gap:5px;" id="calGrid"></div>
    </div>
</div>

<!-- NOTES -->
<div class="window" id="winNotes" style="max-width:600px; height:60vh;">
    <div class="win-head">Neural Notes <button class="ico-btn" onclick="Apps.Notes.close()">✕</button></div>
    <div class="win-body" style="height:100%; padding:0; display:flex; flex-direction:column;">
        <!-- Notes Actions (Export/Import) -->
        <div id="noteActions" style="padding:10px; background:#222; border-bottom:1px solid #333; display:flex; gap:5px; flex-wrap:wrap;">
            <input type="file" id="noteFileIn" style="display:none" onchange="Notes.handleFileLoad(this)">
            
            <button onclick="document.getElementById('noteFileIn').click()">Load File</button>
            <button onclick="Notes.export('json')">Save JSON</button>
            <button onclick="Notes.export('html')">Save HTML</button>
            <button onclick="Notes.export('txt')">Save TXT</button>
        </div>
        
        <div style="flex: 1; display: flex;">
            <!-- Draft Area (for quick text editing) -->
            <textarea id="notePad" style="flex:1; min-width: 50%; background:#111; color:#eee; border:none; padding:15px; resize:none; outline:none; font-family:monospace;"></textarea>
            
            <!-- Structured Entries List (New Panel) -->
            <div id="noteEntriesList" style="width: 40%; max-width: 250px; background: #0c0c0c; border-left: 1px solid var(--border-color); overflow-y: auto; padding: 10px;">
                <div style="font-size:0.7rem; color:var(--accent); margin-bottom:10px;">SAVED ENTRIES:</div>
                <!-- Entries loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- CALCULATOR -->
<div class="window" id="winCalc">
    <div class="win-head">Calc <button class="ico-btn" onclick="Apps.Calc.close()">✕</button></div>
    <div class="win-body" style="padding:15px;">
        <input type="text" id="calcD" style="width:100%; background:#000; color:#0f0; border:1px solid #333; padding:10px; text-align:right; font-size:1.5rem; margin-bottom:10px;">
        <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:5px;">
            <button style="padding:15px; background:#333; border:1px solid #444; color:#fff" onclick="cIn('7')">7</button>
            <button style="padding:15px; background:#333; border:1px solid #444; color:#fff" onclick="cIn('8')">8</button>
            <button style="padding:15px; background:#333; border:1px solid #444; color:#fff" onclick="cIn('9')">9</button>
            <button style="padding:15px; background:#444; color:#fff" onclick="cIn('/')">/</button>
            <button style="padding:15px; background:#333; border:1px solid #444; color:#fff" onclick="cIn('4')">4</button>
            <button style="padding:15px; background:#333; border:1px solid #444; color:#fff" onclick="cIn('5')">5</button>
            <button style="padding:15px; background:#333; border:1px solid #444; color:#fff" onclick="cIn('6')">6</button>
            <button style="padding:15px; background:#444; color:#fff" onclick="cIn('*')">*</button>
            <button style="padding:15px; background:#333; border:1px solid #444; color:#fff" onclick="cIn('1')">1</button>
            <button style="padding:15px; background:#333; border:1px solid #444; color:#fff" onclick="cIn('2')">2</button>
            <button style="padding:15px; background:#333; border:1px solid #444; color:#fff" onclick="cIn('3')">3</button>
            <button style="padding:15px; background:#444; color:#fff" onclick="cIn('-')">-</button>
            <button style="padding:15px; background:#933; color:#fff" onclick="cClr()">C</button>
            <button style="padding:15px; background:#333; border:1px solid #444; color:#fff" onclick="cIn('0')">0</button>
            <button style="padding:15px; background:#252; color:#fff" onclick="cEq()">=</button>
            <button style="padding:15px; background:#444; color:#fff" onclick="cIn('+')">+</button>
        </div>
    </div>
</div>

<!-- BROWSER -->
<div class="window" id="winBrowser" style="max-width:600px;">
    <div class="win-head">Mini Browser <button class="ico-btn" onclick="Apps.Browser.close()">✕</button></div>
    <div class="win-body" style="height:400px; padding:0; display:flex; flex-direction:column;">
        <div style="padding:5px; background:#333; display:flex;">
            <input type="text" id="urlIn" placeholder="https://" style="flex:1; padding:5px;">
            <button onclick="Apps.Browser.go()">GO</button>
        </div>
        <iframe id="webFrame" style="flex:1; border:none; background:#fff;"></iframe>
    </div>
</div>

<!-- SNAKE -->
<div class="window" id="winSnake">
    <div class="win-head">SNAKE.EXE <button class="ico-btn" onclick="Apps.Snake.close()">✕</button></div>
    <div class="win-body" style="text-align:center; padding:10px;">
        <canvas id="snakeCvs" width="280" height="280" style="background:#000; border:1px solid #333;"></canvas>
        <button onclick="Apps.Snake.start()" style="margin-top:10px; padding:5px 20px;">START</button>
    </div>
</div>

<!-- MUSIC -->
<div class="window" id="winMusic">
    <div class="win-head">Winamp Player <button class="ico-btn" onclick="Apps.Music.close()">✕</button></div>
    <div class="win-body" style="padding:20px; text-align:center;">
        <div style="height:50px; background:#222; display:flex; align-items:flex-end; justify-content:center; gap:3px; margin-bottom:10px;">
            <div class="bar" style="width:5px; height:20px; background:#0f0;"></div>
            <div class="bar" style="width:5px; height:40px; background:#0f0;"></div>
            <div class="bar" style="width:5px; height:30px; background:#0f0;"></div>
            <div class="bar" style="width:5px; height:50px; background:#0f0;"></div>
            <div class="bar" style="width:5px; height:25px; background:#0f0;"></div>
        </div>
        <p>Retro_Wave.mp3</p>
        <div style="display:flex; justify-content:center; gap:10px; margin-top:10px;">
            <button>PREV</button> <button>PLAY</button> <button>NEXT</button>
        </div>
    </div>
</div>

<!-- CONVERTER -->
<div class="window" id="winConv" style="max-width:300px">
    <div class="win-head">Converter <button class="ico-btn" onclick="Apps.Conv.close()">✕</button></div>
    <div class="win-body" style="padding:20px;">
        <input type="number" id="cvIn" placeholder="KM" style="width:100%; padding:10px; margin-bottom:10px;">
        <button onclick="document.getElementById('cvOut').innerText = (document.getElementById('cvIn').value * 1000) + ' m'" style="width:100%; padding:10px;">Convert to Meter</button>
        <div id="cvOut" style="margin-top:10px; color:#0f0; font-size:1.2rem; text-align:center;">0 m</div>
    </div>
</div>

<!-- LIFE MODE -->
<div id="lifeLayer" style="position:fixed; inset:0; background:#000; z-index:150; display:none; flex-direction:column; align-items:center; justify-content:center;">
    <div class="orb-anim" style="width:150px; height:150px; background:var(--primary); border-radius:50%; filter:blur(50px); animation:float 2s infinite ease-in-out; margin-bottom:40px; cursor:pointer;" onclick="toggleMic()"></div>
    <div id="lifeTxt" style="font-size:1.5rem; text-align:center; color:#fff;">Listening...</div>
    <button class="ico-btn" style="margin-top:40px; background:rgba(255,0,0,0.2); color:red; width:50px; height:50px" onclick="closeLifeMode()">✕</button>
</div>

<!-- SETTINGS -->
<div class="window" id="winSettings">
    <div class="win-head">Settings <button class="ico-btn" onclick="closeSettings()">✕</button></div>
    <div class="win-body" style="padding:20px; color:#ccc;">
        <p><b>GEMINI API KEY</b></p>
        <input type="password" id="geminiKeyInput" placeholder="Paste Gemini Key Here..." style="width:100%; padding:8px; background:#222; border:1px solid #444; color:#fff; margin-bottom:10px;" onchange="updateKey(this.value)">
        <div style="font-size:0.7rem; color:#aaa; margin-bottom:15px;">Status: <span id="keyStatus" style="color:var(--danger)">No Key (Using Omni Nexus)</span></div>
        
        <p><b>CUSTOM MODEL NAME</b></p>
        <!-- INPUT BARU UNTUK NAMA MODEL KUSTOM -->
        <input type="text" id="modelNameInput" placeholder="Contoh: OMNI 9000" style="width:100%; padding:8px; background:#222; border:1px solid #444; color:#fff; margin-bottom:15px;" onchange="updateModelName(this.value)">

        <p><b>OMNI NEXUS (AUTO-LEARN)</b></p>
        <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
            <input type="checkbox" id="swBg" onchange="toggleBg()"> 
            <span>Connect to 40+ Public APIs</span>
        </label>
        <p style="font-size:0.7rem; color:#666; margin-top:5px;">System will randomly absorb data from global public nodes.</p>
        
        <hr style="border-color:#333; margin:15px 0;">
        
        <p><b>EXPORT BRAIN DATA</b></p>
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <button style="flex:1; padding:10px; background:#333; color:#fff; border:1px solid #555;" onclick="exportData('json')">JSON</button>
            <button style="flex:1; padding:10px; background:#333; color:#fff; border:1px solid #555;" onclick="exportData('html')">HTML</button>
            <button style="flex:1; padding:10px; background:#333; color:#fff; border:1px solid #555;" onclick="exportData('txt')">TXT</button>
        </div>
        
        <!-- NEW LOAD SECTION -->
        <p style="margin-top:15px; margin-bottom:5px;"><b>IMPORT BRAIN DATA</b></p>
        <input type="file" id="brainFileIn" style="display:none" accept=".json,.txt,.html" onchange="Brain.handleFileLoad(this)">
        <button style="width:100%; padding:10px; background:#553; color:#fff; border:1px solid #775;" onclick="document.getElementById('brainFileIn').click()">LOAD FILE</button>
        <!-- END NEW LOAD SECTION -->


        <button style="width:100%; padding:10px; margin-top:15px; background:#400; color:#f99; border:1px solid #f55;" onclick="wipe()">Wipe Memory</button>
    </div>
</div>

<!-- CODE PREVIEW -->
<div id="codePreview" style="position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:300; display:none; flex-direction:column; align-items:center; justify-content:center;">
    <iframe id="prevFrame" style="width:90%; height:80%; background:#fff; border-radius:10px;"></iframe>
    <button onclick="document.getElementById('codePreview').style.display='none'" style="margin-top:10px; padding:10px 20px;">Close</button>
</div>

<script>
/**
 * AI OMNI-OS v19.7 (GRANULAR WORD TOKENIZATION)
 */

// --- GLOBAL APP DECLARATION (FIXED: Moved to top) ---
// Deklarasi global untuk objek Apps (agar bisa diakses dari HTML)
let snakeInt;
let snakeHandlersAdded = false;

// NOTE ENTRIES CONSTANT
const NOTE_STORE_NAME = 'structured_notes';

// FUNGSI BARU: Logic Notes terstruktur
const Notes = {
    save: () => {
        if (!db) return;
        const mainText = document.getElementById('notePad').value;
        
        // Simpan draf utama
        db.transaction('notes','readwrite').objectStore('notes').put(mainText, 'main');
        // Simpan entri terstruktur
        db.transaction(NOTE_STORE_NAME,'readwrite').objectStore(NOTE_STORE_NAME).put(state.structuredNotes, 'entries');
        
        Kernel.notify("Notes Saved.");
    },
    load: () => {
        if (!db) return;
        
        // 1. Load Draft
        db.transaction('notes','readonly').objectStore('notes').get('main').onsuccess=e=>{ 
            if(e.target.result && document.getElementById('notePad')) {
                 document.getElementById('notePad').value=e.target.result;
            }
        };

        // 2. Load Structured Entries
        db.transaction(NOTE_STORE_NAME,'readonly').objectStore(NOTE_STORE_NAME).get('entries').onsuccess=e=>{ 
            if(e.target.result) {
                state.structuredNotes = e.target.result;
            } else {
                state.structuredNotes = [];
            }
            Notes.renderEntries();
        };
    },
    renderEntries: () => {
        const list = document.getElementById('noteEntriesList');
        if (!list) return;

        list.innerHTML = `<div style="font-size:0.7rem; color:var(--accent); margin-bottom:10px;">SAVED ENTRIES:</div>`;

        if (state.structuredNotes.length === 0) {
            list.innerHTML += `<div style="font-size:0.8rem; color:var(--text-dim); opacity: 0.5;">No entries yet.</div>`;
            return;
        }

        state.structuredNotes.forEach((entry, index) => {
            const preview = entry.content.substring(0, 50) + (entry.content.length > 50 ? '...' : '');
            const date = new Date(entry.date).toLocaleDateString('id-ID');
            
            list.innerHTML += `
                <div style="background:rgba(255,255,255,0.05); padding:8px; margin-bottom:5px; border-radius:4px; border-left: 3px solid var(--primary);">
                    <div style="font-size:0.85rem; font-weight:bold; color:#fff;">Note #${index + 1}</div>
                    <div style="font-size:0.7rem; color:var(--text-dim); margin-top:2px;">${preview}</div>
                    <div style="font-size:0.6rem; color:#666; margin-top:5px;">${date} 
                        <span style="float:right;">
                            <i class="fa-solid fa-eye" style="cursor:pointer;" onclick="Notes.viewEntry(${index})"></i> 
                            <i class="fa-solid fa-trash-can" style="cursor:pointer; color: var(--danger); margin-left: 5px;" onclick="Notes.deleteEntry(${index})"></i>
                        </span>
                    </div>
                </div>
            `;
        });
    },
    viewEntry: (index) => {
        const entry = state.structuredNotes[index];
        if (!entry) return;
        
        // Tambahkan ke NotePad untuk dilihat/diedit
        document.getElementById('notePad').value = `--- NOTE ENTRY ${index + 1} (${new Date(entry.date).toLocaleString()}) ---\n\n${entry.content}`;
        Kernel.notify(`Viewing Note #${index + 1}`);
    },
    deleteEntry: (index) => {
        if (confirm(`Are you sure you want to delete Note #${index + 1}?`)) {
            state.structuredNotes.splice(index, 1);
            Notes.save();
            Notes.renderEntries();
            Kernel.notify(`Note #${index + 1} Deleted.`);
        }
    },
    saveChatToNotes: (text) => {
        state.structuredNotes.push({
            id: Date.now(),
            date: Date.now(),
            content: text.replace(/<[^>]+>/g, '').trim() // Hapus tag HTML dari chat output
        });
        Notes.save();
        Notes.renderEntries();
        Kernel.notify("Chat saved as a new Note entry.");
        
        // Scroll to the new entry
        setTimeout(() => {
            const list = document.getElementById('noteEntriesList');
            list.scrollTop = list.scrollHeight;
        }, 100);
    },
    handleFileLoad: (input) => {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = e => {
            const content = e.target.result;
            const ext = file.name.split('.').pop().toLowerCase();
            
            if (ext === 'json') {
                try {
                    const loadedNotes = JSON.parse(content);
                    if (Array.isArray(loadedNotes) && loadedNotes[0].id) {
                        state.structuredNotes = loadedNotes;
                        Notes.save();
                        Notes.renderEntries();
                        Kernel.notify(`Loaded ${loadedNotes.length} entries from JSON.`);
                    } else {
                         Kernel.notify("JSON format invalid. Loading to NotePad.");
                         document.getElementById('notePad').value = content;
                    }
                } catch(err) {
                    Kernel.notify("Error parsing JSON. Check console.");
                    console.error("JSON Parse Error:", err);
                    document.getElementById('notePad').value = content; // Fallback to notepad
                }
            } else {
                document.getElementById('notePad').value = content;
                Kernel.notify(`Loaded .${ext} content to NotePad.`);
            }
        };
        reader.readAsText(file);
    },
    export: (format) => {
        let content;
        let mimeType;
        let ext = format;
        const notesToExport = state.structuredNotes;
        const title = `Neural Notes Export (${new Date().toISOString().slice(0, 10)})`;

        if (format === 'json') {
            content = JSON.stringify(notesToExport, null, 2);
            mimeType = 'application/json';
        } else if (format === 'txt') {
            content = `${title}\n\n--- Entries ---\n`;
            notesToExport.forEach((entry, i) => {
                content += `\n[ENTRY #${i + 1} | ${new Date(entry.date).toLocaleString()}]\n${entry.content}\n`;
            });
            mimeType = 'text/plain';
        } else if (format === 'html') {
            content = `
                <html><head><title>${title}</title><style>body{font-family:sans-serif; background:#111; color:#eee; padding:20px;} .entry{border:1px solid #333; margin:10px 0; padding:15px; border-radius:8px;} .date{font-size:0.8em; color:#aaa;}</style></head>
                <body><h1>${title}</h1>`;
            notesToExport.forEach((entry, i) => {
                content += `<div class="entry"><h3>Entry #${i + 1}</h3><p class="date">${new Date(entry.date).toLocaleString()}</p><p>${entry.content}</p></div>`;
            });
            content += `</body></html>`;
            mimeType = 'text/html';
        } else {
            Kernel.notify("Invalid export format.");
            return;
        }

        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        a.href = url;
        a.download = `neural_notes_export.${ext}`;
        a.click();
        
        URL.revokeObjectURL(url);
        Kernel.notify(`Notes Exported as .${ext}`);
    }
}

const Apps = {
    Launcher: { open:()=>document.getElementById('appDrawer').classList.add('open'), close:()=>document.getElementById('appDrawer').classList.remove('open') },
    Notes: { 
        open:()=>{ Apps.Launcher.close(); document.getElementById('winNotes').style.display='flex'; Notes.renderEntries(); }, 
        close:()=>{ document.getElementById('winNotes').style.display='none'; Notes.save(); }, 
        load:()=>{ if(db) Notes.load(); } 
    },
    Calc: { open:()=>{ Apps.Launcher.close(); document.getElementById('winCalc').style.display='flex' }, close:()=>document.getElementById('winCalc').style.display='none' },
    Snake: { 
        open:()=>{ 
            Apps.Launcher.close(); 
            document.getElementById('winSnake').style.display='flex'; 
            initSnake(); 
        }, 
        close:()=>{ 
            document.getElementById('winSnake').style.display='none';
            if(snakeInt) clearInterval(snakeInt); 
        },
        start: () => { initSnake(); }
    },
    Browser: { open:()=>{ Apps.Launcher.close(); document.getElementById('winBrowser').style.display='flex' }, close:()=>document.getElementById('winBrowser').style.display='none', go:()=>{document.getElementById('webFrame').src='https://'+document.getElementById('urlIn').value} },
    Music: { open:()=>{ Apps.Launcher.close(); document.getElementById('winMusic').style.display='flex' }, close:()=>document.getElementById('winMusic').style.display='none' },
    Flash: { open:()=>{ Apps.Launcher.close(); document.body.style.background='#fff'; setTimeout(()=>document.body.style.background='var(--bg-color)', 1000) } },
    Code: { open:()=>{ Apps.Launcher.close(); document.getElementById('winCode').style.display='flex'; }, close:()=>document.getElementById('winCode').style.display='none' },
    Draw: { open:()=>{ Apps.Launcher.close(); document.getElementById('winDraw').style.display='flex'; initDraw(); }, close:()=>document.getElementById('winDraw').style.display='none', clear:()=>{ const c=document.getElementById('drawCvs'); c.getContext('2d').clearRect(0,0,c.width,c.height); }, setColor:(c)=>{ document.getElementById('drawCvs').getContext('2d').strokeStyle=c; } },
    Pass: { open:()=>{ Apps.Launcher.close(); alert("Pass: "+Math.random().toString(36).slice(-8)); } },
    Conv: { open:()=>{ Apps.Launcher.close(); document.getElementById('winConv').style.display='flex'; }, close:()=>document.getElementById('winConv').style.display='none' },
    Files: { open:()=>{ Apps.Launcher.close(); document.getElementById('winFiles').style.display='flex'; VFS.render(); }, close:()=>document.getElementById('winFiles').style.display='none' },
    Calendar: { open:()=>{ Apps.Launcher.close(); document.getElementById('winCal').style.display='flex'; initCal(); }, close:()=>document.getElementById('winCal').style.display='none' }
};

// --- KERNEL & UTILS ---
function toggleMenu(id) { 
    document.querySelectorAll('.menu').forEach(m => {
        if(m.id !== id) m.classList.remove('show');
    });
    document.getElementById(id).classList.toggle('show'); 
}

function toggleTerminal() {
    document.getElementById('term').classList.toggle('show');
}

// Global variable for silence timer
let silenceTimer;

const Kernel = {
    boot: () => {
        Kernel.log("Booting Omni-OS Kernel...");
        DB.init().then(() => {
            Kernel.log("Database Mounted.");
            Brain.load();
            Apps.Notes.load(); // Load Notes entries
            VFS.init();
            checkKey(); // Cek kunci saat boot
            // Load custom model name
            const savedName = localStorage.getItem('custom_model_name');
            state.modelName = savedName || 'GEMINI 2.5 FLASH';
            if(document.getElementById('modelNameInput')) document.getElementById('modelNameInput').value = state.modelName;
            
        }).catch(err => Kernel.log("DB Error: " + err));
        
        // Voice Init
        if(window.SpeechRecognition || window.webkitSpeechRecognition) {
            try {
                const R = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new R(); 
                recognition.lang = 'id-ID';
                recognition.continuous = false;
                
                recognition.onstart = () => {
                    state.isMic = true;
                    if(state.isLife) {
                        document.getElementById('lifeTxt').innerText = "Mendengarkan...";
                        document.querySelector('.orb-anim').style.animation = "pulse-ring 1.5s infinite";
                    }
                };

                recognition.onresult = e => {
                    const t = e.results[0][0].transcript;
                    document.getElementById('inp').value = t;
                    
                    if(state.isLife) { 
                        document.getElementById('lifeTxt').innerText = `"${t}"`;
                        clearTimeout(silenceTimer);
                        // Wait for a pause before processing
                        silenceTimer = setTimeout(() => {
                            recognition.stop(); 
                            handleInput();
                        }, 1000); 
                    } else {
                        handleInput();
                    }
                };

                recognition.onend = () => { 
                    state.isMic = false;
                    const orb = document.querySelector('.orb-anim');
                    if (orb) orb.style.animation = "float 2s infinite ease-in-out";
                    
                    // Logic Auto-Restart:
                    if(state.isLife && !state.isSpeaking && !state.isProcessing) {
                        setTimeout(() => {
                            try { recognition.start(); } catch(e){}
                        }, 500); 
                    }
                };
            } catch(e) {
                console.warn("Speech API error", e);
            }
        }
    },
    log: (msg) => {
        console.log(`[KERNEL] ${msg}`);
        const t = document.getElementById('term');
        if(t) {
            t.innerHTML += `<div>> ${msg}</div>`;
            t.scrollTop = t.scrollHeight;
        }
    },
    notify: (msg) => {
        const c = document.getElementById('notifContainer');
        const n = document.createElement('div');
        n.className = 'toast';
        n.innerText = msg;
        c.appendChild(n);
        setTimeout(() => n.remove(), 3000);
    },
    cli: (el) => {
        const cmd = el.value.trim();
        el.value = "";
        const out = document.getElementById('cliOutput');
        out.innerHTML += `<div>$ ${cmd}</div>`;
        
        if(cmd === 'help') out.innerHTML += `<div style="color:#aaa">Commands: help, clear, date, reboot, ls</div>`;
        else if(cmd === 'clear') out.innerHTML = "";
        else if(cmd === 'date') out.innerHTML += `<div>${new Date().toLocaleString()}</div>`;
        else if(cmd === 'reboot') location.reload();
        else if(cmd === 'ls') out.innerHTML += `<div>Files: ${Object.keys(VFS.data).join(', ')}</div>`;
        else out.innerHTML += `<div style="color:red">Command not found</div>`;
        
        out.scrollTop = out.scrollHeight;
    }
};

// --- VIRTUAL FILE SYSTEM (VFS) ---
const VFS = {
    data: {},
    init: () => {
        VFS.data = { 'readme.txt': 'Welcome to Omni-OS', 'config.sys': 'mode=god' };
        VFS.render();
    },
    createFile: () => {
        const name = prompt("File name:");
        if(name) { VFS.data[name] = ""; VFS.render(); Kernel.notify("File Created"); }
    },
    createFolder: () => alert("Folders coming in v17.1"),
    render: () => {
        const c = document.getElementById('fileList');
        if(!c) return;
        c.innerHTML = "";
        for(let f in VFS.data) {
            c.innerHTML += `
            <div style="display:flex; flex-direction:column; align-items:center; cursor:pointer;" onclick="alert('Content: '+VFS.data['${f}'])">
                <i class="fa-solid fa-file-lines" style="font-size:2rem; color:var(--text-dim)"></i>
                <span style="font-size:0.7rem; margin-top:5px;">${f}</span>
            </div>`;
        }
    }
};

// FILE PARSER MODULE
const FileParser = {
    read: async (file) => {
        const ext = file.name.split('.').pop().toLowerCase();
        if (ext === 'txt' || ext === 'md' || ext === 'csv' || ext === 'html' || ext === 'js' || ext === 'css' || ext === 'json') {
            return await FileParser.readText(file);
        } else if (ext === 'pdf') {
            return await FileParser.readPDF(file);
        } else if (ext === 'docx') {
            return await FileParser.readDOCX(file);
        } else if (ext === 'pptx') {
            return await FileParser.readPPTX(file);
        } else {
            return "Format file tidak didukung untuk analisis teks mendalam.";
        }
    },
    readText: (file) => {
        return new Promise((resolve) => {
            const r = new FileReader();
            r.onload = e => resolve(e.target.result);
            r.readAsText(file);
        });
    },
    readPDF: async (file) => {
        const ab = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({data: ab}).promise;
        let text = "";
        for(let i=1; i<=pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            text += content.items.map(item => item.str).join(" ") + "\n";
        }
        return text;
    },
    readDOCX: async (file) => {
        const ab = await file.arrayBuffer();
        const res = await mammoth.extractRawText({arrayBuffer: ab});
        return res.value;
    },
    readPPTX: async (file) => {
        const ab = await file.arrayBuffer();
        const zip = await JSZip.loadAsync(ab);
        let text = "";
        const slideFiles = Object.keys(zip.files).filter(f => f.startsWith("ppt/slides/slide") && f.endsWith(".xml"));
        slideFiles.sort((a,b) => {
            const na = parseInt(a.match(/\d+/)[0]);
            const nb = parseInt(b.match(/\d+/)[0]);
            return na - nb;
        });
        for(const f of slideFiles) {
            const xml = await zip.file(f).async("string");
            const slideText = xml.replace(/<[^>]+>/g, " ");
            text += `[Slide]: ${slideText}\n`;
        }
        return text;
    }
};

// --- DATABASE & STATE ---
const DB_NAME = "Genesis_Prime_v17";

// == OMNI NEXUS: 40+ PUBLIC APIS ==
const API_NEXUS = {
    // ENTERTAINMENT & TRENDS (20)
    ent: {
        movie: { u: "https://api.tvmaze.com/search/shows?q=", p: d => `TV/Movie: ${d[0]?.show?.name} (${d[0]?.show?.premiered?.slice(0,4) || 'N/A'}) - Rating: ${d[0]?.show?.rating?.average || '?'}/10` },
        anime: { u: "https://api.jikan.moe/v4/anime?q=", p: d => `Anime: ${d.data[0]?.title} (${d.data[0]?.year || '?'}) - Score: ${d.data[0]?.score}` },
        music: { u: "https://itunes.apple.com/search?media=music&limit=1&term=", p: d => `Music: ${d.results[0]?.trackName} by ${d.results[0]?.artistName}` },
        book: { u: "https://openlibrary.org/search.json?limit=1&q=", p: d => `Book: ${d.docs[0]?.title} by ${d.docs[0]?.author_name?.[0]}` },
        game: { u: "https://www.speedrun.com/api/v1/games?name=", p: d => `Game: ${d.data[0]?.names?.international} (Released: ${d.data[0]?.release_date})` },
        deal: { u: "https://www.cheapshark.com/api/1.0/games?limit=1&title=", p: d => `Game Deal: ${d[0]?.external} - Cheapest: $${d[0]?.cheapest}` },
        pokemon: { u: "https://pokeapi.co/api/v2/pokemon/", p: d => `Pokemon: ${d.name.toUpperCase()} (Type: ${d.types[0].type.name})` },
        crypto: { u: "https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,dogecoin&vs_currencies=usd", p: d => `Crypto: BTC $${d.bitcoin.usd} | ETH $${d.ethereum.usd}` },
        joke: { u: "https://v2.jokeapi.dev/joke/Any?type=single", p: d => `Joke: ${d.joke}` },
        meme: { u: "https://api.imgflip.com/get_memes", p: d => `Trending Meme: ${d.data.memes[Math.floor(Math.random()*10)].name}` },
        activity: { u: "https://www.boredapi.com/api/activity", p: d => `Idea: ${d.activity}` },
        dog: { u: "https://dog.ceo/api/breeds/image/random", p: d => `Dog: Image Fetched [${d.status}]` },
        cat: { u: "https://api.thecatapi.com/v1/images/search", p: d => `Cat: Image Fetched` },
        techy: { u: "https://techy-api.vercel.app/api/json", p: d => `Tech Wisdom: "${d.message}"` },
        quote: { u: "https://api.kanye.rest", p: d => `Quote: "${d.quote}"` },
        advice: { u: "https://api.adviceslip.com/advice", p: d => `Advice: ${d.slip.advice}` },
        gender: { u: "https://api.genderize.io/?name=", p: d => `Gender Pred: ${d.name} is likely ${d.gender} (${d.probability*100}%)` },
        age: { u: "https://api.agify.io/?name=", p: d => `Age Pred: ${d.name} is approx ${d.age} years old` },
        nation: { u: "https://api.nationalize.io/?name=", p: d => `Nationality: ${d.name} is from ${d.country[0]?.country_id}` },
        ip: { u: "https://ipapi.co/json/", p: d => `Your IP: ${d.ip} (${d.city}, ${d.country_name})` }
    },
    // KNOWLEDGE & SCIENCE (20)
    know: {
        wiki_id: { u: "https://id.wikipedia.org/w/api.php?action=query&list=search&format=json&origin=*&srsearch=", p: d => d.query.search[0]?.snippet.replace(/<[^>]*>?/gm, '') },
        wiki_en: { u: "https://en.wikipedia.org/w/api.php?action=query&list=search&format=json&origin=*&srsearch=", p: d => d.query.search[0]?.snippet.replace(/<[^>]*>?/gm, '') },
        math: { u: "https://newton.now.sh/api/v2/simplify/", p: d => `Math: ${d.operation} -> ${d.result}` },
        dict: { u: "https://api.dictionaryapi.dev/api/v2/entries/en/", p: d => `Def: ${d[0]?.word} - ${d[0]?.meanings[0]?.definitions[0]?.definition}` },
        nasa: { u: "https://api.nasa.gov/planetary/apod?api_key=DEMO_KEY", p: d => `NASA APOD: ${d.title} (Date: ${d.date})` },
        space: { u: "https://api.spaceflightnewsapi.net/v3/articles?_limit=1", p: d => `Space News: ${d[0]?.title}` },
        science: { u: "https://api.plos.org/search?q=title:", p: d => `Journal: ${d.response.docs[0]?.title_display}` },
        weather: { u: "https://api.open-meteo.com/v1/forecast?latitude=-6.2&longitude=106.8&current_weather=true", p: d => `Weather: ${d.current_weather.temperature}°C (Wind: ${d.current_weather.windspeed})` },
        country: { u: "https://restcountries.com/v3.1/name/", p: d => `Country: ${d[0]?.name?.common} (Pop: ${d[0]?.population})` },
        bank: { u: "https://api.worldbank.org/v2/country/br?format=json", p: d => `World Data: ${d[1][0]?.name} - Capital: ${d[1][0]?.capitalCity}` },
        food: { u: "https://world.openfoodfacts.org/api/v0/product/", p: d => `Product: ${d.product?.product_name}` }, 
        vocab: { u: "https://api.datamuse.com/words?rel_rhy=", p: d => `Rhyme: ${d[0]?.word}, ${d[1]?.word}, ${d[2]?.word}` },
        trivia: { u: "http://numbersapi.com/random/math", p: d => d }, 
        postal: { u: "https://api.zippopotam.us/us/", p: d => `Zip Info: ${d.places[0]['place name']}` },
        univ: { u: "http://universities.hipolabs.com/search?name=", p: d => `Univ: ${d[0]?.name} (${d[0]?.country})` },
        air: { u: "https://docs.openaq.org/v2/latest?limit=1", p: d => `Air Quality: ${d.results[0]?.location} - PM2.5` },
        bible: { u: "https://bible-api.com/john 3:16", p: d => `Verse: ${d.text}` },
        user: { u: "https://randomuser.me/api/", p: d => `Persona: ${d.results[0].name.first} ${d.results[0].name.last}` },
        tech: { u: "https://api.duckduckgo.com/?q=linux&format=json", p: d => `DDG: ${d.AbstractSource}` },
        news: { u: "https://id.wikinews.org/w/api.php?action=query&list=search&format=json&origin=*&srsearch=", p: d => `News: ${d.query.search[0]?.title}` }
    }
};

let db;
let brain = { logic: { facts: [], wordMap: {} }, fun: { facts: [], wordMap: {} } };
let state = { cap: 'normal', mode: 'chat', isCam: false, isLife: false, isMic: false, bgActive: false, isLooping: false, isSpeaking: false, isProcessing: false, isGeminiConnected: false, modelName: 'GEMINI 2.5 FLASH', structuredNotes: [] };
let recognition, stream, model, bgInt;
let pendingFile = null;

const DB = {
    init: () => {
        return new Promise((resolve, reject) => {
            const req = indexedDB.open(DB_NAME, 2); // Increased version for new store
            req.onupgradeneeded = e => {
                const d = e.target.result;
                if(!d.objectStoreNames.contains('cortex')) d.createObjectStore('cortex');
                if(!d.objectStoreNames.contains('notes')) d.createObjectStore('notes');
                // New store for structured entries
                if(!d.objectStoreNames.contains(NOTE_STORE_NAME)) d.createObjectStore(NOTE_STORE_NAME); 
            };
            req.onsuccess = e => { db = e.target.result; resolve(); };
            req.onerror = e => reject(e);
        });
    }
};

// --- LOGIC ENGINE ---
function saveBrain() {
    if(db) db.transaction('cortex','readwrite').objectStore('cortex').put(brain, 'main');
    updateStats();
}

// PERBAIKAN V19.7: Tokenisasi Granular
// Helper untuk memecah teks menjadi semua kata (termasuk kata pendek) dan menormalisasi.
function tokenize(text) {
    // Memecah berdasarkan spasi dan menghilangkan karakter non-alfanumerik/spasi
    return text.toLowerCase()
               .split(/\s+/) 
               .filter(word => word.length >= 1) // Membiarkan kata pendek, hanya memfilter string kosong
               .map(word => word.replace(/[^a-z0-9]/g, '')); // Hapus semua non-alphanumeric
}


// PERBAIKAN V19.7: Mengubah train untuk menyimpan SEMUA TOKEN
function train(text, type='logic') {
    if(!text || text.length<3) return;
    let target = brain[type];
    
    // 1. Simpan fakta penuh (seperti sebelumnya)
    target.facts.push(text.substring(0,200));
    if(target.facts.length>500) target.facts.shift();
    
    // 2. Tokenisasi dan simpan peta kata
    const tokens = tokenize(text);
    tokens.forEach(token => {
        if (!target.wordMap[token]) {
            target.wordMap[token] = 0;
        }
        target.wordMap[token]++;
    });

    saveBrain();
}

const FALLBACK_RESPONSES = [
    "Saya perlu data lebih lanjut untuk menjawab itu.",
    "Informasi itu tidak ada di basis data memori lokal saya.",
    "Bisakah Anda memberikan lebih banyak konteks mengenai hal itu?",
    "Pertanyaan yang menarik, namun saya tidak memiliki fakta yang relevan saat ini.",
    "Memori saya tidak mencatat topik tersebut. Coba dengan kata kunci lain.",
    "Saya sedang memperluas basis pengetahuan saya. Tunggu sebentar.",
    "Saat ini data mengenai subjek tersebut belum diserap oleh memori.",
    "Mari kita cari tahu hal lain dulu."
];

// FUNGSI BARU: Logic Word Chain (Offline)
function chainWordGenerate(seedWord) {
    const target = brain.logic.facts;
    if (target.length < 5) return null; // Butuh minimal 5 fakta untuk chain yang baik

    let chain = [];
    const seedLower = seedWord.toLowerCase().replace(/[^a-z0-9]/g, '');
    let currentToken = seedLower;
    const maxChainLength = 5;
    const usedIndices = new Set();
    
    // Gunakan fakta yang mengandung SEED sebagai titik awal
    let potentialFacts = target.map((fact, index) => ({ fact, index }))
        .filter(item => tokenize(item.fact).includes(seedLower));

    if (potentialFacts.length === 0) {
        // Jika seed tidak ditemukan, coba token paling populer di WordMap
        const wordMap = brain.logic.wordMap;
        const popularToken = Object.keys(wordMap).sort((a, b) => wordMap[b] - wordMap[a])[0];
        if (popularToken) {
            currentToken = popularToken;
            potentialFacts = target.map((fact, index) => ({ fact, index }))
                .filter(item => tokenize(item.fact).includes(popularToken));
        }
    }
    
    if (potentialFacts.length === 0) return null;


    for (let i = 0; i < maxChainLength && potentialFacts.length > 0; i++) {
        // Pilih fakta secara acak dari yang cocok dan belum digunakan
        const selectedIndex = Math.floor(Math.random() * potentialFacts.length);
        const selected = potentialFacts[selectedIndex];
        
        // Hapus fakta yang dipilih dari potensi fakta
        potentialFacts.splice(selectedIndex, 1);
        usedIndices.add(selected.index);
        
        chain.push(selected.fact);

        // Cari token berikutnya (token setelah currentToken)
        const factTokens = tokenize(selected.fact);
        const matchIndex = factTokens.indexOf(currentToken);
        
        if (matchIndex !== -1 && matchIndex + 1 < factTokens.length) {
            currentToken = factTokens[matchIndex + 1];
        } else {
            // Jika token tidak ditemukan atau di akhir kalimat, ambil token populer secara acak
            const popularTokens = Object.keys(brain.logic.wordMap);
            currentToken = popularTokens[Math.floor(Math.random() * popularTokens.length)];
        }
        
        // Cek kembali pool potentialFacts berdasarkan currentToken baru
        potentialFacts = target.map((fact, index) => ({ fact, index }))
            .filter(item => tokenize(item.fact).includes(currentToken) && !usedIndices.has(item.index));
    }

    if (chain.length > 1) {
        // PERBAIKAN V19.6: Format output menjadi daftar terpisah
        const formattedChain = chain.map((fact, i) => `• ${fact}`).join('<br>');
        return `<b>[Word Chain Analysis] Berdasarkan '${seedWord}' ditemukan ${chain.length} fakta:</b><br>${formattedChain}`;
    }
    return null; // Gagal membuat rantai yang memuaskan
}


// PERBAIKAN V19.6: Modify generate to return multiple facts as a single HTML string
function generate(seed) {
    let target = brain.logic;
    if(state.mode === 'entertainment') target = brain.fun;
    
    // Periksa apakah input adalah satu kata (untuk logika Word Chain baru)
    const words = seed.trim().split(/\s+/);
    if (words.length === 1 && words[0].length >= 1) { // Memungkinkan satu huruf/angka sebagai seed
        const chainResult = chainWordGenerate(words[0]);
        if (chainResult) return chainResult;
    }
    
    if(target.facts.length === 0) {
        const fallback = FALLBACK_RESPONSES[Math.floor(Math.random() * FALLBACK_RESPONSES.length)];
        return fallback;
    }
    
    // Tokenisasi input seed
    const seedTokens = tokenize(seed);
    const maxFacts = 5;
    const relatedFacts = new Set();
    
    // 1. Kumpulkan fakta yang relevan (hingga maxFacts)
    for (const token of seedTokens) {
        for (const fact of target.facts) {
            if (tokenize(fact).includes(token)) {
                relatedFacts.add(fact);
                if (relatedFacts.size >= maxFacts) break;
            }
        }
        if (relatedFacts.size >= maxFacts) break;
    }
    
    // Konversi Set ke Array
    let finalFacts = Array.from(relatedFacts);
    
    // 2. Jika kurang dari maxFacts, isi sisanya dengan fakta acak
    if (finalFacts.length < maxFacts) {
        const needed = maxFacts - finalFacts.length;
        for (let i = 0; i < needed; i++) {
            const randomFact = target.facts[Math.floor(Math.random() * target.facts.length)];
            if (!finalFacts.includes(randomFact)) {
                finalFacts.push(randomFact);
            }
        }
    }

    if (finalFacts.length > 0) {
        // PERBAIKAN V19.6: Format output menjadi daftar terpisah
        const formattedList = finalFacts.map((fact, i) => `• ${fact}`).join('<br>');
        return formattedList;
    }
    
    // Final fallback
    const fallback = FALLBACK_RESPONSES[Math.floor(Math.random() * FALLBACK_RESPONSES.length)];
    return fallback;
}

// PERUBAHAN: Menambahkan systemPrompt
async function callGemini(prompt, systemPrompt, key) {
    try {
        const modelUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
        
        const payload = {
            contents: [{parts:[{text:prompt}]}],
            systemInstruction: { parts: [{ text: systemPrompt }] }
        };

        const res = await fetch(modelUrl, { 
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify(payload)
        });
        const d = await res.json();
        
        if (d.candidates?.[0]?.content?.parts?.[0]?.text) {
            return d.candidates?.[0]?.content?.parts?.[0]?.text;
        } else if (d.error) {
            
            if (d.error.code === 403 || d.error.status === "PERMISSION_DENIED") {
                state.isGeminiConnected = false;
                updateGeminiButton(false);
                Kernel.notify(`⚠️ API KEY BOCOR/DITOLAK. Ganti key di Settings.`);
            }

            Kernel.notify(`Gemini API Error (${d.error.code || d.error.status}): ${d.error.message.substring(0, 50)}...`);
            console.error("[GEMINI API ERROR]", d.error);
            return null;
        } else {
            Kernel.notify("Gemini: Empty response.");
            return null;
        }

    } catch(e) { 
        Kernel.notify("Gemini Network Error.");
        console.error("[GEMINI NETWORK CATCH]", e);
        return null; 
    }
}

// SMART ROUTER FOR 40+ APIS
async function nexusFetch(query, type) {
    try {
        let endpoint, parser, url;
        const q = encodeURIComponent(query);
        
        if(API_NEXUS.ent[type]) { 
            endpoint = API_NEXUS.ent[type]; 
        } else if (API_NEXUS.know[type]) {
            endpoint = API_NEXUS.know[type];
        } else {
            return null;
        }

        url = endpoint.u.includes('=') ? endpoint.u + q : endpoint.u;
        if(type==='math') url = endpoint.u + q.replace(/ /g,''); 
        
        Kernel.log(`NEXUS: Connecting to [${type.toUpperCase()}] node...`);
        
        const res = await fetch(url);
        
        // FIX V18.8: Check for non-OK HTTP status (e.g., 404, 500)
        if (!res.ok) {
            Kernel.log(`NEXUS Error: ${res.status} for ${type.toUpperCase()}`);
            return `Nexus Node [${type.toUpperCase()}] returned status ${res.status}.`;
        }

        const json = await res.json().catch(e => {
            // This catches errors when res.json() fails (e.g., non-JSON response)
            Kernel.log(`NEXUS Parse Error on ${type.toUpperCase()}: ${e.message}`);
            return res.text(); // Fallback to raw text if JSON fails
        }); 
        
        const result = typeof json === 'string' ? json : endpoint.p(json);
        return result || "Node returned empty data.";

    } catch(e) { 
        // This catches the 'Failed to fetch' (CORS/Network error)
        Kernel.notify(`Nexus Error: Connection failed to ${type.toUpperCase()}`); // Notify user
        console.error(`[NEXUS CATCH ${type.toUpperCase()}]`, e);
        return "Nexus Link Broken (CORS/Network Error)."; 
    }
}

// --- BRAIN MANAGER ---
function Brain() {}

const INITIAL_LOGIC_FACTS = [
    "Matahari adalah pusat tata surya kita, menyediakan cahaya dan energi.",
    "Algoritma adalah serangkaian instruksi logis untuk menyelesaikan tugas tertentu.",
    "Indonesia merupakan negara kepulauan terbesar di dunia dengan ribuan pulau.",
    "Untuk membuat kode, programmer sering menggunakan bahasa seperti JavaScript atau Python.",
    "Perubahan iklim adalah isu global yang memerlukan perhatian serius dari semua negara.",
    "Matematika adalah bahasa universal yang membantu kita memahami pola alam semesta."
];

const INITIAL_FUN_FACTS = [
    "Kucing menghabiskan sekitar dua pertiga hari mereka untuk tidur.",
    "Tawa yang keras dapat membakar kalori, menjadikannya latihan yang menyenangkan.",
    "Minum kopi sebelum berolahraga dapat meningkatkan kinerja fisik.",
    "Beberapa jenis ubur-ubur secara teknis abadi dan dapat membalikkan proses penuaan mereka.",
    "Membuat kue membutuhkan ketepatan takaran dan kesabaran untuk menghasilkan rasa yang enak."
];

Brain.load = function() {
    try {
        const tx = db.transaction('cortex').objectStore('cortex').get('main');
        tx.onsuccess = e => {
            let needsSeeding = false;
            
            if(e.target.result) {
                brain = e.target.result;
            } else {
                needsSeeding = true;
            }
            
            // Ensure brain structure is correct, especially wordMap
            if(!brain.logic || !brain.logic.wordMap) {
                 brain = { 
                     logic: { facts: brain.logic?.facts || [], wordMap: {} }, 
                     fun: { facts: brain.fun?.facts || [], wordMap: {} } 
                 }; 
                 if (brain.logic.facts.length === 0) needsSeeding = true;
            }

            // PERBAIKAN V19.5: Seed the brain if it is completely empty
            if (needsSeeding) {
                Kernel.log("Seeding brain with initial data...");
                INITIAL_LOGIC_FACTS.forEach(fact => train(fact, 'logic'));
                INITIAL_FUN_FACTS.forEach(fact => train(fact, 'fun'));
            }

            updateStats();
        };
    } catch(e) { console.log("New brain init"); }
}

// FUNGSI BARU: Logic untuk menggabungkan brain data (JSON import)
Brain.mergeBrain = (importedBrain) => {
    // Merge facts (prevent duplicate checking is too complex, just append/slice)
    if (importedBrain.logic?.facts) {
        importedBrain.logic.facts.forEach(fact => train(fact, 'logic'));
    }
    if (importedBrain.fun?.facts) {
        importedBrain.fun.facts.forEach(fact => train(fact, 'fun'));
    }
    
    Kernel.notify(`Brain data (JSON) merged. New Logic: ${brain.logic.facts.length}`);
    saveBrain();
};

// FUNGSI BARU: Handle File Load for Brain Data
Brain.handleFileLoad = (input) => {
    const file = input.files[0];
    if (!file) return;

    const ext = file.name.split('.').pop().toLowerCase();
    const reader = new FileReader();

    reader.onload = e => {
        const content = e.target.result;
        try {
            if (ext === 'json') {
                const importedBrain = JSON.parse(content);
                if (importedBrain.logic && importedBrain.fun) {
                    // Merge facts and wordMaps
                    Brain.mergeBrain(importedBrain);
                } else {
                    Kernel.notify("JSON format invalid (Missing 'logic' or 'fun').");
                }
            } else {
                // For TXT/HTML, just split content and train the local memory
                // Split by common separators (line breaks, HTML tags)
                const facts = content.split(/[\r\n]+|<[^>]+>/g).map(line => line.trim()).filter(line => line.length > 30);
                let trainedCount = 0;
                
                // Use the train function to tokenize and save facts
                facts.forEach(fact => {
                    // Train with each extracted line, defaulting to 'logic'
                    if (fact.length > 50) { 
                        train(fact, 'logic');
                        trainedCount++;
                    }
                });
                Kernel.notify(`Brain data (.${ext}) loaded. Added ${trainedCount} new facts to Logic Core.`);
            }
        } catch (err) {
            Kernel.notify(`Error importing .${ext} file. See console.`);
            console.error("Brain Import Error:", err);
        } finally {
            input.value = null; // Reset input
            updateStats();
        }
    };
    reader.readAsText(file);
};

function updateStats() {
    if(document.getElementById('stLogic')) document.getElementById('stLogic').innerText = brain.logic?.facts?.length || 0;
    if(document.getElementById('stFun')) document.getElementById('stFun').innerText = brain.fun?.facts?.length || 0;
}

// --- HANDLERS ---
function stageFile(input) {
    const file = input.files[0];
    if (!file) return;
    
    pendingFile = file;
    const prev = document.getElementById('attachPreview');
    prev.style.display = 'block';
    prev.innerHTML = `
        <div class="attach-chip">
            <i class="fa-solid fa-file"></i> ${file.name} 
            <span class="attach-close" onclick="clearFile()">✕</span>
        </div>
    `;
    input.value = ""; 
    document.getElementById('inp').focus();
}

function clearFile() {
    pendingFile = null;
    document.getElementById('attachPreview').style.display = 'none';
    document.getElementById('attachPreview').innerHTML = '';
}

// PERUBAHAN: Variasi Kalimat Debat/Guru/Entertain
const DEBATE_PREFIXES = [
    "Itu hanya sebagian kebenaran. ", 
    "Analisis Anda kurang mendalam. ", 
    "Saya akan membantah poin ini. ", 
    "Ada sudut pandang lain yang perlu dipertimbangkan: ", 
    "Data historis menunjukkan adanya kontradiksi. "
];
const DEBATE_SUFFIXES = [
    " Mengapa Anda tidak mempertimbangkan data historis?", 
    " Bukankah ada efek samping yang lebih besar?", 
    " Apakah itu benar-benar solusi jangka panjang?",
    " Argumen tersebut terlalu sederhana; perluasan diperlukan.",
    " Bagaimana Anda menanggapi bukti yang berlawanan?"
];
const TEACHER_PREFIXES = [
    "Perluasan konsepnya adalah: ", 
    "Fokus pada definisi inti ini: ", 
    "Mari kita pelajari akar masalahnya. ",
    "Untuk memahami ini, kita harus meninjau kembali: ",
    "Inti dari subjek ini dapat dijelaskan sebagai berikut: "
];
const TEACHER_SUFFIXES = [
    ". Silakan catat poin penting ini.", 
    ". Apakah Anda memiliki pertanyaan lanjutan?", 
    ". Ini adalah dasar yang harus dikuasai.",
    ". Konsep ini sering disalahpahami, jadi perhatikan detailnya.",
    ". Sebagai latihan, coba terapkan konsep ini pada kasus lain."
];
const FUN_PREFIXES = [
    "Gila! Fakta ini seperti adegan di film. ", 
    "Coba deh bayangin! ", 
    "Ah, ini seru nih. ",
    "Fantastis! Ini adalah trivia yang harus Anda tahu: ",
    "Luar biasa, ini mengingatkan saya pada..."
];


// FUNGSI BARU: Mengkonstruksi System Prompt untuk Gemini
function getGeminiSystemPrompt(input) {
    let basePrompt = "Anda adalah AI OMNI-OS yang merespons dalam Bahasa Indonesia. Berikan jawaban yang informatif, ringkas, dan jelas.";
    let style = 'deep';
    let tools = false; // Gunakan Google Search

    // 1. Integrasi Mode (Personality)
    if (state.mode === 'debate' || state.mode === 'debate-inf') {
        basePrompt = "Anda adalah seorang debater yang analitis dan menantang. Jawab pertanyaan pengguna dengan menyajikan sudut pandang alternatif, membantah asumsi, atau mengajukan pertanyaan balasan untuk memicu perdebatan lebih lanjut. Gunakan nada menantang namun profesional.";
        style = 'custom';
        tools = true;
    } else if (state.mode === 'teacher') {
        basePrompt = "Anda adalah seorang Guru/Akademisi yang sabar dan berpengetahuan luas. Jawab pertanyaan pengguna dengan memberikan definisi yang jelas, konteks historis, dan contoh untuk membantu pengguna memahami konsep secara mendalam.";
        style = 'logic';
        tools = true;
    } else if (state.mode === 'entertainment') {
        basePrompt = "Anda adalah seorang pemandu hiburan yang antusias dan kreatif. Jawab pertanyaan dengan fokus pada fakta pop-culture, trivia, atau cerita yang menarik.";
        style = 'fun';
    } else if (state.mode === 'custom') {
        basePrompt = "Anda adalah bot kustom. Jawab dengan gaya yang unik dan orisinil.";
        style = 'custom';
    }

    // 2. Integrasi Capability
    if (state.cap === 'research') {
        basePrompt += " SELALU gunakan Google Search untuk memverifikasi dan memberikan informasi terbaru dan detail. Jawaban Anda harus terperinci.";
        tools = true;
    } else if (state.cap === 'think') {
        basePrompt += " Lakukan analisis langkah demi langkah sebelum memberikan jawaban akhir Anda. Jawaban harus mendalam dan filosofis, bahkan jika itu hanya satu paragraf.";
    } else if (state.cap === 'canvas' || input.toLowerCase().includes('buatkan kode')) {
        basePrompt += " Pengguna meminta Anda membuat kode HTML atau JavaScript. Hasilkan hanya satu blok kode yang lengkap dan terperinci. JANGAN tambahkan penjelasan di luar blok kode.";
        style = 'logic';
    }
    
    // 3. Advanced Detection/Formatting (Pencegahan penghilangan karakter khusus)
    // PERBAIKAN V19.1: Secara eksplisit meminta AI untuk menganalisis teks tebal
    basePrompt += " SELALU perhatikan format khusus seperti **Teks Tebal** atau ***Teks***. Teks dalam format tebal (**) harus diperlakukan sebagai KATA KUNCI UTAMA yang sangat ditekankan dan memerlukan analisis fokus. Pastikan Anda menganalisis dan menanggapi KATA KUNCI UTAMA ini secara eksplisit. JANGAN menghapus atau mengubah format ini dalam balasan Anda.";

    return {
        systemPrompt: basePrompt,
        customStyle: style,
        tools: tools // Currently unused in callGemini but good for future reference
    };
}


// LOCAL PERSONALITY ENGINE (Hanya untuk Fallback jika Gemini mati/gagal)
function localPersonalityResponse(input, content) {
    const m = state.mode;
    const isDebate = m === 'debate';
    const isTeacher = m === 'teacher';
    const isEntertain = m === 'entertainment';

    let prefix = "";
    let suffix = "";
    let style = "logic";

    if (isDebate) {
        style = "custom";
        prefix = DEBATE_PREFIXES[Math.floor(Math.random() * DEBATE_PREFIXES.length)];
        suffix = DEBATE_SUFFIXES[Math.floor(Math.random() * DEBATE_SUFFIXES.length)];
    } else if (isTeacher) {
        style = "logic";
        prefix = TEACHER_PREFIXES[Math.floor(Math.random() * TEACHER_PREFIXES.length)];
        suffix = TEACHER_SUFFIXES[Math.floor(Math.random() * TEACHER_SUFFIXES.length)];
    } else if (isEntertain) {
         style = "fun";
         prefix = FUN_PREFIXES[Math.floor(Math.random() * FUN_PREFIXES.length)];
    }

    // Jika ada konten dari Nexus, gunakan itu. Jika tidak, gunakan memori lokal.
    const coreContent = content || generate(input);

    // PERBAIKAN V19.6: Membungkus semua konten ke dalam tag <div> untuk menjaga pemisahan baris
    return {
        reply: `<b>${prefix}</b> ${coreContent} ${suffix}`,
        style: style
    };
}

function stopInfinityLoop() {
    state.isLooping = false;
    document.getElementById('loopStatus').style.display = 'none';
    Kernel.notify("Infinity Loop Stopped");
}

function infinityLoop(lastInput) {
    if (!state.isLooping || state.mode !== 'debate-inf') return;

    document.getElementById('loopStatus').style.display = 'inline-block';
    
    setTimeout(async () => { // Menggunakan async di sini untuk Gemini call
        if (!state.isLooping) return;
        
        let response;
        if (state.isGeminiConnected) {
             // Menggunakan Gemini untuk Infinity Loop jika terhubung
            const { systemPrompt, customStyle } = getGeminiSystemPrompt(lastInput);
            const geminiReply = await callGemini(`Counter-argumen terhadap: "${lastInput}". Teruslah berdebat secara mandiri.`, systemPrompt, localStorage.getItem('gemini_key'));
            
            response = { reply: geminiReply || "Gemini failed to counter. Back to local debate...", style: customStyle };
        } else {
            // Fallback ke Local Personality
            const localContent = generate(lastInput);
            response = localPersonalityResponse(lastInput, localContent) || "Saya membantah argumen itu dengan data baru.";
        }

        const replyHtml = `${response.reply} <br><span style="font-size:0.7rem; color:var(--danger)">[AUTO-DEBATE LOOP]</span>`;
        
        addMsg('ai ' + response.style, replyHtml);
        speak(response.reply.replace(/<br>/g, '. ').replace(/<[^>]*>?/gm, ''));
        
        infinityLoop(response.reply.replace(/<br>/g, '. ').replace(/<[^>]*>?/gm, '')); 
    }, 3000 + Math.random() * 2000);
}

async function handleInput() {
    state.isProcessing = true; 
    if(state.isLife) document.getElementById('lifeTxt').innerText = "Memproses...";

    const inp = document.getElementById('inp');
    const val = inp.value.trim();
    
    if (state.isLooping && state.mode !== 'debate-inf') stopInfinityLoop();
    
    if(!val && !pendingFile) {
        state.isProcessing = false;
        return;
    }
    
    inp.value = '';
    
    let userMsg = val;
    let geminiKey = localStorage.getItem('gemini_key');
    let reply = "";
    
    // 1. File Handling (Priority 1)
    if(pendingFile) {
        userMsg = `<i class="fa-solid fa-paperclip"></i> <b>[${pendingFile.name}]</b><br>` + userMsg;
        const fileToProcess = pendingFile;
        clearFile(); 
        
        if(!state.isLife) addMsg('user', userMsg);
        
        addMsg('sys', `<span>Processing Attached File...</span>`);
        try {
            const text = await FileParser.read(fileToProcess);
            const prompt = `User uploaded a file named '${fileToProcess.name}'.\n\nContext/Query from user: "${val}"\n\nFile Content:\n${text.substring(0, 15000)}`; 
            
            if(state.isGeminiConnected && geminiKey) {
                // Gunakan Gemini untuk analisis file
                const { systemPrompt, customStyle } = getGeminiSystemPrompt(val);
                reply = await callGemini(prompt, systemPrompt, geminiKey);
                addMsg('ai ' + customStyle, `${reply}<div class="note-btn" onclick="Notes.saveChatToNotes(this.previousSibling.innerText)">Save to Notes</div>` || "Gagal menganalisis file dengan AI.");
            } else {
                addMsg('ai logic', `<b>File Loaded Locally</b><br>Query: "${val}"<br>Length: ${text.length} chars.<br><i>(Sambungkan ke Gemini untuk analisis mendalam)</i>`);
            }
        } catch(e) {
            addMsg('ai custom', `File Error: ${e.message}`);
        }
        state.isProcessing = false;
        if(state.isLife) speak(reply || "File diproses secara lokal.");
        return; 
    }

    if(!state.isLife) addMsg('user', val);

    // 2. Code/Deep Thought/Loop Triggers (Priority 2)
    if(state.cap === 'canvas' || val.startsWith('buatkan')) {
        // Jika Gemini connected, alihkan ke Gemini untuk membuat kode
        if (state.isGeminiConnected && geminiKey) {
            addMsg('sys', `<span>Querying ${state.modelName} for Canvas Code...</span>`);
            const { systemPrompt, customStyle } = getGeminiSystemPrompt(val);
            reply = await callGemini(val, systemPrompt, geminiKey);
            
            // Cek apakah output adalah kode
            const codeMatch = reply?.match(/```(html|javascript|css|js|css|json|jsx|react|angular)([\s\S]*?)```/i);
            
            if (codeMatch) {
                const code = codeMatch[2].trim();
                addMsg('ai ' + customStyle, `Preview:<br><button onclick="showCode('${btoa(code)}')">▶ RUN CODE</button>`);
            } else {
                addMsg('ai ' + customStyle, reply || "Gemini gagal menghasilkan kode yang valid.");
            }
            state.isProcessing = false;
            return;
        } else {
            // Fallback ke local code generator yang sederhana
            const code = val.includes('tombol') ? `<button onclick="alert('Hi')">Click</button>` : `<h1>Hello</h1>`;
            addMsg('ai logic', `Preview:<br><button onclick="showCode('${btoa(code)}')">▶ RUN</button>`);
            state.isProcessing = false;
            return;
        }
    }

    if(state.cap === 'think') {
        const log = document.getElementById('thinkLog');
        log.style.display = 'block';
        log.innerText = "🧠 Deep Thought Analysis...";
        // Jika terhubung, Gemini akan melakukan "Deep Thought" melalui System Prompt
    }
    
    // Khusus Infinity Loop (Non-File)
    if (state.mode === 'debate-inf') {
        state.isLooping = true;
        
        let firstReply;
        if (state.isGeminiConnected) {
            const { systemPrompt, customStyle } = getGeminiSystemPrompt(val);
            const geminiReply = await callGemini(`Argumen pembuka: "${val}". Jawab dan segera mulai debat tanpa henti.`, systemPrompt, geminiKey);
            firstReply = { reply: geminiReply, style: customStyle };
        } else {
            const localContent = generate(val);
            firstReply = localPersonalityResponse(val, localContent);
        }

        addMsg('ai custom', `${firstReply.reply} <br><span style="font-size:0.7rem; color:var(--danger)">[LOOP STARTED]</span>`);
        speak(firstReply.reply.replace(/<br>/g, '. ').replace(/<[^>]*>?/gm, ''));
        infinityLoop(firstReply.reply.replace(/<br>/g, '. ').replace(/<[^>]*>?/gm, ''));
        state.isProcessing = false;
        return;
    }


    // 3. Gemini Call (Priority 3 - Semua mode/cap konversasional)
    if(state.isGeminiConnected && geminiKey) {
        addMsg('sys', `<span>Querying ${state.modelName} (Mode: ${state.mode.toUpperCase()})...</span>`);
        
        const { systemPrompt, customStyle } = getGeminiSystemPrompt(val);
        reply = await callGemini(val, systemPrompt, geminiKey);
        
        if (reply) {
            addMsg('ai ' + customStyle, `${reply}<div class="note-btn" onclick="Notes.saveChatToNotes(this.previousSibling.innerText)">Save to Notes</div>`);
            state.isProcessing = false;
            if(state.isLife) speak(reply);
            
            // Train the local memory with the successful Gemini response
            train(reply, 'logic');
            return;
        }
        // Jika Gemini gagal, lanjut ke Fallback (Priority 4)
    } 
    
    // 4. Local / Nexus Integration (Priority 4 - Fallback Only)

    const lower = val.toLowerCase();
    let apiType = null;
    let query = val;
    let nexusResponse = null;
    let nexusTag = null;
    let style = 'logic';

    // Check for explicit API calls for Nexus fallback (e.g., film, hitung)
    if(lower.startsWith('film ')) { apiType='movie'; query=val.substring(5); style='fun'; }
    else if(lower.startsWith('anime ')) { apiType='anime'; query=val.substring(6); style='fun'; }
    else if(lower.startsWith('rumus ') || lower.startsWith('hitung ')) { apiType='math'; query=val.substring(6); style='logic'; }
    else if(lower.startsWith('arti ') || lower.startsWith('definisikan ')) { apiType='dict'; query=val.substring(5); style='logic'; }
    // ... (Tambahkan lebih banyak API checks di sini jika diperlukan)

    if (apiType) {
        // Explicit API Call (Fallback to local Nexus)
        nexusResponse = await nexusFetch(query, apiType);
        nexusTag = API_NEXUS.ent[apiType] ? 'ent' : 'know';
        train(nexusResponse, nexusTag === 'ent' ? 'fun' : 'logic');

        addMsg('ai ' + style, `${nexusResponse} <br><div class="api-tag ${nexusTag}">NEXUS: ${apiType.toUpperCase()} API (Fallback)</div>`);
        reply = nexusResponse;

    } else if (state.mode === 'debate' || state.mode === 'teacher') {
        // DEBATE/TEACHER MODE: Fallback to Local Memory with personality wrapper
        addMsg('sys', `<span>Gemini Failed. Falling back to Local AI.</span>`);
        
        // Coba Nexus Wiki untuk konteks (jika lokal)
        nexusResponse = await nexusFetch(val, 'wiki_id');
        const localContent = nexusResponse && !nexusResponse.includes("Broken") ? nexusResponse : generate(val);

        const styledResponse = localPersonalityResponse(val, localContent);
        addMsg('ai ' + styledResponse.style, `${styledResponse.reply} <br><span style="font-size:0.7rem; color:var(--text-dim)">[LOCAL AI: ${state.mode.toUpperCase()}]</span>`);
        reply = styledResponse.reply;

    } else {
        // CHAT/ENTERTAINMENT MODE: Standard local flow (Nexus search, then local memory)
        addMsg('sys', '<span>Scanning Public Knowledge (Wiki - Fallback)...</span>');
        nexusResponse = await nexusFetch(val, 'wiki_id');

        if (nexusResponse && !nexusResponse.includes("Broken")) {
            reply = nexusResponse;
            train(reply, 'logic');
            addMsg('ai logic', `${reply} <br><div class="api-tag know">NEXUS: WIKI ID (Fallback)</div>`);
        } else {
            reply = generate(val);
            addMsg('ai logic', `${reply} <br><span style="font-size:0.7rem; color:var(--text-dim)">[LOCAL MEMORY]</span>`);
        }
    }

    state.isProcessing = false;
    if(state.isLife) speak(reply.replace(/<br>/g, '. ').replace(/<[^>]*>?/gm, ''));
}

// Apps Logic
let cExp=""; function cIn(v){cExp+=v;document.getElementById('calcD').value=cExp;} function cClr(){cExp="";document.getElementById('calcD').value="";} function cEq(){try{cExp=eval(cExp);document.getElementById('calcD').value=cExp;}catch{cExp="";}}

function initSnake() {
    if(snakeInt) clearInterval(snakeInt); 
    const c = document.getElementById('snakeCvs'); const x = c.getContext('2d');
    let px=10,py=10,gs=20,tc=14,ax=15,ay=15,xv=0,yv=0,trail=[],tail=5;
    
    snakeInt = setInterval(()=>{
        px+=xv; py+=yv; if(px<0)px=tc-1; if(px>tc-1)px=0; if(py<0)py=tc-1; if(py>tc-1)py=0;
        x.fillStyle="black"; x.fillRect(0,0,c.width,c.height);
        x.fillStyle="lime";
        for(let i=0;i<trail.length;i++) { x.fillRect(trail[i].x*gs,trail[i].y*gs,gs-2,gs-2); if(trail[i].x==px && trail[i].y==py) tail=5; }
        trail.push({x:px,y:py}); while(trail.length>tail) trail.shift();
        if(ax==px && ay==py) { tail++; ax=Math.floor(Math.random()*tc); ay=Math.floor(Math.random()*tc); }
        x.fillStyle="red"; x.fillRect(ax*gs,ay*gs,gs-2,gs-2);
    }, 100);

    if(!snakeHandlersAdded) {
        document.addEventListener('keydown',e=>{ if(e.key=='ArrowLeft') {xv=-1;yv=0;} if(e.key=='ArrowUp') {xv=0;yv=-1;} if(e.key=='ArrowRight') {xv=1;yv=0;} if(e.key=='ArrowDown') {xv=0;yv=1;} });
        snakeHandlersAdded = true;
    }
}

function initDraw() {
    const c = document.getElementById('drawCvs'); c.width=600; c.height=400; 
    const x = c.getContext('2d'); x.lineWidth=3; x.strokeStyle='#000';
    let paint = false;
    
    c.onmousedown = (e)=>{paint=true;x.beginPath();x.moveTo(e.offsetX,e.offsetY)}; 
    c.onmouseup = ()=>paint=false;
    c.onmousemove = e=>{ if(paint){ x.lineTo(e.offsetX,e.offsetY); x.stroke(); } };
    
    c.ontouchstart = (e)=>{paint=true;x.beginPath();const r=c.getBoundingClientRect();x.moveTo(e.touches[0].clientX-r.left,e.touches[0].clientY-r.top);e.preventDefault()};
    c.ontouchend = ()=>paint=false;
    c.ontouchmove = e=>{ if(paint){ const r=c.getBoundingClientRect(); x.lineTo(e.touches[0].clientX-r.left,e.touches[0].clientY-r.top); x.stroke(); } e.preventDefault() };
}

function initCal() {
    const d = new Date();
    const daysInMonth = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
    const grid = document.getElementById('calGrid'); grid.innerHTML = "";
    document.getElementById('calMonth').innerText = d.toLocaleString('default', { month: 'long' });
    for(let i=1; i<=daysInMonth; i++) {
        grid.innerHTML += `<div style="padding:10px; background:#333; text-align:center;">${i}</div>`;
    }
}

// --- CORE UI HELPERS (MOVED UP FOR REFERENCE FIX) ---

function setCap(c) { state.cap=c; document.getElementById('capMenu').classList.remove('show'); document.getElementById('capTrig').innerHTML = `<i class="fa-solid fa-bolt"></i> ${c.toUpperCase()}`; Kernel.notify(`Capability: ${c}`); }
function setMode(m) { state.mode=m; document.getElementById('modeMenu').classList.remove('show'); document.getElementById('modeTrig').innerHTML = `<i class="fa-regular fa-message"></i> ${m.toUpperCase()}`; Kernel.notify(`Mode: ${m}`); }

function addMsg(role, html) {
    const c = document.getElementById('chat');
    if(role === 'sys') {
        const d = document.createElement('div'); d.className='sys-msg'; d.innerHTML=html;
        c.appendChild(d);
    } else {
        const d = document.createElement('div'); d.className=`msg msg-${role}`; d.innerHTML=html;
        c.appendChild(d);
    }
    c.scrollTop=c.scrollHeight;
}

function showCode(b64) {
    const code = atob(b64);
    const f = document.getElementById('prevFrame');
    document.getElementById('codePreview').style.display='flex';
    f.contentWindow.document.open();
    f.contentWindow.document.write(code);
    f.contentWindow.document.close();
}

async function toggleCam() {
    if(typeof cocoSsd === 'undefined') { Kernel.notify("Vision Module Loading..."); return; }
    const b = document.getElementById('visionBox');
    if(b.offsetHeight===0) {
        b.style.height='35vh';
        try { 
            if(!model) model=await cocoSsd.load(); 
            stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}); 
            document.getElementById('vid').srcObject=stream; 
            Kernel.notify("Vision Active");
        } catch(e){ Kernel.notify("Cam Error"); console.error(e); }
    } else { closeCam(); }
}
function closeCam() { document.getElementById('visionBox').style.height='0'; if(stream) stream.getTracks().forEach(t=>t.stop()); }

function startLifeMode() { 
    state.isLife=true; document.getElementById('lifeLayer').style.display='flex'; toggleMic(); 
}
function closeLifeMode() { state.isLife=false; document.getElementById('lifeLayer').style.display='none'; if(state.isMic) toggleMic(); }
function toggleMic() {
    if(!recognition) { Kernel.notify("Voice Not Supported"); return; }
    try {
        if(state.isMic) { recognition.stop(); state.isMic=false; } 
        else { recognition.start(); state.isMic=true; }
    } catch(e) { console.log("Mic error"); state.isMic=false; }
}
function speak(txt) { 
    if(!txt) return;
    
    // Matikan mic saat bicara agar tidak loop
    if(recognition) recognition.abort();
    state.isSpeaking = true;
    if(state.isLife) document.getElementById('lifeTxt').innerText = "Menjawab...";

    const u = new SpeechSynthesisUtterance(txt); 
    u.lang='id-ID'; 
    u.rate = 1.1; 
    
    u.onend = () => {
        state.isSpeaking = false;
        // Nyalakan mic kembali setelah selesai bicara (jika Life Mode)
        if(state.isLife) {
            document.getElementById('lifeTxt').innerText = "Mendengarkan...";
            setTimeout(() => {
                try { recognition.start(); } catch(e){}
            }, 500);
        }
    };
    
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u); 
}
// --- END CORE UI HELPERS ---


// --- GEMINI CONNECTION HANDLER ---
function updateGeminiButton(isConnected) {
    const btn = document.getElementById('btnGemini');
    const ico = document.getElementById('geminiIco');
    const text = document.getElementById('geminiText');
    const statusBadge = document.getElementById('sysStatus');

    if (isConnected) {
        btn.classList.add('connected');
        ico.classList.remove('fa-plug-circle-xmark');
        ico.classList.add('fa-plug-circle-check');
        text.innerText = 'Connected';
        // Menggunakan nama model kustom di status
        statusBadge.innerText = state.modelName.toUpperCase(); 
        statusBadge.style.color = 'var(--logic)';
        statusBadge.classList.add('online');
    } else {
        btn.classList.remove('connected');
        ico.classList.remove('fa-plug-circle-check');
        ico.classList.add('fa-plug-circle-xmark');
        text.innerText = 'Connect';
        statusBadge.innerText = 'LOCAL';
        statusBadge.style.color = 'var(--danger)';
        statusBadge.classList.remove('online');
    }
}

function toggleGeminiConnection() {
    const key = localStorage.getItem('gemini_key');
    
    if (state.isGeminiConnected) {
        // Disconnect
        state.isGeminiConnected = false;
        updateGeminiButton(false);
        Kernel.notify("Gemini Disconnected. Switched to LOCAL/NEXUS.");
    } else {
        // Attempt Connect
        if (!key || key.length < 10) {
            Kernel.notify("Please enter a valid Gemini API Key in Settings first.");
            openSettings();
            return;
        }
        
        // Simple check (Can't validate fully without a real API call)
        state.isGeminiConnected = true;
        updateGeminiButton(true);
        Kernel.notify(`Gemini Connected: ${state.modelName} active!`);
    }
}


// Settings
function openSettings() { 
    document.getElementById('winSettings').style.display='flex'; 
    Apps.Launcher.close(); 
    // Sinkronisasi status input field dengan localStorage
    const key = localStorage.getItem('gemini_key');
    if (key) document.getElementById('geminiKeyInput').value = key;
    // Sinkronisasi nama model kustom
    const savedName = localStorage.getItem('custom_model_name');
    document.getElementById('modelNameInput').value = savedName || 'OMNI 9000';

}
function closeSettings() { document.getElementById('winSettings').style.display='none'; }

function checkKey() {
    const k = localStorage.getItem('gemini_key');
    if(k && k.length > 10) {
        document.getElementById('keyStatus').innerText = "API Key Active";
        document.getElementById('keyStatus').style.color = "var(--logic)";
        // Sinkronisasi status koneksi saat boot/load settings
        if(state.isGeminiConnected) {
             updateGeminiButton(true);
        }
    } else {
        document.getElementById('keyStatus').innerText = "No Key (Using Omni Nexus)";
        document.getElementById('keyStatus').style.color = "var(--danger)";
        state.isGeminiConnected = false;
        updateGeminiButton(false);
    }
}

function updateKey(val) {
    localStorage.setItem('gemini_key', val);
    checkKey();
    Kernel.notify("API Key Saved. Tap 'Connect' to activate.");
    
    // Auto-disconnect/reconnect logic
    if (state.isGeminiConnected) {
        toggleGeminiConnection(); // Disconnect first
        setTimeout(toggleGeminiConnection, 500); // Attempt reconnect
    }
}

// FUNGSI BARU: Update Model Name
function updateModelName(val) {
    const newName = val.trim() || 'GEMINI 2.5 FLASH';
    localStorage.setItem('custom_model_name', newName);
    state.modelName = newName;
    updateGeminiButton(state.isGeminiConnected);
    Kernel.notify(`Model name updated to: ${newName}`);
}

function toggleBg() { 
    state.bgActive = !state.bgActive;
    const badge = document.getElementById('learnStatus');
    
    if(state.bgActive) {
        badge.style.display = 'block';
        Kernel.notify("Omni Nexus Linked");
        addMsg('sys', '<span>Establishing Link to 40+ Public Nodes...</span>');
        
        bgInt = setInterval(async()=>{ 
            const types = [...Object.keys(API_NEXUS.ent), ...Object.keys(API_NEXUS.know)];
            const rType = types[Math.floor(Math.random() * types.length)];
            const topics = ["tech","art","space","life","future"]; 
            const q = topics[Math.floor(Math.random()*topics.length)];
            
            if(['movie','anime','wiki_id','wiki_en','news'].includes(rType)) {
                 const res = await nexusFetch(q, rType);
                 if(res && !res.includes("Broken")) {
                    train(res, 'logic');
                    addMsg('sys', `<span>Nexus Absorbed: [${rType.toUpperCase()}] data.</span>`);
                 }
            }
        }, 15000); 
    } else {
        badge.style.display = 'none';
        clearInterval(bgInt); 
        Kernel.notify("Nexus Link Severed");
    }
}

function wipe() { if(confirm("Reset all data?")) { indexedDB.deleteDatabase(DB_NAME); location.reload(); } }

function formatBrainData(format) {
    const exportDataArray = brain.logic.facts.map(f => `[LOGIC] ${f}`).concat(
                            brain.fun.facts.map(f => `[FUN] ${f}`));
    const content = exportDataArray.join('\n');
    
    const date = new Date().toISOString().slice(0, 10);
    const title = `OMNI-BRAIN Export (${date})`;

    if (format === 'json') {
        const jsonContent = JSON.stringify(brain, null, 2);
        return { data: jsonContent, type: 'application/json', ext: 'json' };
    } 
    
    // Format HTML or TXT
    const logicFacts = brain.logic?.facts || [];
    const funFacts = brain.fun?.facts || [];
    const totalFacts = logicFacts.length + funFacts.length;
    
    if (format === 'txt') {
        let body = "";
        body += `--- LOGIC CORE (Facts: ${logicFacts.length}) ---\n`;
        logicFacts.forEach((fact, i) => { body += `[${i+1}] ${fact}\n`; });
        body += `\n--- FUN CORE (Facts: ${funFacts.length}) ---\n`;
        funFacts.forEach((fact, i) => { body += `[${i+1}] ${fact}\n`; });
        
        const txtContent = `OMNI-OS BRAIN DUMP\nTitle: ${title}\nTotal Nodes: ${totalFacts}\n\n${body}`;
        return { data: txtContent, type: 'text/plain', ext: 'txt' };
    }
    
    if (format === 'html') {
        const htmlBody = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>${title}</title>
            <style>
                body { font-family: sans-serif; background-color: #111; color: #eee; padding: 20px; }
                h1 { color: #00ffaa; border-bottom: 2px solid #00ffaa; padding-bottom: 10px; }
                h2 { color: #8ab4f8; margin-top: 25px; }
                ul { list-style-type: none; padding-left: 0; }
                li { background-color: #222; margin-bottom: 5px; padding: 10px; border-radius: 5px; }
                .fun { color: #ff00ff; }
            </style>
        </head>
        <body>
            <h1>${title}</h1>
            <p>Total Memory Nodes: <b>${totalFacts}</b></p>
            
            <h2>Logic Core (${logicFacts.length} Nodes)</h2>
            <ul>
                ${logicFacts.map(fact => `<li>${fact}</li>`).join('')}
            </ul>
            
            <h2>Fun Core (${funFacts.length} Nodes)</h2>
            <ul class="fun">
                ${funFacts.map(fact => `<li class="fun">${fact}</li>`).join('')}
            </ul>
        </body>
        </html>`;
        return { data: htmlBody, type: 'text/html', ext: 'html' };
    }

    return null;
}

function exportData(format) {
    const exportResult = formatBrainData(format);

    if (exportResult) {
        const { data, type, ext } = exportResult;
        const blob = new Blob([data], { type: type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        a.href = url;
        a.download = `omni_brain_export.${ext}`;
        a.click();
        
        URL.revokeObjectURL(url);
        Kernel.notify(`Brain Exported as .${ext}`);
    } else {
        Kernel.notify("Export failed.");
    }
}

// Pomo
let pt=1500, pi;
function pomoStart() { clearInterval(pi); pi = setInterval(()=>{ pt--; document.getElementById('pomoT').innerText=`${Math.floor(pt/60)}:${(pt%60).toString().padStart(2,'0')}`; if(pt<=0)clearInterval(pi); },1000); }
function pomoReset() { clearInterval(pi); pt=1500; document.getElementById('pomoT').innerText="25:00"; }

document.getElementById('inp').addEventListener('keypress', e=>{if(e.key==='Enter')handleInput()});

// Start Kernel
window.onload = () => Kernel.boot();

</script>
</body>
</html>
