<!DOCTYPE html>
<html lang="id" data-theme="night">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI LKTI Pro - Asisten Penulis Akademik</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- CSS & Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest" defer></script>
    
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
    
    <!-- Math Rendering (KaTeX) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" defer></script>

    <!-- Pustaka Ekspor -->
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js" defer></script>
    <!-- Pustaka PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Times New Roman', 'Times', 'serif'],
                    },
                    colors: { 'primary': 'var(--color-primary)', 'primary-hover': 'var(--color-primary-hover)', 'background': 'var(--color-background)', 'surface': 'var(--color-surface)', 'text-primary': 'var(--color-text-primary)', 'text-secondary': 'var(--color-text-secondary)', 'border-color': 'var(--color-border-color)', 'input-bg': 'var(--color-input-bg)' },
                    keyframes: { fadeIn: { '0%': { opacity: 0, transform: 'translateY(10px)' }, '100%': { opacity: 1, transform: 'translateY(0)' } }, scaleIn: { '0%': { opacity: 0, transform: 'scale(0.95)' }, '100%': { opacity: 1, transform: 'scale(1)' } } },
                    animation: { 'fade-in': 'fadeIn 0.7s ease-out forwards', 'scale-in': 'scaleIn 0.3s ease-out forwards' }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        [data-theme="day"] { --color-primary: #0d9488; --color-primary-hover: #0f766e; --color-background: #f0f9ff; --color-surface: #ffffff; --color-text-primary: #111827; --color-text-secondary: #4b5563; --color-border-color: #d1d5db; --color-input-bg: #ffffff; }
        [data-theme="night"] { --color-primary: #2dd4bf; --color-primary-hover: #5eead4; --color-background: #0f172a; --color-surface: #1e293b; --color-text-primary: #f8fafc; --color-text-secondary: #94a3b8; --color-border-color: #334155; --color-input-bg: #334155; }
        [data-theme="planet"] { --color-primary: #818cf8; --color-primary-hover: #a5b4fc; --color-background: #1e1b4b; --color-surface: #312e81; --color-text-primary: #e0e7ff; --color-text-secondary: #a5b4fc; --color-border-color: #4338ca; --color-input-bg: #4f46e5; }
        [data-theme="ai"] { --color-primary: #34d399; --color-primary-hover: #6ee7b7; --color-background: #000000; --color-surface: #171717; --color-text-primary: #f5f5f5; --color-text-secondary: #a3a3a3; --color-border-color: #404040; --color-input-bg: #262626; }
        body { @apply bg-background text-text-primary transition-colors duration-300; }
        .btn { @apply min-h-[44px] flex items-center justify-center; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background-color: var(--color-surface); } ::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: 10px; } ::-webkit-scrollbar-thumb:hover { background-color: var(--color-primary-hover); }
        .title-input { @apply w-full font-semibold bg-transparent focus:outline-none focus:ring-1 focus:ring-primary rounded-sm px-1 -mx-1; }
        .generate-btn:disabled { @apply bg-gray-200 text-gray-400 border-gray-300 cursor-not-allowed; }
        [data-theme="night"] .generate-btn:disabled, [data-theme="planet"] .generate-btn:disabled, [data-theme="ai"] .generate-btn:disabled { @apply bg-gray-700 text-gray-500 border-gray-600; }
        #floating-toolbar { transition: opacity 0.2s, top 0.1s; }
        
        /* Styling untuk Rich Text Editor */
        #full-text-editor.prose { @apply leading-relaxed text-justify; } /* Added line-height and justify */
        #full-text-editor.prose h1, #full-text-editor.prose h2, #full-text-editor.prose h3 { @apply text-text-primary mt-6 mb-4; }
        #full-text-editor.prose p, #full-text-editor.prose li, #full-text-editor.prose blockquote { @apply text-text-secondary mb-4; }
        #full-text-editor.prose strong { @apply text-text-primary font-bold; }
        #full-text-editor.prose ul { @apply list-disc list-outside ml-5; }
        #full-text-editor.prose ol { @apply list-decimal list-outside ml-5; }
        #full-text-editor.prose a { @apply text-primary hover:underline; }
        #full-text-editor:focus { @apply outline-none ring-2 ring-primary; }
        #full-text-editor img { @apply max-w-full h-auto rounded-md my-4 mx-auto shadow-lg; }
        
        /* KaTeX Corrections */
        .katex { font-size: 1.1em; }
        
        .editor-toolbar { position: sticky; top: 1rem; z-index: 10; }
        
        /* Styling untuk Book View */
        .book-view-active { @apply bg-gray-300; }
        [data-theme="night"] .book-view-active, [data-theme="planet"] .book-view-active, [data-theme="ai"] .book-view-active { @apply bg-gray-800; }
        
        .book-view-active .editor-toolbar, .book-view-active #ai-assistant-panel { @apply hidden; }
        .book-view-active #editor-grid { @apply grid-cols-1; }
        .book-view-active #full-text-editor-container { @apply p-4 sm:p-8; }
        .book-view-active #full-text-editor { 
            @apply w-full mx-auto p-8 bg-white text-black shadow-2xl font-serif text-[12pt] leading-loose;
            aspect-ratio: 210 / 297;
        }
        @media (min-width: 768px) {
            .book-view-active #full-text-editor {
                @apply max-w-[210mm] min-h-[297mm] p-16;
            }
        }
        .book-view-active #full-text-editor.prose h1 { @apply text-2xl font-bold text-center !text-black; }
        .book-view-active #full-text-editor.prose h2 { @apply text-xl font-bold !text-black; }
        .book-view-active #full-text-editor.prose h3 { @apply text-lg font-bold !text-black; }
        .book-view-active #full-text-editor.prose p, .book-view-active #full-text-editor.prose li, 
        .book-view-active #full-text-editor.prose strong, .book-view-active #full-text-editor.prose blockquote {
            @apply !text-black;
        }
        .book-view-active #full-text-editor a { @apply text-blue-700 underline; }
        
        .editor-toolbar select, .editor-toolbar input[type=color] { @apply bg-transparent border-none focus:ring-0 text-text-secondary; }
        .editor-toolbar input[type=color] { @apply w-6 h-6 p-0; }
    </style>
</head>
<body class="font-sans antialiased">

    <main class="grid min-h-screen grid-cols-1 gap-4 p-4 lg:grid-cols-2 lg:gap-8 lg:p-8">
        <!-- PANEL KIRI: INPUT -->
        <div class="flex flex-col h-full p-6 space-y-4 rounded-xl bg-surface shadow-2xl opacity-0 animate-fade-in ring-1 ring-border-color/20">
            <header class="flex items-center justify-between">
                <div class="flex items-center space-x-3"><i data-lucide="brain-circuit" class="w-8 h-8 text-primary"></i><div><h1 class="text-xl font-bold text-text-primary">AI LKTI Pro</h1><p class="text-sm text-text-secondary">Asisten Penulis Akademik</p></div></div>
                <div class="flex items-center space-x-2">
                    <button id="settings-btn" class="p-2 rounded-full hover:bg-border-color/50 transition-colors" title="Pengaturan"><i data-lucide="settings-2" class="w-5 h-5 text-text-secondary"></i></button>
                </div>
            </header>
            <hr class="border-border-color/50">
            <form id="generator-form" class="flex-grow space-y-4 overflow-y-auto pr-2">
                <div><label class="block text-sm font-medium text-text-secondary mb-2">Mode Penulisan</label><div class="flex space-x-4"><label class="flex items-center space-x-2"><input type="radio" name="mode" value="otomatis" class="form-radio text-primary focus:ring-primary" checked><span class="text-text-primary">Otomatis (Langsung Jadi)</span></label><label class="flex items-center space-x-2"><input type="radio" name="mode" value="manual" class="form-radio text-primary focus:ring-primary"><span class="text-text-primary">Manual (Per Bab)</span></label></div></div>
                <div>
                    <label for="jenis-dokumen" class="block text-sm font-medium text-text-secondary mb-2">Jenis Dokumen</label>
                    <select id="jenis-dokumen" class="w-full p-2 rounded-md bg-input-bg border border-border-color focus:ring-2 focus:ring-primary focus:outline-none">
                        <optgroup label="Akademik & Penelitian">
                            <option>Skripsi</option>
                            <option>Tesis</option>
                            <option>Disertasi</option>
                            <option>Jurnal Ilmiah</option>
                            <option>Proposal Penelitian</option>
                            <option>Laporan Penelitian</option>
                            <option>Studi Kasus</option>
                        </optgroup>
                        <optgroup label="Tugas Sekolah & Pelajar">
                            <option>Makalah</option>
                            <option>Esai</option>
                            <option>Laporan Praktikum</option>
                            <option>Presentasi</option>
                            <option>Ringkasan Buku</option>
                            <option>Resensi Film</option>
                            <option>Pidato</option>
                            <option>Artikel Populer</option>
                            <option>Karya Ilmiah Remaja</option>
                            <option>Surat Lamaran Kerja</option>
                            <option>Curriculum Vitae (CV)</option>
                        </optgroup>
                        <optgroup label="Hiburan & Kreatif">
                            <option>Cerita Pendek</option>
                            <option>Novel</option>
                            <option>Puisi</option>
                            <option>Naskah Film</option>
                        </optgroup>
                        <optgroup label="Lainnya">
                            <option value="Custom">Custom</option>
                        </optgroup>
                    </select>
                </div>
                <div id="custom-type-container" class="hidden"><label for="custom-type-input" class="block text-sm font-medium text-text-secondary mb-2">Nama Dokumen Custom</label><input type="text" id="custom-type-input" placeholder="Contoh: Laporan Proyek Akhir Semester" class="w-full p-2 rounded-md bg-input-bg border border-border-color focus:ring-2 focus:ring-primary focus:outline-none"></div>
                <div><label for="topik-utama" class="block text-sm font-medium text-text-secondary mb-2">Topik Utama</label><textarea id="topik-utama" rows="3" placeholder="Jelaskan topik Anda secara spesifik. Contoh: Analisis sentimen media sosial terhadap kebijakan publik X menggunakan metode Y..." class="w-full p-2 rounded-md bg-input-bg border border-border-color focus:ring-2 focus:ring-primary focus:outline-none resize-none"></textarea></div>
                <div id="struktur-dokumen-container" class="hidden">
                    <label class="block text-sm font-medium text-text-secondary mb-2">Struktur Dokumen (Mode Manual)</label>
                    <div id="struktur-checkboxes" class="grid grid-cols-2 md:grid-cols-3 gap-2 p-3 bg-background rounded-md border border-border-color/50">
                        <!-- Checkboxes will be dynamically injected here -->
                    </div>
                </div>
                <div><label for="gaya-sitasi" class="block text-sm font-medium text-text-secondary mb-2">Gaya Sitasi</label><select id="gaya-sitasi" class="w-full p-2 rounded-md bg-input-bg border border-border-color focus:ring-2 focus:ring-primary focus:outline-none"><option>APA 7th Edition</option><option>MLA 9th Edition</option><option>IEEE</option><option>Harvard</option><option>Chicago</option></select></div>
                
                 <div>
                    <label class="block text-sm font-medium text-text-secondary mb-2">Jenis Penelitian</label>
                    <div id="jenis-penelitian-container" class="grid grid-cols-2 gap-2 p-3 bg-background rounded-md border border-border-color/50">
                         <label class="flex items-center space-x-2"><input type="checkbox" name="jenis-penelitian" value="Kualitatif" class="form-checkbox rounded text-primary focus:ring-primary"><span class="text-sm">Kualitatif</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" name="jenis-penelitian" value="Kuantitatif" class="form-checkbox rounded text-primary focus:ring-primary"><span class="text-sm">Kuantitatif</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" name="jenis-penelitian" value="Campuran" class="form-checkbox rounded text-primary focus:ring-primary"><span class="text-sm">Campuran</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" name="jenis-penelitian" value="Literatur" class="form-checkbox rounded text-primary focus:ring-primary"><span class="text-sm">Studi Literatur</span></label>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="min-tahun" class="block text-sm font-medium text-text-secondary mb-2">Tahun Ref. (Min.)</label>
                        <input type="number" id="min-tahun" placeholder="2019" class="w-full p-2 rounded-md bg-input-bg border border-border-color focus:ring-2 focus:ring-primary focus:outline-none">
                    </div>
                    <div>
                        <label for="max-tahun" class="block text-sm font-medium text-text-secondary mb-2">Tahun Ref. (Maks.)</label>
                        <input type="number" id="max-tahun" placeholder="2025" class="w-full p-2 rounded-md bg-input-bg border border-border-color focus:ring-2 focus:ring-primary focus:outline-none">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-text-secondary mb-2">Opsi Tambahan</label>
                    <div class="flex flex-col space-y-2 p-3 bg-background rounded-md border border-border-color/50">
                        <!-- Fitur Baru: Referensi Khusus -->
                        <div class="space-y-2">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="use-custom-refs" class="form-checkbox" value="Custom Refs">
                                <span class="text-sm font-semibold text-primary">Gunakan Referensi Khusus (Jurnal/Buku/Link)</span>
                            </label>
                            <textarea id="custom-refs-input" class="hidden w-full p-2 text-sm rounded-md bg-input-bg border border-border-color focus:ring-2 focus:ring-primary focus:outline-none transition-all" rows="4" placeholder="Tempel daftar referensi Anda di sini (Judul, Penulis, Link, atau Abstrak). AI akan mencari kutipan dari sini."></textarea>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="sertakan-data" class="form-checkbox" value="Data/Tabel">
                                <span class="text-sm">Sertakan Referensi Data/Tabel</span>
                            </label>
                            <textarea id="referensi-data-input" class="hidden w-full p-2 text-sm rounded-md bg-input-bg border border-border-color focus:ring-2 focus:ring-primary focus:outline-none transition-all" rows="3" placeholder="Contoh: URL ke dataset, kutipan tabel dari sumber, atau deskripsi data mentah..."></textarea>
                        </div>
                         <div class="space-y-2">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="sertakan-foto" class="form-checkbox" value="Foto/Gambar">
                                <span class="text-sm">Sertakan Gambar (maks. 10)</span>
                            </label>
                            <div id="image-upload-container" class="hidden w-full space-y-2">
                                <input type="file" id="image-upload-input" multiple accept="image/*" class="w-full text-sm text-text-secondary file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20">
                                <button type="button" id="open-image-gen-modal-btn" class="btn w-full text-sm font-medium text-primary border border-primary hover:bg-primary/10 transition-colors rounded-lg flex items-center justify-center space-x-2">
                                    <i data-lucide="sparkles" class="w-4 h-4"></i>
                                    <span>Buat Gambar dengan AI</span>
                                </button>
                                <div id="image-preview-container" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2">
                                    <!-- Image previews will be injected here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            <div class="pt-4 border-t border-border-color/50"><button id="generate-btn" class="btn w-full font-bold text-white bg-primary hover:bg-primary-hover transition-colors rounded-lg flex items-center justify-center space-x-2"><i data-lucide="play" class="w-5 h-5"></i><span>Mulai Proses Dokumen</span></button></div>
        </div>

        <!-- PANEL KANAN: OUTPUT -->
        <div class="flex flex-col h-full p-6 space-y-4 rounded-xl bg-surface shadow-2xl opacity-0 animate-fade-in [animation-delay:150ms] ring-1 ring-border-color/20">
            <header class="flex sm:flex-row sm:items-center sm:justify-end gap-4">
                <div id="view-mode-controls" class="hidden mr-auto">
                     <button id="view-mode-btn" title="Ganti Tampilan" class="btn p-2 rounded-md bg-background hover:bg-border-color/50 transition-colors flex items-center gap-2 text-sm px-3">
                        <i data-lucide="book-open" class="w-4 h-4 text-text-secondary"></i><span class="text-text-secondary">Mode Baca</span>
                    </button>
                </div>
                <div id="final-actions" class="flex items-center space-x-2 hidden">
                    <button id="download-txt-btn" title="Unduh .txt" class="btn p-2 rounded-md bg-background hover:bg-border-color/50 transition-colors"><i data-lucide="file-text" class="w-5 h-5 text-text-secondary"></i></button>
                    <button id="download-docx-btn" title="Unduh .docx (Word)" class="btn p-2 rounded-md bg-background hover:bg-border-color/50 transition-colors"><i data-lucide="file-word" class="w-5 h-5 text-text-secondary"></i></button>
                    <button id="download-pdf-btn" title="Unduh .pdf" class="btn p-2 rounded-md bg-background hover:bg-border-color/50 transition-colors"><i data-lucide="file-type" class="w-5 h-5 text-text-secondary"></i></button>
                    <button id="download-csv-btn" title="Unduh .csv (Excel)" class="btn p-2 rounded-md bg-background hover:bg-border-color/50 transition-colors"><i data-lucide="file-spreadsheet" class="w-5 h-5 text-text-secondary"></i></button>
                    <button id="copy-btn" title="Salin Teks" class="btn p-2 rounded-md bg-background hover:bg-border-color/50 transition-colors"><i data-lucide="copy" class="w-5 h-5 text-text-secondary"></i></button>
                </div>
            </header>
            <div id="output-content" class="flex-grow w-full overflow-y-auto p-1 space-y-4">
                <!-- UI Dinamis Dirender di Sini -->
            </div>
        </div>
    </main>

    <!-- FLOATING AI TOOLBAR (Initially hidden) -->
    <div id="floating-toolbar" class="hidden absolute z-10 bg-surface rounded-lg shadow-lg p-1 flex items-center gap-1 border border-border-color/50 opacity-0">
        <button data-action="parafrase" title="Parafrase (Tulis Ulang)" class="toolbar-btn p-2 rounded-md hover:bg-background"><i data-lucide="repeat-2" class="w-4 h-4 text-text-secondary pointer-events-none"></i></button>
        <button data-action="perpanjang" title="Perpanjang Teks" class="toolbar-btn p-2 rounded-md hover:bg-background"><i data-lucide="arrow-right-left" class="w-4 h-4 text-text-secondary pointer-events-none"></i></button>
        <button data-action="rangkum" title="Rangkum Teks" class="toolbar-btn p-2 rounded-md hover:bg-background"><i data-lucide="unfold-horizontal" class="w-4 h-4 text-text-secondary pointer-events-none"></i></button>
        <button data-action="terjemahkan" title="Terjemahkan (Inggris)" class="toolbar-btn p-2 rounded-md hover:bg-background"><i data-lucide="languages" class="w-4 h-4 text-text-secondary pointer-events-none"></i></button>
        <select data-action="tone" title="Ubah Gaya Bahasa" class="toolbar-select text-sm p-1.5 rounded-md hover:bg-background bg-surface text-text-secondary">
            <option value="">Ubah Nada</option>
            <option value="akademis">Akademis</option>
            <option value="santai">Santai</option>
            <option value="profesional">Profesional</option>
            <option value="persuasif">Persuasif</option>
        </select>
    </div>

    <!-- MODAL PENGATURAN -->
    <div id="settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center transition-opacity duration-300"><div id="modal-overlay" class="absolute inset-0 bg-black/60"></div><div class="relative w-full max-w-md p-6 m-4 rounded-xl shadow-xl bg-surface animate-scale-in ring-1 ring-border-color/20"><div class="flex items-center justify-between pb-4 border-b border-border-color"><h3 class="text-lg font-semibold text-text-primary flex items-center gap-2"><i data-lucide="settings-2" class="w-5 h-5"></i>Pengaturan</h3><button id="close-modal-btn" class="p-1 rounded-full hover:bg-border-color/50"><i data-lucide="x" class="w-5 h-5 text-text-secondary"></i></button></div><div class="py-6 space-y-4">
        <div><label for="theme-switcher" class="block text-sm font-medium text-text-secondary mb-2">Tema Tampilan</label><select id="theme-switcher" class="w-full p-2 rounded-md bg-input-bg border border-border-color focus:ring-2 focus:ring-primary focus:outline-none"><option value="day">Day</option><option value="night" selected>Night</option><option value="planet">Planet</option><option value="ai">AI</option></select></div>
        
        <!-- PENGATURAN MODEL AI (BARU) -->
        <div>
            <label for="ai-model-select" class="block text-sm font-medium text-text-secondary mb-2">Model AI Teks (Generasi Dokumen)</label>
            <select id="ai-model-select" class="w-full p-2 rounded-md bg-input-bg border border-border-color focus:ring-2 focus:ring-primary focus:outline-none">
                <option value="gemini-2.5-flash-preview-09-2025" selected>Gemini 2.5 Flash (Tercepat & Terbaru)</option>
                <option value="gemini-1.5-pro">Gemini 1.5 Pro (Lebih Stabil)</option>
                <option value="gemini-3.0">Gemini 3.0</option>
            </select>
        </div>
        <div>
            <label for="img-model-select" class="block text-sm font-medium text-text-secondary mb-2">Model AI Gambar</label>
            <select id="img-model-select" class="w-full p-2 rounded-md bg-input-bg border border-border-color focus:ring-2 focus:ring-primary focus:outline-none">
                <option value="imagen-4.0-generate-001" selected>Imagen 4.0 (Kualitas Tinggi)</option>
                <option value="imagen-3.0-generate-002">Imagen 3.0</option>
            </select>
        </div>

        <div><label for="api-key-input" class="block text-sm font-medium text-text-secondary mb-2">Google Gemini API Key (Opsional)</label><input type="password" id="api-key-input" placeholder="Masukkan API Key pribadi Anda..." class="w-full p-2 rounded-md bg-input-bg border border-border-color focus:ring-2 focus:ring-primary focus:outline-none"><p class="text-xs text-text-secondary mt-2">Gunakan API Key pribadi untuk kinerja yang lebih cepat dan stabil.</p></div>
    </div><div class="flex justify-end pt-4 border-t border-border-color"><button id="save-settings-btn" class="btn px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primary-hover transition-colors rounded-lg">Simpan & Tutup</button></div></div></div>

    <!-- MODAL IMAGE GENERATION -->
    <div id="image-gen-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center transition-opacity duration-300"><div id="image-gen-overlay" class="absolute inset-0 bg-black/60"></div><div class="relative w-full max-w-lg p-6 m-4 rounded-xl shadow-xl bg-surface animate-scale-in ring-1 ring-border-color/20"><div class="flex items-center justify-between pb-4 border-b border-border-color"><h3 class="text-lg font-semibold text-text-primary flex items-center gap-2"><i data-lucide="sparkles" class="w-5 h-5"></i>Buat Gambar dengan AI</h3><button id="close-image-gen-modal-btn" class="p-1 rounded-full hover:bg-border-color/50"><i data-lucide="x" class="w-5 h-5 text-text-secondary"></i></button></div><div class="py-6 space-y-4"><textarea id="image-gen-prompt" class="w-full p-2 text-sm rounded-md bg-input-bg border border-border-color focus:ring-2 focus:ring-primary focus:outline-none" rows="3" placeholder="Deskripsikan gambar yang ingin Anda buat, contoh: 'diagram alur proses penelitian kuantitatif dengan gaya minimalis'"></textarea><div id="image-gen-result-container" class="w-full h-64 bg-background rounded-md flex items-center justify-center border border-border-color/50"><p class="text-text-secondary text-sm">Hasil gambar akan muncul di sini</p></div></div><div class="flex justify-end pt-4 border-t border-border-color gap-2"><button id="generate-image-btn" class="btn px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primary-hover transition-colors rounded-lg flex items-center gap-2"><i data-lucide="play" class="w-4 h-4"></i>Generate</button><button id="insert-generated-image-btn" class="btn px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 transition-colors rounded-lg flex items-center gap-2" disabled><i data-lucide="plus" class="w-4 h-4"></i>Tambahkan ke Galeri</button></div></div></div>
    
    <!-- MODAL INSERT IMAGE -->
    <div id="insert-image-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center transition-opacity duration-300"><div id="insert-image-overlay" class="absolute inset-0 bg-black/60"></div><div class="relative w-full max-w-3xl p-6 m-4 rounded-xl shadow-xl bg-surface animate-scale-in ring-1 ring-border-color/20">
        <div class="flex items-center justify-between pb-4 border-b border-border-color"><h3 class="text-lg font-semibold text-text-primary flex items-center gap-2"><i data-lucide="image-plus" class="w-5 h-5"></i>Sisipkan Gambar</h3><button id="close-insert-image-modal-btn" class="p-1 rounded-full hover:bg-border-color/50"><i data-lucide="x" class="w-5 h-5 text-text-secondary"></i></button></div>
        <div class="flex flex-col sm:flex-row gap-4 py-4">
            <button id="gallery-source-local" class="btn flex-1 bg-primary/10 text-primary font-semibold rounded-md">Galeri Perangkat & AI</button>
            <button id="gallery-source-online" class="btn flex-1 bg-background hover:bg-border-color/20 rounded-md">Cari Online</button>
        </div>
        <div id="image-gallery-local" class="py-6 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4 max-h-[50vh] overflow-y-auto"></div>
        <div id="image-gallery-online" class="hidden py-6 space-y-4">
            <form id="online-image-search-form" class="flex gap-2"><input id="online-image-search-input" type="search" class="w-full p-2 text-sm rounded-md bg-input-bg border border-border-color focus:ring-1 focus:ring-primary" placeholder="Cari gambar di internet..."><button type="submit" class="btn px-4 bg-primary text-white rounded-md"><i data-lucide="search" class="w-4 h-4"></i></button></form>
            <div id="online-image-results" class="grid grid-cols-3 sm:grid-cols-4 gap-4 max-h-[40vh] overflow-y-auto"></div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
        
        // Configure marked
        marked.setOptions({
            breaks: true, // Interpret newlines as <br>
            gfm: true
        });

        const apiKey = "AIzaSyAxqmKL3WpEkGNJBb5BOo0QNBf8BVgL9vk";
        // ----------------------------------------------------
        // KONFIGURASI AI (REAL, BUKAN SIMULASI)
        // ----------------------------------------------------
        let currentTextModel = "gemini-2.5-flash-preview-09-2025"; 
        let currentImageModel = "imagen-4.0-generate-001";
        // ----------------------------------------------------
        
        const generateBtn = document.getElementById('generate-btn');
        const outputContent = document.getElementById('output-content');
        const finalActions = document.getElementById('final-actions');
        const floatingToolbar = document.getElementById('floating-toolbar');
        const strukturContainer = document.getElementById('struktur-dokumen-container');
        const viewModeControls = document.getElementById('view-mode-controls');
        const jenisDokumenSelect = document.getElementById('jenis-dokumen');

        let processData = []; 
        let formInputs = {};
        let userApiKey = "";
        let currentStage = 'initial';
        let activeSelectionRange = null; 
        let storedImages = []; 

        const documentStructures = {
            'Default': ["Pendahuluan", "Pembahasan", "Kesimpulan"],
            'Skripsi': ["Halaman Judul", "Abstrak", "Daftar Isi", "Bab 1: Pendahuluan", "Bab 2: Tinjauan Pustaka", "Bab 3: Metodologi Penelitian", "Bab 4: Hasil & Pembahasan", "Bab 5: Kesimpulan & Saran", "Daftar Pustaka"],
            'Tesis': ["Abstrak", "Daftar Isi", "Bab 1: Pendahuluan", "Bab 2: Landasan Teori", "Bab 3: Metode Penelitian", "Bab 4: Analisis Data", "Bab 5: Kesimpulan", "Daftar Pustaka"],
            'Jurnal Ilmiah': ['Judul & Abstrak', 'Pendahuluan', 'Metode', 'Hasil & Pembahasan', 'Kesimpulan', 'Daftar Pustaka'],
            'Makalah': ['Kata Pengantar', 'Daftar Isi', 'Bab 1: Pendahuluan', 'Bab 2: Pembahasan', 'Bab 3: Penutup', 'Daftar Pustaka'],
            'Esai': ['Pendahuluan (Tesis)', 'Argumen Utama', 'Argumen Pendukung', 'Kesimpulan'],
            'Pidato': ['Pembukaan', 'Isi Pidato', 'Harapan & Penutup'],
            'Cerita Pendek': ['Perkenalan (Orientasi)', 'Konflik', 'Klimaks', 'Penyelesaian'],
            'Novel': ['Bab 1: Awal Mula', 'Bab 2: Perkembangan', 'Bab 3: Puncak Konflik', 'Bab 4: Resolusi', 'Epilog']
        };

        async function callTextAPI(prompt, images = [], useSearch = false) {
            const apiKeyToUse = userApiKey || apiKey; 
            
            // MENGGUNAKAN MODEL YANG DIPILIH SECARA DINAMIS
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${currentTextModel}:generateContent?key=${apiKeyToUse}`;
            
            const parts = [{ text: prompt }];
            images.forEach(imgData => parts.push({ inlineData: { mimeType: imgData.fileType, data: imgData.base64 } }));

            const payload = {
                contents: [{ parts }]
            };

            if (useSearch) {
                payload.tools = [{ "google_search": {} }];
            }

            try {
                const response = await fetch(API_URL, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload) 
                });
                if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error.message || `HTTP error! Status: ${response.status}`); }
                const data = await response.json();
                
                const text = data.candidates[0].content.parts[0].text;
                let citations = [];
                if (data.candidates[0].groundingMetadata && data.candidates[0].groundingMetadata.groundingAttributions) {
                    citations = data.candidates[0].groundingMetadata.groundingAttributions
                        .map(attr => ({ title: attr.web?.title, url: attr.web?.uri }))
                        .filter(c => c.url);
                }
                
                return { text, citations };
            } catch (error) { console.error("Error calling Text API:", error); throw error; }
        }

        async function callImageAPI(prompt) {
            const apiKeyToUse = userApiKey || apiKey;
            
             // MENGGUNAKAN MODEL YANG DIPILIH SECARA DINAMIS
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${currentImageModel}:predict?key=${apiKeyToUse}`;
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } })
                });
                if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error?.message || `HTTP error! Status: ${response.status}`); }
                const data = await response.json();
                if (data.predictions && data.predictions.length > 0) {
                    return `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
                }
                throw new Error("Gagal membuat gambar.");
            } catch (error) { console.error("Error calling Image API:", error); throw error; }
        }

        function renderUI() {
            outputContent.innerHTML = '';
            finalActions.classList.add('hidden');
            viewModeControls.classList.add('hidden');

            switch(currentStage) {
                case 'initial':
                    outputContent.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-center text-text-secondary p-4"><i data-lucide="workflow" class="w-16 h-16 mb-4"></i><h3 class="font-semibold text-text-primary">Panel Output Cerdas</h3><p class="text-sm max-w-xs mt-2">Model Aktif: <span class="font-mono text-primary text-xs">${currentTextModel}</span></p><p class="text-sm max-w-xs mt-1">Isi formulir di sebelah kiri, pilih mode, lalu klik "Mulai Proses Dokumen".</p></div>`;
                    break;
                case 'manual_mode_core':
                case 'manual_mode_ancillary':
                    const isCoreStage = currentStage === 'manual_mode_core';
                    const sectionsToRender = processData.filter(p => p.isCoreContent === isCoreStage);
                    const allCurrentStageGenerated = sectionsToRender.every(s => s.isGenerated);
                    const container = document.createElement('div');
                    container.className = 'space-y-4 p-4';
                    container.innerHTML = `<h3 class="font-semibold text-text-primary">Mode Manual: ${isCoreStage ? 'Bab Utama' : 'Bagian Pelengkap'}</h3>`;
                    sectionsToRender.forEach(section => {
                        const sectionEl = document.createElement('div');
                        sectionEl.className = 'p-4 rounded-lg bg-surface border border-border-color/50 space-y-3';
                        const infoIcon = !section.isCoreContent ? `<i data-lucide="info" class="w-3 h-3 text-text-secondary ml-1" title="Konten ini dibuat AI berdasarkan bab inti yang sudah ada."></i>` : '';
                    const customizeForm = section.isCoreContent ? `
                        <div id="customize-form-${section.id}" class="hidden space-y-3 mt-2 p-3 bg-background rounded-md border border-border-color/50">
                            <div class="grid grid-cols-3 gap-2">
                                <div><label class="text-xs font-medium text-text-secondary">Pecah Bab</label><input type="number" data-id="${section.id}" class="custom-parts-input w-full p-1.5 text-sm rounded-md bg-input-bg border border-border-color focus:ring-1 focus:ring-primary focus:outline-none" value="1" min="1" max="10"></div>
                                <div><label class="text-xs font-medium text-text-secondary">Target Kata</label><input type="number" data-id="${section.id}" class="custom-words-input w-full p-1.5 text-sm rounded-md bg-input-bg border border-border-color focus:ring-1 focus:ring-primary focus:outline-none" placeholder="1500"></div>
                                <div><label class="text-xs font-medium text-text-secondary">Target Hal.</label><input type="number" data-id="${section.id}" class="custom-pages-input w-full p-1.5 text-sm rounded-md bg-input-bg border border-border-color focus:ring-1 focus:ring-primary focus:outline-none" placeholder="5"></div>
                            </div>
                            <div><label class="text-xs font-medium text-text-secondary">Instruksi Khusus</label><textarea data-id="${section.id}" class="custom-focus-input w-full p-1.5 text-sm rounded-md bg-input-bg border border-border-color focus:ring-1 focus:ring-primary focus:outline-none" rows="3" placeholder="Contoh: Fokuskan pada teori X dan hindari pembahasan Y..."></textarea></div>
                        </div>` : '';
                    sectionEl.innerHTML = `
                        <div class="flex justify-between items-start gap-2">
                                <div class="flex items-center flex-grow"><input type="text" value="${section.title}" data-id="${section.id}" class="title-input text-text-primary">${infoIcon}</div>
                                <div class="flex items-center">
                                    ${section.isCoreContent ? `<button data-id="${section.id}" title="Instruksi Khusus" class="customize-btn btn p-2 rounded-md hover:bg-background"><i data-lucide="sliders-horizontal" class="w-4 h-4 text-text-secondary pointer-events-none"></i></button>` : ''}
                                    <button data-id="${section.id}" class="generate-btn btn px-3 py-1 text-sm font-medium border rounded-md flex items-center space-x-2 whitespace-nowrap ${section.isGenerated ? 'text-blue-600 border-blue-600 hover:bg-blue-600/10' : 'text-primary border-primary hover:bg-primary/10'}" ${section.isLocked ? 'disabled' : ''}><i data-lucide="${section.isGenerated ? 'refresh-cw' : 'sparkles'}" class="w-4 h-4"></i><span>${section.isGenerated ? 'Proses Ulang' : 'Proses'}</span></button>
                                </div>
                            </div>
                            ${customizeForm}
                            <div class="section-content-area text-text-secondary text-sm">${section.content}</div>`;
                        container.appendChild(sectionEl);
                    });
                    if (isCoreStage && allCurrentStageGenerated && processData.some(p => !p.isCoreContent)) {
                        container.innerHTML += `<div class="pt-4 border-t border-border-color/50"><button id="next-stage-btn" class="btn w-full font-bold text-white bg-green-600 hover:bg-green-700 transition-colors rounded-lg"><i data-lucide="arrow-right" class="w-5 h-5 mr-2"></i>Lanjut ke Bagian Pelengkap</button></div>`;
                    } else if (!isCoreStage && allCurrentStageGenerated && processData.length > 0) {
                         container.innerHTML += `<div class="pt-4 border-t border-border-color/50"><button id="combine-btn" class="btn w-full font-bold text-white bg-primary hover:bg-primary-hover transition-colors rounded-lg"><i data-lucide="file-check-2" class="w-5 h-5 mr-2"></i>Gabungkan & Selesai</button></div>`;
                    }
                    outputContent.appendChild(container);
                    break;
                case 'fulltext_generated':
                    outputContent.innerHTML = `<div id="editor-grid" class="h-full grid grid-cols-1 p-2">
                            <div id="full-text-editor-container" class="h-full flex flex-col space-y-2">
                                <div class="editor-toolbar flex items-center space-x-1 p-1 bg-surface rounded-md border border-border-color/50 flex-wrap">
                                    <button data-command="undo" title="Undo" class="format-btn p-2 rounded-md hover:bg-background"><i data-lucide="undo-2" class="w-4 h-4 text-text-secondary pointer-events-none"></i></button>
                                    <button data-command="redo" title="Redo" class="format-btn p-2 rounded-md hover:bg-background"><i data-lucide="redo-2" class="w-4 h-4 text-text-secondary pointer-events-none"></i></button>
                                    <div class="h-5 w-px bg-border-color/50 mx-1"></div>
                                    <select data-command="fontName" title="Jenis Font" class="format-select text-sm p-1.5 rounded-md hover:bg-background">
                                        <option value="Inter">Default</option><option value="Arial">Arial</option><option value="Georgia">Georgia</option><option value="Times New Roman">Times</option><option value="Verdana">Verdana</option>
                                    </select>
                                    <select data-command="fontSize" title="Ukuran Font" class="format-select text-sm p-1.5 rounded-md hover:bg-background">
                                        <option value="1">8pt</option><option value="2">10pt</option><option value="3" selected>12pt</option><option value="4">14pt</option><option value="5">18pt</option><option value="6">24pt</option>
                                    </select>
                                    <div class="h-5 w-px bg-border-color/50 mx-1"></div>
                                    <button data-command="bold" title="Bold" class="format-btn p-2 rounded-md hover:bg-background"><i data-lucide="bold" class="w-4 h-4 text-text-secondary pointer-events-none"></i></button>
                                    <button data-command="italic" title="Italic" class="format-btn p-2 rounded-md hover:bg-background"><i data-lucide="italic" class="w-4 h-4 text-text-secondary pointer-events-none"></i></button>
                                    <button data-command="underline" title="Underline" class="format-btn p-2 rounded-md hover:bg-background"><i data-lucide="underline" class="w-4 h-4 text-text-secondary pointer-events-none"></i></button>
                                    <div class="h-5 w-px bg-border-color/50 mx-1"></div>
                                    <button data-command="formatBlock" data-value="H1" title="Heading 1" class="format-btn p-2 rounded-md hover:bg-background"><i data-lucide="heading-1" class="w-4 h-4 text-text-secondary pointer-events-none"></i></button>
                                    <button data-command="formatBlock" data-value="H2" title="Heading 2" class="format-btn p-2 rounded-md hover:bg-background"><i data-lucide="heading-2" class="w-4 h-4 text-text-secondary pointer-events-none"></i></button>
                                    <button data-command="formatBlock" data-value="H3" title="Heading 3" class="format-btn p-2 rounded-md hover:bg-background"><i data-lucide="heading-3" class="w-4 h-4 text-text-secondary pointer-events-none"></i></button>
                                    <div class="h-5 w-px bg-border-color/50 mx-1"></div>
                                    <button data-command="insertUnorderedList" title="Bullet List" class="format-btn p-2 rounded-md hover:bg-background"><i data-lucide="list" class="w-4 h-4 text-text-secondary pointer-events-none"></i></button>
                                    <button data-command="insertOrderedList" title="Numbered List" class="format-btn p-2 rounded-md hover:bg-background"><i data-lucide="list-ordered" class="w-4 h-4 text-text-secondary pointer-events-none"></i></button>
                                    <button id="insert-image-btn" title="Sisipkan Gambar" class="p-2 rounded-md hover:bg-background"><i data-lucide="image-plus" class="w-4 h-4 text-text-secondary pointer-events-none"></i></button>
                                </div>
                                <div id="full-text-editor" contenteditable="true" class="w-full flex-grow resize-none rounded-md bg-input-bg p-4 prose max-w-none shadow-inner">${marked.parse(processData[0].content)}</div>
                                <div id="doc-stats" class="text-xs text-text-secondary text-right p-2 border-t border-border-color/50"></div>
                            </div>
                        </div>`;
                    finalActions.classList.remove('hidden');
                    viewModeControls.classList.remove('hidden');
                    
                    // RENDER MATH WITH KATEX
                    if (window.renderMathInElement) {
                        renderMathInElement(document.getElementById('full-text-editor'), {
                            delimiters: [
                                {left: '$$', right: '$$', display: true},
                                {left: '$', right: '$', display: false},
                                {left: '\\(', right: '\\)', display: false},
                                {left: '\\[', right: '\\]', display: true}
                            ],
                            throwOnError: false
                        });
                    }
                    
                    updateWordCount(); 
                    break;
                 case 'loading':
                    outputContent.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-center text-text-secondary p-4"><div class="relative"><i data-lucide="loader-2" class="w-16 h-16 mb-4 animate-spin text-primary"></i></div><h3 class="font-semibold text-text-primary">AI Sedang Berpikir...</h3><p class="text-sm max-w-xs mt-2 animate-pulse">Sedang menyusun argumen menggunakan model ${currentTextModel}.</p></div>`;
                    break;
            }
            lucide.createIcons();
        }
        
        document.querySelectorAll('input[name="mode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                strukturContainer.classList.toggle('hidden', e.target.value !== 'manual');
            });
        });

        generateBtn.addEventListener('click', async () => {
            const selectedMode = document.querySelector('input[name="mode"]:checked').value;
            let docType = document.getElementById('jenis-dokumen').value;
            if (docType === 'Custom') docType = document.getElementById('custom-type-input').value || 'Dokumen Custom';
            
            // CAPTURE CUSTOM REFS
            const useCustomRefs = document.getElementById('use-custom-refs').checked;
            const customRefsValue = document.getElementById('custom-refs-input').value;

            formInputs = { 
                topic: document.getElementById('topik-utama').value, 
                citationStyle: document.getElementById('gaya-sitasi').value, 
                docType: docType,
                minYear: document.getElementById('min-tahun').value,
                maxYear: document.getElementById('max-tahun').value,
                includeData: document.getElementById('sertakan-data').checked,
                dataRefs: document.getElementById('referensi-data-input').value,
                includePhoto: document.getElementById('sertakan-foto').checked,
                uploadedImages: storedImages,
                // ADD TO INPUTS OBJECT
                customRefs: useCustomRefs ? customRefsValue : null 
            };
            
            // KEYWORDS UNTUK MENDETEKSI BAB INT
            const coreContentKeywords = ['bab', 'pendahuluan', 'pembahasan', 'penutup', 'isi', 'argumen', 'metode', 'hasil'];
            let selectedSections;

            if (selectedMode === 'manual') {
                selectedSections = Array.from(document.querySelectorAll('.structure-checkbox:checked')).map(cb => cb.value);
            } else {
                selectedSections = documentStructures[docType] || documentStructures['Default'];
            }

            if (!formInputs.topic) { alert("Mohon isi kolom Topik Utama terlebih dahulu."); return; }
            if (selectedMode === 'manual' && selectedSections.length === 0) { alert("Pilih minimal satu bagian struktur untuk Mode Manual."); return; }


            processData = selectedSections.map((title) => ({
                id: title.replace(/[^a-zA-Z0-9]/g, '-'),
                title: title,
                content: 'Belum diproses...',
                isGenerated: false,
                isCoreContent: coreContentKeywords.some(keyword => title.toLowerCase().includes(keyword)),
                isLocked: false,
                customInstructions: null
            }));

            if (selectedMode === 'manual') {
                const firstCoreIndex = processData.findIndex(p => p.isCoreContent);
                processData.forEach((p, idx) => {
                    if (p.isCoreContent) p.isLocked = idx > firstCoreIndex;
                    else p.isLocked = true;
                });
            }

            generateBtn.disabled = true;
            generateBtn.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-5 h-5"></i><span>Memproses...</span>`;
            lucide.createIcons();

            if (selectedMode === 'otomatis') {
                currentStage = 'loading';
                renderUI();
                const sectionTitles = selectedSections.join(', ');
                
                // --- PROMPT ENGINEERING YANG DITINGKATKAN ---
                let prompt = buildPromptContext(formInputs);
                prompt += `\nINSTRUKSI UTAMA:
                Buatlah draf lengkap untuk dokumen berjenis '${formInputs.docType}'.
                Dokumen ini harus mencakup struktur berikut: ${sectionTitles}.
                
                Tulislah sebagai satu kesatuan teks yang mengalir (kohesif). Gunakan format Markdown untuk penjudulan (Heading).
                Pastikan argumennya logis, bahasanya akademis namun mudah dipahami, dan hindari pengulangan.`;
                
                try {
                    const { text: aiResponse } = await callTextAPI(prompt, formInputs.uploadedImages, true);
                    processData = [{ content: aiResponse }];
                    currentStage = 'fulltext_generated';
                } catch (error) { alert(`Maaf, terjadi kesalahan: ${error.message}`); currentStage = 'initial'; }
            } else { currentStage = 'manual_mode_core'; }
            
            renderUI();
            generateBtn.disabled = false;
            generateBtn.innerHTML = `<i data-lucide="play" class="w-5 h-5"></i><span>Mulai Proses Ulang</span>`;
            lucide.createIcons();
        });

        function buildPromptContext(inputs) {
            let context = `PERAN: Bertindaklah sebagai akademisi, peneliti, dan penulis profesional dalam Bahasa Indonesia.\n`;
            context += `TUGAS: Susun dokumen bertipe '${inputs.docType}' dengan topik spesifik: "${inputs.topic}".\n`;
            context += `GAYA PENULISAN: Formal, objektif, analitis, dan mengikuti kaidah PUEBI. Gunakan gaya sitasi ${inputs.citationStyle}.\n`;
            
            // CUSTOM REFS LOGIC
            if (inputs.customRefs) {
                context += `\nREFERENSI WAJIB (PRIORITAS TERTINGGI):
                Berikut adalah daftar referensi yang DITENTUKAN OLEH PENGGUNA. Anda WAJIB menggunakan sumber-sumber ini sebagai landasan utama sitasi dan kutipan.
                --- MULAI DAFTAR REFERENSI ---
                ${inputs.customRefs}
                --- SELESAI DAFTAR REFERENSI ---
                INSTRUKSI SITASI: Integrasikan referensi di atas ke dalam teks secara relevan (misal: 'Menurut [Nama], 20xx...'). Jika informasi kurang, baru boleh mencari sumber tambahan.\n`;
            } else {
                if (inputs.minYear && inputs.maxYear) context += `BATASAN REFERENSI: Gunakan referensi/sumber data terkini antara tahun ${inputs.minYear} hingga ${inputs.maxYear}.\n`;
            }
            
            if (inputs.includeData) {
                context += `- DATA: Sertakan analisis berbasis data/tabel. `;
                if(inputs.dataRefs) {
                    context += `Gunakan data berikut sebagai acuan utama: "${inputs.dataRefs}".\n`;
                } else {
                    context += `Jika data riil tidak tersedia, simulasikan data yang masuk akal dan relevan sebagai contoh ilustratif.\n`;
                }
            }
            if (inputs.includePhoto && inputs.uploadedImages.length > 0) {
                context += `- VISUAL: Pengguna mengunggah ${inputs.uploadedImages.length} gambar. Analisis gambar tersebut dan rujuk dalam teks (contoh: 'seperti terlihat pada Gambar 1').\n`;
            }
            return context;
        }

        function getCoreContentContext() {
            return processData.filter(p => p.isCoreContent && p.isGenerated).map(p => `## ${p.title}\n\n${p.content}`).join('\n\n');
        }

        outputContent.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            if (button.classList.contains('format-btn')) {
                const command = button.dataset.command;
                const value = button.dataset.value || null;
                document.execCommand(command, false, value);
                document.getElementById('full-text-editor')?.focus();
                return;
            }

            if (button.id === 'insert-image-btn') {
                const modal = document.getElementById('insert-image-modal');
                modal.classList.remove('hidden');
                openInsertImageModal();
                return;
            }

            if(button.classList.contains('customize-btn')) {
                const sectionId = button.dataset.id;
                const form = document.getElementById(`customize-form-${sectionId}`);
                form.classList.toggle('hidden');
                return;
            }

            if (button.classList.contains('generate-btn')) {
                const sectionId = button.dataset.id;
                const sectionIndex = processData.findIndex(p => p.id === sectionId);
                const section = processData[sectionIndex];
                
                const customPartsInput = document.querySelector(`.custom-parts-input[data-id="${sectionId}"]`);
                const customWordsInput = document.querySelector(`.custom-words-input[data-id="${sectionId}"]`);
                const customPagesInput = document.querySelector(`.custom-pages-input[data-id="${sectionId}"]`);
                const customFocusInput = document.querySelector(`.custom-focus-input[data-id="${sectionId}"]`);
                if(customPartsInput && customFocusInput) {
                    section.customInstructions = { 
                        parts: customPartsInput.value || 1, 
                        words: customWordsInput.value, 
                        pages: customPagesInput ? customPagesInput.value : null,
                        focus: customFocusInput.value 
                    };
                }

                button.disabled = true;
                button.innerHTML = `<i data-lucide="search" class="animate-pulse w-4 h-4"></i><span>Riset...</span>`;
                lucide.createIcons();

                const currentTitle = document.querySelector(`.title-input[data-id="${sectionId}"]`).value;
                const context = getCoreContentContext();
                let prompt = buildPromptContext(formInputs);

                if (section.isCoreContent) {
                    const previousContext = context; 
                    if(previousContext) prompt += `KONTEKS SEBELUMNYA:\n---\n${previousContext}\n---\n\n`;
                    prompt += `TUGAS BAGIAN INI: Tulis konten lengkap untuk bab/bagian berjudul: "${currentTitle}". `;
                    if(section.customInstructions) {
                        if(section.customInstructions.words) prompt += `Panjang tulisan ditargetkan sekitar ${section.customInstructions.words} kata. `;
                        if(section.customInstructions.pages) prompt += `Panjang tulisan ditargetkan sekitar ${section.customInstructions.pages} halaman A4 (asumsikan sekitar 300-400 kata per halaman). `;
                        if(section.customInstructions.focus) prompt += `Fokus pembahasan: ${section.customInstructions.focus}. `;
                    }
                    prompt += `Hindari basa-basi pembuka. Langsung masuk ke substansi pembahasan. Gunakan format Markdown.`;
                } else { 
                    prompt += `KONTEKS DOKUMEN:\n---\n${context}\n---\n\n`;
                    if (currentTitle.includes("Daftar Isi")) prompt += `Berdasarkan isi dokumen di atas, buatlah Daftar Isi yang rapi.`;
                    else if (currentTitle.includes("Daftar Pustaka")) prompt += `Buatkan Daftar Pustaka berdasarkan kutipan yang ada di teks dan tambahkan sumber relevan lainnya. Format sitasi: ${formInputs.citationStyle}. Sertakan URL jika memungkinkan.`;
                    else prompt += `Buatkan bagian "${currentTitle}" yang relevan dengan konteks dokumen di atas.`;
                }
                
                prompt += `\n\nPENTING: Gunakan bahasa Indonesia yang baku, akademik, dan orisinal (parafrase tingkat tinggi).`;

                try {
                    button.innerHTML = `<i data-lucide="pen-tool" class="animate-bounce w-4 h-4"></i><span>Menulis...</span>`;
                    lucide.createIcons();
                    
                    const { text: aiResponse } = await callTextAPI(prompt, formInputs.uploadedImages, true);
                    
                    section.content = aiResponse;
                    section.isGenerated = true;
                    if(section.isCoreContent) {
                        const nextCoreSection = processData.find((p, i) => i > sectionIndex && p.isCoreContent);
                        if(nextCoreSection) nextCoreSection.isLocked = false;
                    }
                    renderUI();
                } catch (error) { alert(`Gagal: ${error.message}`); renderUI(); }
            }
            if (button.id === 'next-stage-btn') {
                processData.forEach(p => { if (!p.isCoreContent) p.isLocked = false; });
                currentStage = 'manual_mode_ancillary';
                renderUI();
            }
            if (button.id === 'combine-btn') {
                processData = [{ content: processData.map(s => `## ${s.title}\n\n${s.content}`).join('\n\n') }];
                currentStage = 'fulltext_generated';
                renderUI();
            }
        });
        
        // Event listener untuk toggle input custom references
        document.getElementById('use-custom-refs').addEventListener('change', e => {
            document.getElementById('custom-refs-input').classList.toggle('hidden', !e.target.checked);
        });
        
        document.getElementById('sertakan-data').addEventListener('change', e => {
            document.getElementById('referensi-data-input').classList.toggle('hidden', !e.target.checked);
        });
        document.getElementById('sertakan-foto').addEventListener('change', e => {
            document.getElementById('image-upload-container').classList.toggle('hidden', !e.target.checked);
            if (!e.target.checked) {
                storedImages = [];
                document.getElementById('image-preview-container').innerHTML = '';
            }
        });
        
        // -----------------------------------------------------------------
        // PERBAIKAN: MENGEMBALIKAN FUNGSI & LISTENER YANG HILANG
        // -----------------------------------------------------------------

        // Listener untuk Update Struktur saat Jenis Dokumen Berubah
        jenisDokumenSelect.addEventListener('change', (e) => {
            document.getElementById('custom-type-container').classList.toggle('hidden', e.target.value !== 'Custom');
            updateStructureOptions(e.target.value);
        });

        // Fungsi Penting untuk Mengisi Checkbox Struktur Manual
        function updateStructureOptions(docType) {
            const container = document.getElementById('struktur-checkboxes');
            if (!container) return;
            const structures = documentStructures[docType] || documentStructures['Default'];
            container.innerHTML = '';
            structures.forEach(item => {
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2';
                label.innerHTML = `<input type="checkbox" class="structure-checkbox" value="${item}" checked><span class="text-sm">${item.split(':')[0]}</span>`;
                container.appendChild(label);
            });
        }
        // Panggil sekali saat awal load agar checkbox terisi
        updateStructureOptions(jenisDokumenSelect.value);

        // Listener untuk View Mode (Editor vs Baca)
        viewModeControls.addEventListener('click', (e) => {
            const button = e.target.closest('#view-mode-btn');
            if (!button) return;
            const outputPanel = document.getElementById('output-content');
            outputPanel.classList.toggle('book-view-active');
            
            const isBookView = outputPanel.classList.contains('book-view-active');
            const editor = document.getElementById('full-text-editor');
            if (editor) {
                editor.contentEditable = !isBookView;
            }

            if (isBookView) {
                button.innerHTML = `<i data-lucide="edit-3" class="w-4 h-4 text-text-secondary"></i><span class="text-text-secondary">Mode Editor</span>`;
            } else {
                button.innerHTML = `<i data-lucide="book-open" class="w-4 h-4 text-text-secondary"></i><span class="text-text-secondary">Mode Baca</span>`;
            }
            lucide.createIcons();
        });

        // Listener untuk Upload Gambar
        document.getElementById('image-upload-input').addEventListener('change', e => {
            const files = Array.from(e.target.files).slice(0, 10 - storedImages.length);
            const previewContainer = document.getElementById('image-preview-container');
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const base64String = event.target.result;
                    storedImages.push({ type: 'upload', src: base64String, fileType: file.type, base64: base64String.split(',')[1] });
                    const imgEl = document.createElement('img');
                    imgEl.src = base64String;
                    imgEl.className = 'w-16 h-16 object-cover rounded-md';
                    previewContainer.appendChild(imgEl);
                };
                reader.readAsDataURL(file);
            });
        });

        // Logika Modal Generate Image
        const imageGenModal = document.getElementById('image-gen-modal');
        const openImageGenBtn = document.getElementById('open-image-gen-modal-btn');
        const closeImageGenBtn = document.getElementById('close-image-gen-modal-btn');
        const imageGenOverlay = document.getElementById('image-gen-overlay');
        const generateImageBtn = document.getElementById('generate-image-btn');
        const insertGeneratedImageBtn = document.getElementById('insert-generated-image-btn');
        
        const toggleImageGenModal = () => imageGenModal.classList.toggle('hidden');
        openImageGenBtn.addEventListener('click', toggleImageGenModal);
        closeImageGenBtn.addEventListener('click', toggleImageGenModal);
        imageGenOverlay.addEventListener('click', toggleImageGenModal);

        generateImageBtn.addEventListener('click', async () => {
            const prompt = document.getElementById('image-gen-prompt').value;
            if (!prompt) return alert('Harap masukkan deskripsi gambar.');
            
            const resultContainer = document.getElementById('image-gen-result-container');
            resultContainer.innerHTML = `<i data-lucide="loader-2" class="w-10 h-10 text-primary animate-spin"></i>`;
            lucide.createIcons();
            insertGeneratedImageBtn.disabled = true;
            
            try {
                const imageUrl = await callImageAPI(prompt);
                resultContainer.innerHTML = `<img src="${imageUrl}" class="max-w-full max-h-full object-contain">`;
                insertGeneratedImageBtn.dataset.src = imageUrl;
                insertGeneratedImageBtn.disabled = false;
            } catch(error) {
                resultContainer.innerHTML = `<p class="text-red-500 text-sm">Gagal membuat gambar: ${error.message}</p>`;
            }
        });

        insertGeneratedImageBtn.addEventListener('click', () => {
            const imageUrl = insertGeneratedImageBtn.dataset.src;
            if (!imageUrl || storedImages.length >= 10) { if(storedImages.length >= 10) alert('Maksimal 10 gambar.'); return; }
            storedImages.push({ type: 'generated', src: imageUrl });
            const previewContainer = document.getElementById('image-preview-container');
            const imgEl = document.createElement('img');
            imgEl.src = imageUrl;
            imgEl.className = 'w-16 h-16 object-cover rounded-md';
            previewContainer.appendChild(imgEl);
            toggleImageGenModal();
        });
        
        // Logika Modal Insert Image
        const insertImageModal = document.getElementById('insert-image-modal');
        const closeInsertImageModalBtn = document.getElementById('close-insert-image-modal-btn');
        const insertImageOverlay = document.getElementById('insert-image-overlay');
        const gallerySourceLocal = document.getElementById('gallery-source-local');
        const gallerySourceOnline = document.getElementById('gallery-source-online');
        const imageGalleryLocal = document.getElementById('image-gallery-local');
        const imageGalleryOnline = document.getElementById('image-gallery-online');
        const onlineImageSearchForm = document.getElementById('online-image-search-form');
        
        function openInsertImageModal() {
            gallerySourceLocal.click(); 
            imageGalleryLocal.innerHTML = ''; 
            if(storedImages.length === 0) {
                imageGalleryLocal.innerHTML = `<p class="text-text-secondary col-span-full text-center">Tidak ada gambar. Unggah atau buat gambar dengan AI di panel kiri.</p>`;
            } else {
                storedImages.forEach(img => {
                    const imgEl = document.createElement('img');
                    imgEl.src = img.src;
                    imgEl.className = 'w-full h-24 object-cover rounded-md cursor-pointer hover:ring-2 ring-primary';
                    imgEl.onclick = () => {
                        const editor = document.getElementById('full-text-editor');
                        editor.focus();
                        document.execCommand('insertHTML', false, `<img src="${img.src}" alt="Gambar yang disisipkan" style="max-width: 80%; height: auto; margin: 1rem auto; display: block; border-radius: 0.5rem;" />`);
                        insertImageModal.classList.add('hidden');
                    };
                    imageGalleryLocal.appendChild(imgEl);
                });
            }
            insertImageModal.classList.remove('hidden');
        }
        
        gallerySourceLocal.addEventListener('click', () => {
            imageGalleryLocal.classList.remove('hidden');
            imageGalleryOnline.classList.add('hidden');
            gallerySourceLocal.classList.replace('bg-background', 'bg-primary/10');
            gallerySourceLocal.classList.add('text-primary', 'font-semibold');
            gallerySourceOnline.classList.replace('bg-primary/10', 'bg-background');
            gallerySourceOnline.classList.remove('text-primary', 'font-semibold');
        });
        gallerySourceOnline.addEventListener('click', () => {
            imageGalleryOnline.classList.remove('hidden');
            imageGalleryLocal.classList.add('hidden');
            gallerySourceOnline.classList.replace('bg-background', 'bg-primary/10');
            gallerySourceOnline.classList.add('text-primary', 'font-semibold');
            gallerySourceLocal.classList.replace('bg-primary/10', 'bg-background');
            gallerySourceLocal.classList.remove('text-primary', 'font-semibold');
        });

        onlineImageSearchForm.addEventListener('submit', async(e) => {
            e.preventDefault();
            const query = document.getElementById('online-image-search-input').value;
            if(!query) return;
            const resultsContainer = document.getElementById('online-image-results');
            resultsContainer.innerHTML = `<div class="col-span-full flex justify-center p-8"><i data-lucide="loader-2" class="w-8 h-8 text-primary animate-spin"></i></div>`;
            lucide.createIcons();
            
            try {
                resultsContainer.innerHTML = '';
                for(let i=0; i<12; i++){
                    const imgEl = document.createElement('img');
                    imgEl.src = `https://source.unsplash.com/random/300x200/?${query}&sig=${Math.random()}`;
                    imgEl.className = 'w-full h-24 object-cover rounded-md cursor-pointer hover:ring-2 ring-primary';
                    imgEl.onclick = () => {
                        const editor = document.getElementById('full-text-editor');
                        editor.focus();
                        document.execCommand('insertHTML', false, `<img src="${imgEl.src}" alt="${query}" style="max-width: 80%; height: auto; margin: 1rem auto; display: block; border-radius: 0.5rem;" />`);
                        insertImageModal.classList.add('hidden');
                    };
                    resultsContainer.appendChild(imgEl);
                }
            } catch(error) {
                 resultsContainer.innerHTML = `<p class="text-red-500 col-span-full text-center">Gagal mencari gambar.</p>`;
            }
        });
        
        const toggleInsertImageModal = () => insertImageModal.classList.toggle('hidden');
        closeInsertImageModalBtn.addEventListener('click', toggleInsertImageModal);
        insertImageOverlay.addEventListener('click', toggleInsertImageModal);
        
        function updateWordCount() {
            const editor = document.getElementById('full-text-editor');
            const stats = document.getElementById('doc-stats');
            if (editor && stats) {
                const text = editor.innerText || '';
                const wordCount = text.trim().split(/\s+/).filter(Boolean).length;
                const readingTime = Math.ceil(wordCount / 200);
                stats.textContent = `${wordCount} kata | Perkiraan ${readingTime} menit baca`;
            }
        }
        
        // Render UI Awal
        renderUI();
        
        // Panggil lagi untuk memastikan dropdown terisi di awal
        updateStructureOptions(jenisDokumenSelect.value);
    });
    </script>
</body>
</html>
